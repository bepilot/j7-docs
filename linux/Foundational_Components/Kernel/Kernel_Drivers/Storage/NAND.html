

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2.2.15. NAND &mdash; Processor SDK Linux for J721e Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="Processor SDK Linux for J721e Documentation" href="../../../../../index.html"/>
        <link rel="up" title="3.2.2. Kernel Drivers" href="../../../../Foundational_Components_Kernel_Drivers.html"/>
        <link rel="next" title="3.2.2.16. MMC/SD" href="MMC-SD.html"/>
        <link rel="prev" title="3.2.2.14. SPI" href="../SPI.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../../../../../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../devices/J7/linux/index.html" class="icon icon-home"> Processor SDK Linux for J721e
          

          
          </a>

          
            
            
              <div class="version">
                07_01_00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../Overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devices/J7/linux/Release_Specific.html">2. Release Specific</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../Foundational_Components.html">3. Foundational Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_U-Boot.html">3.1. U-Boot</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Users_Guide.html">3.2.1. Users Guide</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../ADC.html">3.2.2.1. ADC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Audio.html">3.2.2.2. Audio</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Crypto.html">3.2.2.3. Crypto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Display/DSS7.html">3.2.2.4. DSS (DSS6 &amp; DSS7)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GPIO.html">3.2.2.5. GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../HYPERFLASH.html">3.2.2.6. HyperBus and HyperFlash</a></li>
<li class="toctree-l4"><a class="reference internal" href="../I2C.html">3.2.2.7. I2C</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Network/CPSW2g.html">3.2.2.8. CPSW2g Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Network/CPSW9g_virt_mac.html">3.2.2.9. CPSW9g virtual MAC (remoteproc)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_End_Point.html">3.2.2.10. PCIe End Point</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_Backplane.html">3.2.2.11. PCIe Backplane</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_Root_Complex.html">3.2.2.12. PCIe Root Complex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../QSPI.html">3.2.2.13. OSPI/QSPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../SPI.html">3.2.2.14. SPI</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.2.2.15. NAND</a></li>
<li class="toctree-l4"><a class="reference internal" href="MMC-SD.html">3.2.2.16. MMC/SD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../UART.html">3.2.2.17. UART</a></li>
<li class="toctree-l4"><a class="reference internal" href="../USB/CDNS3.html">3.2.2.18. USB CDNS3</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_LTP-DDT_Validation.html">3.2.3. LTP-DDT Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_FAQs.html">3.2.4. FAQs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Filesystem.html">3.3. Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Tools.html">3.4. Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_IPCLLD.html">3.5. IPC Low Level Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Graphics.html">3.6. Graphics and Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Virtualization.html">3.7. Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Machine_Learning.html">3.8. Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_ATF.html">3.9. ARM Trusted Firmware-A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_OPTEE.html">3.10. OP-TEE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../How_to_Guides.html">4. How to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Documentation_Tarball.html">5. Documentation Tarball</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../devices/J7/linux/index.html">Processor SDK Linux for J721e</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../devices/J7/linux/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components.html">3. Foundational Components</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a> &raquo;</li>
      
    <li>3.2.2.15. NAND</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nand">
<h1>3.2.2.15. NAND<a class="headerlink" href="#nand" title="Permalink to this headline">¶</a></h1>
<p class="rubric" id="introduction-linux-core-nand"><strong>Introduction</strong></p>
<p class="rubric" id="ti-infrastructure-for-nand-flash-devices"><strong>TI infrastructure for NAND Flash devices</strong></p>
<p>TI’s SoC interface with NAND Flash devices via on-chip GPMC (General
Purpose Memory Controller) interface or via AEMIF depending on the SoC.</p>
<p>For devices that include GPMC: The ECC algorithms required by NAND
devices to protect their data, are managed by two independent hardware
engines:</p>
<ul class="simple">
<li>GPMC ECC engine: used for calculating ECC checksum while writing and
reading the NAND device.</li>
<li>ELM ECC engine: used for locating and decoding ECC errors while
reading the NAND device.</li>
</ul>
<div class="line-block">
<div class="line">Important NAND related drivers can be further split into the following
sub-components.</div>
<div class="line">For all devices:</div>
</div>
<ul class="simple">
<li>NAND subsystem: protocol driver in MTD sub-system for interfacing
with NAND flash devices.</li>
</ul>
<p>For K2L and K2E:</p>
<ul class="simple">
<li>AEMIF driver: controller driver for AEMIF engine</li>
</ul>
<p>For all other SoCs:</p>
<ul class="simple">
<li>GPMC driver: controller driver for GPMC engine</li>
<li>ELM driver (for applicable SoC)&nbsp;: controller driver for ELM engine.</li>
</ul>
<p class="rubric" id="supported-features-kernel-nand"><strong>Supported Features</strong></p>
<div class="line-block">
<div class="line">GPMC NAND driver supports:</div>
</div>
<ul class="simple">
<li>NAND devices having:<ul>
<li>bus-width = x8 | x16</li>
<li>page-size = 2048 | 4096</li>
<li>block-size = 128k | 256k</li>
</ul>
</li>
<li>1-bit Hamming, BCH4, BCH8 and BCH16 ECC schemes.</li>
<li>Various transfer modes for different use-cases and applications (like
Polled, Polled Prefetch, IRQ and DMA).</li>
<li>NAND boot support for custom non-ONFI compatible NAND devices using
NAND-I2C boot-mode (Refer Chapter on <em>Initialization</em> in processor’s
TRM).</li>
<li>Sub-page write</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric" id="accessing-nand-partitions">Accessing NAND partitions</p>
<p class="rubric" id="linux">Linux</p>
<p>Within the kernel NAND partitions are accessed via mtd devices. Instead
are referring to a partition by its name or its offset a user simply
needs to specify the NAND partition in question in the form of its mtd
device path. Usually in the format of /dev/mtdX where X is the mtd
device number.</p>
<p class="rubric" id="determine-nand-partition-mtd-identifier">Determine NAND Partition MTD Identifier</p>
<p>Within the kernel figuring out the mtd device number that is for a
particular NAND partition is simple. A user simply needs to view the
list of mtd devices along with its name. Below command will provide this
information:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>cat /proc/mtd
</pre></div>
</div>
<p>An example of this output performed on the DRA71x EVM can be seen below.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>dev:    size   erasesize  name
mtd0: 00010000 00010000 &quot;QSPI.SPL&quot;
mtd1: 00010000 00010000 &quot;QSPI.SPL.backup1&quot;
mtd2: 00010000 00010000 &quot;QSPI.SPL.backup2&quot;
mtd3: 00010000 00010000 &quot;QSPI.SPL.backup3&quot;
mtd4: 00100000 00010000 &quot;QSPI.u-boot&quot;
mtd5: 00080000 00010000 &quot;QSPI.u-boot-spl-os&quot;
mtd6: 00010000 00010000 &quot;QSPI.u-boot-env&quot;
mtd7: 00010000 00010000 &quot;QSPI.u-boot-env.backup1&quot;
mtd8: 00800000 00010000 &quot;QSPI.kernel&quot;
mtd9: 01620000 00010000 &quot;QSPI.file-system&quot;
mtd10: 00020000 00020000 &quot;NAND.SPL&quot;
mtd11: 00020000 00020000 &quot;NAND.SPL.backup1&quot;
mtd12: 00020000 00020000 &quot;NAND.SPL.backup2&quot;
mtd13: 00020000 00020000 &quot;NAND.SPL.backup3&quot;
mtd14: 00040000 00020000 &quot;NAND.u-boot-spl-os&quot;
mtd15: 00100000 00020000 &quot;NAND.u-boot&quot;
mtd16: 00020000 00020000 &quot;NAND.u-boot-env&quot;
mtd17: 00020000 00020000 &quot;NAND.u-boot-env.backup1&quot;
mtd18: 00800000 00020000 &quot;NAND.kernel&quot;
mtd19: 0f600000 00020000 &quot;NAND.file-system&quot;
</pre></div>
</div>
<p>As you can see above the list of mtd devices may not only include NAND
partitions but list other peripherals that create mtd devices also. From
the above you can see that if the user wants to access the file-system
partition within the NAND then they use /dev/mtd19 to reference the
partition. The names of these partitions, their sizes (in hex) and
offsets (in hex) are determined within the specific board’s device tree
file.</p>
<p class="rubric" id="erasing-reading-and-writing">Erasing, Reading and Writing</p>
<p>For the below sections it is important to remember to replaced <strong>mtdX</strong>
with the mtd device that is associated with the particular NAND
partition as described in the above section.</p>
<div class="line-block">
<div class="line"><strong>Erasing</strong></div>
<div class="line">Erasing a NAND partition can be performed by using the below command:</div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>flash_erase /dev/mtdX 0 0
</pre></div>
</div>
<div class="line-block">
<div class="line"><strong>Writing</strong></div>
<div class="line">Writing a NAND partition is usually a two step process. Writing to
NAND at a bit level is only able to change a bit from 1 to 0. This is
problematic since frequently when writing new data you will need to
change many bits from 1 to 0 along with changing some bits from 0 to
1. The only way to get around this is erasing the NAND partition
before writing. This is because erasing sets all the bits in a
partition to 1. Thus when performing raw NAND writes insure you
erasing the partition first otherwise you will experience numerous
NAND ECC errors during the write or read operation.</div>
</div>
<p>The command to write to a NAND partition is below:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>nandwrite -p /dev/mtdX &lt;filename&gt;
</pre></div>
</div>
<div class="line-block">
<div class="line">The symbol <strong>&lt;filename&gt;</strong> should be replaced with the file path to the
file you will like to write.</div>
<div class="line"><strong>Reading</strong></div>
<div class="line">Reading NAND can be done by running the below command:</div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>nanddump /dev/mtdX -f &lt;filename&gt;
</pre></div>
</div>
<p>The symbol <strong>&lt;filename&gt;</strong> should be replaced with the name of a file you
want to be created that contains with contents of the NAND partition.
Note that the above command by default with save to a file the complete
contents of the NAND partition. If your interested in only a certain
amount of data being dumped additional parameters can be passed to the
utility.</p>
<p class="rubric" id="command-line-partitioning">Command Line Partitioning</p>
<p>In some situations, partitions defined in device-tree may not be
sufficient or correct. Note that once partitions are defined in
device-tree and present in a mainline kernel release, they cannot be
changed because this breaks users who have existing data on NAND flash
and upgrade to new kernel and device-tree. If you are not affected by
this issue, you may choose to override partition information passed from
device-tree using command line.</p>
<p>In TI kernel releases, MTD command line partitioning support is built as
module. To use it, add something like following to the kernel command
line (passed using <code class="docutils literal"><span class="pre">bootargs</span></code> U-Boot variable)</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>setenv bootargs ${bootargs} cmdlinepart.mtdparts=davinci-nand.0:1m(image)ro,-(free-space)
</pre></div>
</div>
<p>Note that MTD command line parses breaks if there is space in partition
name. So use “free-space” not “free space”. Change <code class="docutils literal"><span class="pre">davinci-nand.0</span></code> to
the correct device name. You can usually find the name to use from
<code class="docutils literal"><span class="pre">dmesg</span></code>output</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Creating 2 MTD partitions on &quot;davinci-nand.0&quot;:
</pre></div>
</div>
<p>You can also setup new partitions after kernel has booted with old
partitions. You will need to re-probe the NAND driver if it has already
probed. Something like:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ modprobe -r davinci_nand
$ modprobe cmdlinepart mtdparts=&quot;davinci-nand.0:2m(image)ro,-(free space)&quot;
$ modprobe davinci_nand
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">davinci_nand</span></code> module name here may have to be changed based on the
SoC you are using.</p>
<p class="rubric" id="u-boot">U-boot</p>
<div class="line-block">
<div class="line">Information regarding NAND booting and booting the kernel and file
system from NAND can be found in the U-boot User Guide NAND
section.</div>
</div>
<p class="rubric" id="nand-based-file-system"><strong>NAND Based File system</strong></p>
<p class="rubric" id="required-software">Required Software</p>
<p>Building a UBI file system depends on two applications. Ubinize and
mkfs.ubifs which are both provided by Ubuntu’s mtd-utils package
(apt-get install mtd-utils). The below instructions are based on version
1.5.0 of mtd-utils although newer version are likely to work.</p>
<p class="rubric" id="building-ubi-file-system">Building UBI File system</p>
<p>When building a UBI file system you need to have a directory that
contains the exact files and directories layout that you plan to use for
your file system. This is similar to the files and directories layout
you will use to copy a file system onto a SD card for booting purposes.
It is important that your file system size is smaller than the file
system partition in the NAND.</p>
<div class="line-block">
<div class="line">Next you need a file named ubinize.cfg. Below contains the exact
contents of ubinize.cfg you should use. However, replace <strong>&lt;name&gt;</strong>
with a name of your choosing</div>
<div class="line">ubinize.cfg contents:</div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>[ubifs]
 mode=ubi
 image=&lt;name&gt;.ubifs
 vol_id=0
 vol_type=dynamic
 vol_name=rootfs
 vol_flags=autoresize
</pre></div>
</div>
<div class="line-block">
<div class="line">To build a ubi files system only requires the below two commands. The
symbol below <strong>&lt;directory path&gt;</strong> should be replaced with the path to
your directory that you want to convert into a ubifs. The symbol
&lt;name&gt; should be replaced with the same value you used in creating
ubinize.cfg. Make sure you use the same value of &lt;name&gt; across the two
commands and ubinize.cfg. The symbols <strong>&lt;MKUBIFS ARGS&gt;</strong> and
<strong>&lt;UBINIZE ARGS&gt;</strong> are board specific. Replace these values with the
values seen in the below table based on the TI EVM you are using.</div>
<div class="line">Commands to execute:</div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>mkfs.ubifs -r &lt;directory path&gt; -o &lt;name&gt;.ubifs &lt;MKUBIFS ARGS&gt;
ubinize -o &lt;name&gt;.ubi &lt;UBINIZE ARGS&gt; ubinize.cfg
</pre></div>
</div>
<p>Once these commands are executed &lt;name&gt;.ubi can then be programmed into
the NAND’s designated file-system partition.</p>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="37%" />
<col width="43%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Board Name</th>
<th class="head">MKUBIFS Args</th>
<th class="head">UBINIZE Args</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335X GP EVM</td>
<td>-F -m 2048 -e 126976 -c 5600</td>
<td>-m 2048 -p 128KiB -s 512 -O 2048</td>
</tr>
<tr class="row-odd"><td>AM437x GP EVM</td>
<td>-F -m 4096 -e 253952 -c 2650</td>
<td>-m 4096 -p 256KiB -s 4096 -O 4096</td>
</tr>
<tr class="row-even"><td>K2E EVM</td>
<td>-F -m 2048 -e 126976 -c 3856</td>
<td>-m 2048 -p 128KiB -s 2048 -O 2048</td>
</tr>
<tr class="row-odd"><td>K2L EVM</td>
<td>-F -m 4096 -e 253952 -c 1926</td>
<td>-m 4096 -p 256KiB -s 4096 -O 4096</td>
</tr>
<tr class="row-even"><td>K2G EVM</td>
<td>-F -m 4096 -e 253952 -c 1926</td>
<td>-m 4096 -p 256KiB -s 4096 -O 4096</td>
</tr>
<tr class="row-odd"><td>DRA71x EVM</td>
<td>-F -m 2048 -e 126976 -c 8192</td>
<td>-m 2048 -p 128KiB -s 512 -O 2048</td>
</tr>
</tbody>
</table>
<p>Table:  Table of Parameters to use for Building UBI filesystem image</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric" id="board-specific-configurations"><strong>Board specific configurations</strong></p>
<div class="line-block">
<div class="line">Following table gives details about NAND&nbsp;devices present on various
EVM&nbsp;boards</div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">EVM</th>
<th class="head">NAND
Part #</th>
<th class="head">Size</th>
<th class="head">Bus-Widt
h</th>
<th class="head">Block-Si
ze
(KB)</th>
<th class="head">Page-Siz
e
(KB)</th>
<th class="head">OOB-Size
(bytes)</th>
<th class="head">ECC
Scheme</th>
<th class="head">Hardware</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x
GP</td>
<td>MT29F2G0
8AB</td>
<td>256 MB</td>
<td>8</td>
<td>128</td>
<td>2</td>
<td>64</td>
<td>BCH 8</td>
<td>GPMC</td>
</tr>
<tr class="row-odd"><td>AM437x
GP</td>
<td>MT29F4G0
8AB</td>
<td>512 MB</td>
<td>8</td>
<td>256</td>
<td>4</td>
<td>224</td>
<td>BCH 16</td>
<td>GPMC</td>
</tr>
<tr class="row-even"><td>AM437x
EPOS</td>
<td>MT29F4G0
8AB</td>
<td>512 MB</td>
<td>8</td>
<td>256</td>
<td>4</td>
<td>224</td>
<td>BCH 16</td>
<td>GPMC</td>
</tr>
<tr class="row-odd"><td>DRA71x</td>
<td>MT29F2G1
6AADWP:D</td>
<td>256 MB</td>
<td>16</td>
<td>128</td>
<td>2</td>
<td>64</td>
<td>BCH 8</td>
<td>GPMC</td>
</tr>
<tr class="row-even"><td>K2G</td>
<td>MT29F2G1
6ABAFAWP
:F</td>
<td>512 MB</td>
<td>16</td>
<td>128</td>
<td>2</td>
<td>64</td>
<td>BCH 16</td>
<td>GPMC</td>
</tr>
<tr class="row-odd"><td>K2E</td>
<td>MT29F4G0
8ABBDAH4
D</td>
<td>1 GB</td>
<td>8</td>
<td>128</td>
<td>2</td>
<td>64</td>
<td>TBD</td>
<td>AEMIF</td>
</tr>
<tr class="row-even"><td>K2L</td>
<td>MT29F16G
08ADBCAH
4:C</td>
<td>512 MB</td>
<td>8</td>
<td>256</td>
<td>4</td>
<td>224</td>
<td>TBD</td>
<td>AEMIF
|</td>
</tr>
</tbody>
</table>
<p>Table:  NAND Flash Specification Summary</p>
<p class="rubric" id="am43xx-gp-evm">AM43xx GP EVM</p>
<p>On this board, NAND Flash data lines are muxed with eMMC, so either eMMC
or NAND can be used enabled at a time. By default NAND is enabled.</p>
<p class="rubric" id="am43xx-epos-evm">AM43xx EPOS EVM</p>
<p>On this board, NAND Flash control lines are muxed with QSPI, Thus either
NAND or QSPI-NOR can be used at a time. By default NAND is enabled.</p>
<p class="rubric" id="dra74x-evm">DRA71x EVM</p>
<p>On the board, NAND Flash signals are muxed between NAND, NOR and Video
Out signals. Therefore, to have the signals properly muxed for NAND to
work Pin 1 (first pin on the left) must be turned on and Pin 2 must be
turned off. Pin 1 and 2 must never be switched on at the same time.
Doing so may cause damage to the board or SoC.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Aside from setting the correct bootmode (SYSBOOT[5:0]) for
NAND boot, make sure that The Bus width (SYSBOOT[13]) and
Muxed-device (SYSBOOT[12:11]) are set as given in the TRM.</p>
</div>
<p class="rubric" id="configurations-gpmc-specific">Configurations (GPMC Specific)</p>
<p class="rubric" id="how-to-enable-omap-nand-driver-in-linux-kernel"><strong>How to enable OMAP NAND driver in Linux Kernel&nbsp;?</strong></p>
<p>OMAP NAND driver can be enable/disable via <em>Linux Kernel
Configuration</em>&nbsp;tool. Enable below Configs to enable MTD Support along
with MTD nand driver support</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Device Drivers  ---&gt;
  &lt;*&gt; Memory Technology Device (MTD) support  ---&gt;
            [*]   Command line partition table parsing
            &lt;*&gt;   Direct char device access to MTD devices
            &lt;*&gt;   Caching block device access to MTD devices
            &lt;*&gt;   NAND Device Support  ---&gt;
                        &lt;*&gt;    NAND Flash device on OMAP2 and OMAP3
            &lt;*&gt;   Enable UBI - Unsorted block images  ---&gt;
</pre></div>
</div>
<p class="rubric" id="transfer-modes">Transfer Modes</p>
<p class="rubric" id="choose-correct-bus-transfer-mode"><strong>Choose correct bus transfer mode</strong></p>
<div class="line-block">
<div class="line">TI’s NAND driver support following different modes of transfers data
to external NAND device.</div>
</div>
<ul class="simple">
<li>“prefetch-polled” Prefetch polled mode (default)</li>
<li>“polled” Polled mode, without prefetch</li>
<li>“prefetch-dma” Prefetch enabled DMA mode</li>
<li>“prefetch-irq” Prefetch enabled IRQ mode</li>
</ul>
<p>Transfer mode can be configured in linux-kernel via DT binding
<strong>&lt;ti,nand-xfer-type&gt;</strong>
Refer: Linux kernel_docs &#64;
$LINUX/Documentation/devicetree/bindings/mtd/gpmc-nand.txt</p>
<p class="rubric" id="dma-vs-non-dma-mode-pio-mode"><strong>DMA vs Non DMA Mode (PIO Mode)</strong></p>
<div class="line-block">
<div class="line">The NAND interface is a low speed interface when compared to the main
CPU. This means for most CPU frequencies</div>
<div class="line">if the CPU is reading the NAND buffers via polling then its fully
capable of reading the NAND at its maximum speed.</div>
<div class="line">Of course the trade off being that the CPU while polling the NAND is
not capable of doing anything else thus significantly</div>
<div class="line">increasing the overall CPU load.</div>
</div>
<div class="line-block">
<div class="line">DMA performs best when it can read large amount of data at a time.
This is necessary since the overhead in setting up, executing and
returning from a DMA request is not insignificant so to compensate its
best for the DMA to read/write as much data as possible. This provides
a dual purpose of significant reduction in CPU load for an operation
and also high performance.</div>
</div>
<p>The current NAND subsystem within Linux currently deals with reading a
single page from the NAND at a time. Unfortunately, the page size is
small enough that the overhead for using the DMA (including Linux DMA
software stack) negatively impacts the performance. Based on nand
performance tests done in early 2016 using the DMA reduced NAND read and
write performance by 10-20% depending on SOC. However, cpu load when
using polling via the same NAND test were around 99%. When using DMA
mode the CPU load for reading was around 35%-54% and for writing was
around 15%-30% depending on SOC.</p>
<p class="rubric" id="performance-optimizations-on-nand"><strong>Performance optimizations on NAND</strong></p>
<p class="rubric" id="tweak-nand-device-signal-timings"><strong>Tweak NAND device signal timings</strong></p>
<p>Much of the NAND throughput can be improved by matching GPMC signal
timings with NAND device present on the board. Although GPMC signal
timing configurations are not same as those given in NAND device
datasheets, but they can be easily derived based on details given in
GPMC Controller functional specification.</p>
<ul class="simple">
<li>Details of GPMC Signal Timing configurations and how to use them can
be found in TI’s Processor TRM</li>
</ul>
<p>Chapter <em>General Purpose Memory Controller</em>
Section <em>Signal Control</em></p>
<ul class="simple">
<li>In Linux, GPMC signal timing configurations are specified via DTB.</li>
</ul>
<p>Refer kernel_docs
$LINUX/Documentation/devicetree/bindings/bus/ti-gpmc.txt
Some timing configurations like &lt;gpmc,rd-cycle-ns&gt;, &lt;gpmc,wr-cycle-ns&gt;
have larger impact on NAND throughput than others.</p>
<ul class="simple">
<li>In U-boot, GPMC signal timing configurations are specified during
GPMC initialization in arch/arm/cpu/armv7/../… mem.c or
mem_common.c</li>
</ul>
<p><em>gpmc_init()</em>&nbsp;:: <em>struct gpmc_cfg</em></p>
<p class="rubric" id="tweaking-ubifs"><strong>Tweaking UBIFS</strong></p>
<ul class="simple">
<li>Specify <strong>-o bulk_read</strong> while mounting UBIFS <a class="reference external" href="http://www.linux-mtd.infradead.org/doc/ubifs.html#L_readahead">(read
ahead)</a></li>
<li>Tweak Linux VM <a class="reference external" href="http://www.linux-mtd.infradead.org/doc/ubifs.html#L_wb_knobs">(kernel knobs for
VM)</a></li>
</ul>
<p class="rubric" id="additional-resources">Additional Resources</p>
<div class="line-block">
<div class="line">Following links should help you better understand NAND Flash as
technology.</div>
<div class="line"><a class="reference external" href="http://www.linux-mtd.infradead.org/doc/nand.html">http://www.linux-mtd.infradead.org/doc/nand.html</a></div>
<div class="line"><a class="reference external" href="https://wiki.linaro.org/Flash%20memory">https://wiki.linaro.org/Flash%20memory</a></div>
</div>
<p><a class="reference external" href="https://lwn.net/Articles/428584/">https://lwn.net/Articles/428584/</a></p>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="MMC-SD.html" class="btn btn-neutral float-right" title="3.2.2.16. MMC/SD" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../SPI.html" class="btn btn-neutral" title="3.2.2.14. SPI" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2020</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'07_01_00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>