

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.2.2.8. CPSW2g Ethernet &mdash; Processor SDK Linux for J721e Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../../search.html"/>
    <link rel="top" title="Processor SDK Linux for J721e Documentation" href="../../../../../index.html"/>
        <link rel="up" title="3.2.2. Kernel Drivers" href="../../../../Foundational_Components_Kernel_Drivers.html"/>
        <link rel="next" title="3.2.2.9. CPSW9g virtual MAC (remoteproc)" href="CPSW9g_virt_mac.html"/>
        <link rel="prev" title="3.2.2.7. I2C" href="../I2C.html"/> 

  
  <script src="../../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../../../../../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../../devices/J7/linux/index.html" class="icon icon-home"> Processor SDK Linux for J721e
          

          
          </a>

          
            
            
              <div class="version">
                07_01_00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../Overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../devices/J7/linux/Release_Specific.html">2. Release Specific</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../Foundational_Components.html">3. Foundational Components</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_U-Boot.html">3.1. U-Boot</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Users_Guide.html">3.2.1. Users Guide</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../ADC.html">3.2.2.1. ADC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Audio.html">3.2.2.2. Audio</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Crypto.html">3.2.2.3. Crypto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Display/DSS7.html">3.2.2.4. DSS (DSS6 &amp; DSS7)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GPIO.html">3.2.2.5. GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="../HYPERFLASH.html">3.2.2.6. HyperBus and HyperFlash</a></li>
<li class="toctree-l4"><a class="reference internal" href="../I2C.html">3.2.2.7. I2C</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">3.2.2.8. CPSW2g Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="CPSW9g_virt_mac.html">3.2.2.9. CPSW9g virtual MAC (remoteproc)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_End_Point.html">3.2.2.10. PCIe End Point</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_Backplane.html">3.2.2.11. PCIe Backplane</a></li>
<li class="toctree-l4"><a class="reference internal" href="../PCIe/PCIe_Root_Complex.html">3.2.2.12. PCIe Root Complex</a></li>
<li class="toctree-l4"><a class="reference internal" href="../QSPI.html">3.2.2.13. OSPI/QSPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../SPI.html">3.2.2.14. SPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Storage/NAND.html">3.2.2.15. NAND</a></li>
<li class="toctree-l4"><a class="reference internal" href="../Storage/MMC-SD.html">3.2.2.16. MMC/SD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../UART.html">3.2.2.17. UART</a></li>
<li class="toctree-l4"><a class="reference internal" href="../USB/CDNS3.html">3.2.2.18. USB CDNS3</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_LTP-DDT_Validation.html">3.2.3. LTP-DDT Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../Foundational_Components_Kernel_FAQs.html">3.2.4. FAQs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Filesystem.html">3.3. Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Tools.html">3.4. Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_IPCLLD.html">3.5. IPC Low Level Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Graphics.html">3.6. Graphics and Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Virtualization.html">3.7. Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_Machine_Learning.html">3.8. Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_ATF.html">3.9. ARM Trusted Firmware-A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../Foundational_Components_OPTEE.html">3.10. OP-TEE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../How_to_Guides.html">4. How to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Documentation_Tarball.html">5. Documentation Tarball</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../../devices/J7/linux/index.html">Processor SDK Linux for J721e</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../../devices/J7/linux/index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components.html">3. Foundational Components</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel.html">3.2. Kernel</a> &raquo;</li>
      
          <li><a href="../../../../Foundational_Components_Kernel_Drivers.html">3.2.2. Kernel Drivers</a> &raquo;</li>
      
    <li>3.2.2.8. CPSW2g Ethernet</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cpsw2g-ethernet">
<h1>3.2.2.8. CPSW2g Ethernet<a class="headerlink" href="#cpsw2g-ethernet" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>3.2.2.8.1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The TI J721E SoC Gigabit Ethernet Switch subsystem (CPSW NUSS) has two ports and
provides Ethernet packet communication for the device. It supports MII interfaces
the Reduced Gigabit Media Independent Interface (RGMII), Reduced Media Independent
Interface (RMII), and the Management Data Input/Output (MDIO) interface for
physical layer device (PHY) management.</p>
<p>The TI J721E SoC has integrated two-port Gigabit Ethernet Switch subsystem
into device MCU domain named MCU_CPSW0 and has only one external Ethernet port (port 1)
with selectable RGMII and RMII interfaces and an internal Communications
Port Programming Interface (CPPI) port (Host port 0). Host Port 0 CPPI Packet
Streaming Interface interface supports 8 TX channels and one RX channel
operating by TI J721E NAVSS Unified DMA Peripheral Root Complex (UDMA-P) controller.</p>
<p>The driver follows the standard Linux network interface architecture and
supports the following features:</p>
<ol class="arabic simple">
<li>100/1000 Mbps mode of operation.</li>
<li>Auto negotiation.</li>
<li>Linux NAPI support</li>
<li>VLAN filtering</li>
<li>Ethertool</li>
<li>CPTS</li>
<li>EST/TAS offload as per 802.1Q-2018</li>
</ol>
<p><em>Not supported</em>:</p>
<ul class="simple">
<li>Interrupt Pacing is not supported by HW. NAPI is used by driver.</li>
</ul>
<p class="rubric" id="k3-driver-configuration-cpsw"><strong>Driver Configuration</strong></p>
<p>The TI Processor SDK has Jacinto 7  MCU CPSW2g driver enabled by default.</p>
<p>To enable/disable Networking support manually, start the <em>Linux Kernel Configuration</em>
tool:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ make ARCH=arm64 menuconfig
</pre></div>
</div>
<div class="line-block">
<div class="line">Select <em>Device Drivers</em> from the main menu -&gt;</div>
<div class="line">Select <em>Network device support</em> -&gt;</div>
<div class="line">Select <em>Ethernet driver support</em> -&gt;</div>
<div class="line">Select ** as shown here:</div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>...
[*]   Texas Instruments (TI) devices
-*-     TI DaVinci MDIO Support
-*-     TI CPSW ALE Support
&lt;*&gt;     TI K3 CPSW Ethernet driver
[*]       Enable TAS offload in AM65 CPSW
&lt;*&gt;     TI K3 AM65x CPTS
...
</pre></div>
</div>
<p>Kernel Kconfig options:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>CONFIG_TI_DAVINCI_MDIO
CONFIG_TI_CPSW_ALE
CONFIG_TI_AM65_CPSW_NUSS
CONFIG_TI_AM65_CPTS
CONFIG_TI_AM65_CPSW_TAS
</pre></div>
</div>
<p class="rubric" id="k3-module-build"><strong>Module Build</strong></p>
<p>Module build for the cpsw driver is supported. To do this, at all the
places mentioned in the section above select module build (short-cut key
<strong>M</strong>).</p>
<p class="rubric" id="k3-dt-binding"><strong>Device tree bindings</strong></p>
<p>The DT bindings description can be found at:</p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://git.ti.com/ti-linux-kernel/ti-linux-kernel/blobs/ti-linux-5.4.y/Documentation/devicetree/bindings/net/ti,am654-cpsw-nuss.txt">Documentation/devicetree/bindings/net/ti,am654-cpsw-nuss.txt</a></div>
</div>
<div class="line-block">
<div class="line"><a class="reference external" href="https://git.ti.com/ti-linux-kernel/ti-linux-kernel/blobs/ti-linux-5.4.y/Documentation/devicetree/bindings/net/ti,am654-cpts.txt">Documentation/devicetree/bindings/net/ti,am654-cpts.txt</a></div>
<div class="line"><br /></div>
</div>
<p class="rubric" id="k3-bringing-up-interfaces">Bringing Up interface</p>
<p>The network interface can be configured automatically depending on root file system or configured manually. Manual configuration:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ip addr add 192.168.1.1/24 dev eth0
ip link set dev eth0 up

&lt; or &gt;

ifconfig eth0 &lt;ip&gt; netmask &lt;mask&gt; up
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-i-driver">Get driver information</p>
<p>The MCU_CPSW0 interface can be identified by using <code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-i|--driver</span></code> command.
It also provides some information about supported features.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -i &lt;dev&gt;
driver: am65-cpsw-nuss
version: 0.1
firmware-version:
expansion-rom-version:
bus-info: 46000000.ethernet
supports-statistics: yes
supports-test: no
supports-eeprom-access: no
supports-register-dump: yes
supports-priv-flags: yes
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-display-standard-information-about-device">ethtool - Display standard information about device/link</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>   # ethtool eth0
Supported ports: [ TP MII ]
Supported link modes:   10baseT/Half 10baseT/Full
                        100baseT/Half 100baseT/Full
                        1000baseT/Half 1000baseT/Full
Supported pause frame use: Symmetric Receive-only
Supports auto-negotiation: Yes
Supported FEC modes: Not reported
Advertised link modes:  10baseT/Half 10baseT/Full
                        100baseT/Half 100baseT/Full
                        1000baseT/Half 1000baseT/Full
Advertised pause frame use: No
Advertised auto-negotiation: Yes
Advertised FEC modes: Not reported
Link partner advertised link modes:  10baseT/Half 10baseT/Full
                                     100baseT/Half 100baseT/Full
Link partner advertised pause frame use: Symmetric
Link partner advertised auto-negotiation: Yes
Link partner advertised FEC modes: Not reported
Speed: 100Mb/s
Duplex: Full
Port: MII
PHYAD: 0
Transceiver: internal
Auto-negotiation: on
Supports Wake-on: d
Wake-on: d
Current message level: 0x00000000 (0)

Link detected: yes
</pre></div>
</div>
<p class="rubric" id="k3-rx-csum-offload">RX checksum offload</p>
<p>The Driver enables RX checksum offload by default. it can be disabled/enabled by using <code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-K</span></code> command:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -k &lt;dev&gt;
....
rx-checksumming: on
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>ethtool -K &lt;dev&gt; rx-checksum on|off
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TX checksum offload is implemented, but may disabled by default due to
errata i2027 on affected J721E.</p>
</div>
<p class="rubric" id="k3-vlan-config"><strong>VLAN Config</strong></p>
<p>VLAN can be added/deleted using <code class="docutils literal"><span class="pre">ip</span></code> or <code class="docutils literal"><span class="pre">vconfig</span></code> utility.</p>
<p><em>VLAN Add</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ip link add link eth0 name eth0.5 type vlan id 5

&lt; or &gt;

vconfig add eth0 5
</pre></div>
</div>
<p><em>VLAN del</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ip link del eth0.5

&lt; or &gt;

vconfig rem eth0 5
</pre></div>
</div>
<p><em>VLAN IP assigning</em></p>
<p>IP address can be assigned to the VLAN interface either via udhcpc
when a VLAN aware dhcp server is present or via static ip assigning
using <code class="docutils literal"><span class="pre">ip</span></code> or <code class="docutils literal"><span class="pre">ifconfig</span></code>.</p>
<p>Once VLAN is added, it will create a new entry in Ethernet interfaces
like eth0.5, below is an example how it check the vlan interface</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ip addr add 192.168.1.1/24 dev eth0.5

&lt; or &gt;

ifconfig eth0.5
....
eth0.5    Link encap:Ethernet  HWaddr 20:CD:39:2B:C7:BE
          inet addr:192.168.10.5  Bcast:192.168.10.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
</pre></div>
</div>
<p><em>VLAN Packet Send/Receive</em></p>
<p>To Send or receive packets with the VLAN tag, bind the socket to the
proper Ethernet interface shown above and can send/receive via that
socket-fd.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric" id="k3-multicast-adddelete"><strong>Multicast Add/Delete</strong></p>
<p>Multicast MAC address can be added/deleted using <em>ip maddr</em> commands or Linux
socket ioctl SIOCADDMULTI/SIOCDELMULTI.</p>
<p><em>Show muliticast address</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ip maddr show dev &lt;dev&gt;
2:      eth0
    link  01:00:5e:00:00:01
    link  01:80:c2:00:00:00
    link  01:80:c2:00:00:03
    link  01:80:c2:00:00:0e
    link  01:00:5e:00:00:fc
    inet  224.0.0.252
    inet  224.0.0.1
</pre></div>
</div>
<p><em>Add muliticast address</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ip maddr add 01:00:5e:00:00:05 dev eth0
# ip maddr show dev eth0
2:      eth0
    link  01:00:5e:00:00:01
    link  01:80:c2:00:00:00
    link  01:80:c2:00:00:03
    link  01:80:c2:00:00:0e
    link  01:00:5e:00:00:fc
    link  01:00:5e:00:00:05 static
    inet  224.0.0.252
    inet  224.0.0.1
</pre></div>
</div>
<p><em>Delete muliticast address</em></p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ip maddr del 01:00:5e:00:00:05 dev eth0
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric" id="k3-ethtool-show-permaddr"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-P|--show-permaddr</span> <span class="pre">DEVNAME</span></code> Show permanent hardware
address</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -P eth0
Permanent address: a0:f6:fd:a6:46:6e&quot;
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-change-generic-options"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-s|--change</span> <span class="pre">DEVNAME</span></code> Change generic options</p>
<p>Below commands will be redirected to the phy driver:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -s &lt;dev&gt;
[ speed %d ]
[ duplex half|full ]
[ autoneg on|off ]
[ wol p|u|m|b|a|g|s|d... ]
[ sopass %x:%x:%x:%x:%x:%x ]
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CPSW driver do not perform any kind of WOL specific actions or
configurations.</p>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>#ethtool -s eth0 duplex half speed 100
[ 3550.892112] cpsw 48484000.ethernet eth0: Link is Down
[ 3556.088704] cpsw 48484000.ethernet eth0: Link is Up - 100Mbps/Half - flow control off
</pre></div>
</div>
<p>Sets the driver message type flags by name or number</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>[ msglvl %d | msglvl type on|off ... ]
# ethtool -s eth0 msglvl drv off
# ethtool -s eth0 msglvl ifdown off
# ethtool -s eth0 msglvl ifup off
# ethtool eth0
Current message level: 0x00000031 (49)
                       drv ifdown ifup
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-restart-n-way-negotiation"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-r|--negotiate</span> <span class="pre">DEVNAME</span></code> Restart N-WAY negotiation</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -r eth0
[ 4338.167685] cpsw 48484000.ethernet eth0: Link is Down
[ 4341.288695] cpsw 48484000.ethernet eth0: Link is Up - 1Gbps/Full - flow control rx/tx&quot;
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-show-pause-options"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-a|--show-pause</span> <span class="pre">DEVNAME</span></code> Show pause options</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -a eth0
Pause parameters for eth0:
Autonegotiate:  off
RX:             off
TX:             off
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-set-pause-options"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-A|--pause</span> <span class="pre">DEVNAME</span></code> Set pause options</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -A eth0 rx on tx on
cpsw 48484000.ethernet eth0: Link is Up - 1Gbps/Full - flow control rx/tx
# ethtool -a eth0
Pause parameters for eth0:
Autonegotiate:  off
RX:             on
TX:             on
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-query-rxtx-ring-parameters"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-g|--show-ring</span> <span class="pre">DEVNAME</span></code> Query RX/TX ring parameters</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -g eth0
Ring parameters for eth0:
Pre-set maximums:
RX:             0
RX Mini:        0
RX Jumbo:       0
TX:             0
Current hardware settings:
RX:             500
RX Mini:        0
RX Jumbo:       0
TX:             512
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-query-channels"><code class="docutils literal"><span class="pre">ethtool-l|--show-channels</span> <span class="pre">DEVNAME</span></code> Query Channels</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -l eth0
Channel parameters for eth0:
Pre-set maximums:
RX:             1
TX:             8
Other:          0
Combined:       0
Current hardware settings:
RX:             1
TX:             8
Other:          0
Combined:       0
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-l-set-channels"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-L\|--set-channels</span> <span class="pre">DEVNAME</span></code> Set Channels.</p>
<p>Allows to control number of TX channels driver is allowed to work with at DMA level. The maximum number of TX channels is 8.
Supported options <code class="docutils literal"><span class="pre">[</span> <span class="pre">tx</span> <span class="pre">N</span> <span class="pre">]</span></code>:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -L eth0 tx 3
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-priv-flags"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">--show-priv-flags/--set-priv-flags</span> <span class="pre">DEVNAME</span></code> Show/Set private flags</p>
<p>Allows to control private flags supported by driver.</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="85%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Flag</th>
<th class="head">&#160;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>p0-rx-ptype-rrobin</td>
<td>Controls TX DMA channels processing mode: round-robin or priority mode.
In case priority mode is enabled, the high number channel will have higher priority: TX 7 - prio 7 … TX 0 - prio 0.</td>
</tr>
<tr class="row-odd"><td>iet-frame-preemption</td>
<td>Enables support for Interspersed Express Traffic (IET) IEEE 802.3br (frame preemption).</td>
</tr>
<tr class="row-even"><td>iet-mac-verify</td>
<td>Enables Interspersed Express Traffic (IET) MAC verification procedure on link up event.</td>
</tr>
</tbody>
</table>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool --show-priv-flags eth0
Private flags for eth0:
p0-rx-ptype-rrobin  : on
iet-frame-preemption: off
iet-mac-verify      : off

# ethtool --set-priv-flags eth0 p0-rx-ptype-rrobin off
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The network interface have to be down for private flags configuration.</p>
</div>
<p class="rubric" id="k3-ethtool-show-adapter-statistics"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-S|--statistics</span> <span class="pre">DEVNAME</span></code> Show adapter statistics</p>
<p>“ethtool -S” command displays statistic for both external Port 1 and Host port 0.
Host port 0 statistics prefixed with <em>p0_</em>.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span> # ethtool -S eth0
NIC statistics:
     p0_rx_good_frames: 347
     p0_rx_broadcast_frames: 4
     p0_rx_multicast_frames: 264
     p0_rx_crc_errors: 0
     p0_rx_oversized_frames: 0
     p0_rx_undersized_frames: 0
     p0_ale_drop: 0
     p0_ale_overrun_drop: 0
     p0_rx_octets: 25756
     p0_tx_good_frames: 4816
     p0_tx_broadcast_frames: 3629
     p0_tx_multicast_frames: 1120
     p0_tx_octets: 878055
     p0_tx_64B_frames: 735
     p0_tx_65_to_127B_frames: 1023
     ...
     rx_good_frames: 4816
     rx_broadcast_frames: 3629
     rx_multicast_frames: 1120
     rx_pause_frames: 0
     rx_crc_errors: 0
     rx_align_code_errors: 0
     rx_oversized_frames: 0
     rx_jabber_frames: 0
     rx_undersized_frames: 0
     rx_fragments: 0
     ale_drop: 0
     ale_overrun_drop: 0
     rx_octets: 878055
     tx_good_frames: 347
     tx_broadcast_frames: 4
     tx_multicast_frames: 264
     tx_pause_frames: 0
     tx_deferred_frames: 0
     tx_collision_frames: 0
     tx_single_coll_frames: 0
     tx_mult_coll_frames: 0
     tx_excessive_collisions: 0
     tx_late_collisions: 0
     ...
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-show-time-stamping-capabilities"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-T|--show-time-stamping</span> <span class="pre">DEVNAME</span></code> Show time stamping
capabilities.</p>
<p>Accessible when CPTS is enabled.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>  # ethtool -T eth0
Time stamping parameters for eth0:
Capabilities:
        hardware-transmit     (SOF_TIMESTAMPING_TX_HARDWARE)
        software-transmit     (SOF_TIMESTAMPING_TX_SOFTWARE)
        hardware-receive      (SOF_TIMESTAMPING_RX_HARDWARE)
        software-receive      (SOF_TIMESTAMPING_RX_SOFTWARE)
        software-system-clock (SOF_TIMESTAMPING_SOFTWARE)
        hardware-raw-clock    (SOF_TIMESTAMPING_RAW_HARDWARE)
PTP Hardware Clock: 1
Hardware Transmit Timestamp Modes:
        off                   (HWTSTAMP_TX_OFF)
        on                    (HWTSTAMP_TX_ON)
Hardware Receive Filter Modes:
        none                  (HWTSTAMP_FILTER_NONE)
        all                   (HWTSTAMP_FILTER_ALL)
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-show-eee-settings"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">--show-eee</span> <span class="pre">DEVNAME</span></code> Show EEE settings</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#ethtool --show-eee eth0
EEE Settings for eth0:
        EEE status: not supported
</pre></div>
</div>
<p class="rubric" id="k3-ethtool-set-eee-settings"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">--set-eee</span> <span class="pre">DEVNAME</span></code> Set EEE settings.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full EEE is not supported in driver, but it enables reading
and writing of EEE advertising settings in Ethernet PHY. This way one
can disable advertising EEE for certain speeds.</p>
</div>
<p class="rubric" id="k3-ethtool-do-a-register-dump"><code class="docutils literal"><span class="pre">ethtool</span> <span class="pre">-d|--register-dump</span> <span class="pre">DEVNAME</span></code> Do a register dump</p>
<p>This command dumps all CPSW MMIO regions in the below format.
The TI switch-config tool can be used for CPSW NUSS register dump parsing.</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">MMIO region header (8 Bytes)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>module_id
(u32)</td>
<td>MMIO region id
NUSS = 1,
RGMII_STATUS = 2,
MDIO = 3,
CPSW = 4,
CPSW_P0 = 5,
CPSW_P1 = 6,
CPSW_CPTS = 7,
CPSW_ALE = 8,
CPSW_ALE_TBL = 9</td>
</tr>
<tr class="row-odd"><td>len (u32)</td>
<td>MMIO region dump length, including header</td>
</tr>
<tr class="row-even"><td colspan="2">MMIO region registers dump (num_regs * 8 Bytes)</td>
</tr>
<tr class="row-odd"><td>reg_offset (u32)</td>
<td>resgister offset from the start
of MCU NAVSS MMIO space</td>
</tr>
<tr class="row-even"><td>reg_value (u32)</td>
<td>MMIO region dump length, including header</td>
</tr>
</tbody>
</table>
<p>Exception: ALE table dumped as raw array of ALE records (3 * u32 per record).</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ethtool -d eth0
Offset          Values
------          ------
0x0000:         01 00 00 00 48 00 00 00 00 00 00 00 00 71 a0 6b
0x0010:         04 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00
0x0020:         0c 00 00 00 00 00 00 00 10 00 00 00 01 00 00 00
0x0030:         14 00 00 00 00 00 00 00 18 00 00 00 00 00 00 00
0x0040:         1c 00 00 00 00 00 00 00 02 00 00 00 48 00 00 00
0x0050:         30 00 00 00 0b 00 00 00 34 00 00 00 00 00 00 00
0x0060:         38 00 00 00 00 00 00 00 3c 00 00 00 00 00 00 00
...
</pre></div>
</div>
</div>
<div class="section" id="common-platform-time-sync-cpts-module">
<h2>3.2.2.8.2. Common Platform Time Sync (CPTS) module<a class="headerlink" href="#common-platform-time-sync-cpts-module" title="Permalink to this headline">¶</a></h2>
<p>The Common Platform Time Sync (CPTS) module is used to facilitate host
control of time sync operations. It enables compliance with the IEEE
1588-2008 standard for a precision clock synchronization protocol.</p>
<p>The support for CPTS module can be enabled by Kconfig option
CONFIG_TI_AM65_CPTS or through menuconfig tool. The PTP packet
timestamping can be enabled only for one CPSW port.</p>
<p>When CPTS module is enabled it will exports a kernel interface for
specific clock drivers and a PTP clock API user space interface and
enable support for SIOCSHWTSTAMP and SIOCGHWTSTAMP socket ioctls. The
PTP exposes the PHC as a character device with standardized ioctls which
usually can be found at path:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>/dev/ptpN
</pre></div>
</div>
<p>Supported PTP hardware clock functionality:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Basic clock operations
   - Set time
   - Get time
   - Shift the clock by a given offset atomically
   - Adjust clock frequency
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>Ancillary clock features
   - Time stamp external events
   - Periodic output signals configurable from user space
   - Synchronization of the Linux system time via the PPS subsystem
</pre></div>
</div>
<p>Supported parameters for SIOCSHWTSTAMP and SIOCGHWTSTAMP:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>SIOCSHWTSTAMP
   hwtstamp_config.flags = 0
   hwtstamp_config.tx_type
       HWTSTAMP_TX_ON - enables hardware time stamping for outgoing packets
       HWTSTAMP_TX_OFF - no outgoing packet will need hardware time stamping
   hwtstamp_config.rx_filter
       HWTSTAMP_FILTER_NONE - time stamp no incoming packet at all
       HWTSTAMP_FILTER_ALL - time stamp any incoming packet
</pre></div>
</div>
<p>CPTS PTP packet timestamping default configuration when enabled
(SIOCSHWTSTAMP):</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>CPSW_PN_TS_CTL_REG
   TS_MSG_TYPE_EN = 0xF (Sync, Delay_Req, Pdelay_Req, and Pdelay_Resp.)
   TS_TX_ANNEX_F_EN = 1
   TS_TX_ANNEX_E_EN = 1
   TS_TX_ANNEX_D_EN = 1
   TS_TX_VLAN_LTYPE1_E = 1
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>CPSW_PN_TS_CTL_LTYPE2_REG
   TS_TTL_NONZERO = 1
   TS_320 = 1
   TS_319 = 1
   TS_132 = 1
   TS_131 = 1
   TS_130 = 1
   TS_129 = 1
   TS_107 = 1
   TS_LTYPE1 = 0x88F7 (ETH_P_1588)
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>CPSW_PN_TS_SEQ_LTYPE_REG
   TS_SEQ_ID_OFFSET = 0x1e
   TS_LTYPE1 = 0x88F7 (ETH_P_1588)
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>CPSW_PN_TS_VLAN_LTYPE_REG
   TS_VLAN_LTYPE1 =  0x8100 (ETH_P_8021Q)
</pre></div>
</div>
<p>For more information about PTP clock API and Network timestamping see
Linux kernel documentation</p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/Documentation/ptp/ptp.txt">Documentation/ptp/ptp.txt</a></div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/include/uapi/linux/ptp_clock.h">include/uapi/linux/ptp_clock.h</a></div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/Documentation/ABI/testing/sysfs-ptp">Documentation/ABI/testing/sysfs-ptp</a></div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/Documentation/networking/timestamping.txt">Documentation/networking/timestamping.txt</a></div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/Documentation/pps/pps.txt">Documentation/pps/pps.txt</a></div>
<div class="line"><br /></div>
<div class="line">Code examples and tools:</div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/tools/testing/selftests/ptp/testptp.c">tools/testing/selftests/ptp/testptp.c</a></div>
<div class="line"><a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/plain/tools/testing/selftests/networking/timestamping/timestamping.c">tools/testing/selftests/networking/timestamping/timestamping.c</a></div>
<div class="line"><br /></div>
<div class="line"><a class="reference external" href="http://linuxptp.sourceforge.net/">Open Source Project linuxptp</a></div>
<div class="line"><a class="reference external" href="https://github.com/redlab-i/pps-tools">Linux PPS tools</a></div>
<div class="line"><br /></div>
</div>
<p class="rubric" id="k3-testing-using-ptp4l-tool-from-linuxptp-project">Testing using ptp4l tool from linuxptp project</p>
<p>To check the ptp clock adjustment with PTP protocol, a PTP slave
(client) and a PTP master (server) applications are needed to run on
separate devices (EVM or PC). Open source application package linuxptp
can be used as slave and as well as master. Hence TX timestamp
generation can be delayed (especially with low speed links) the ptp4l
“tx_timestamp_timeout” parameter need to be set for ptp4l to work.</p>
<ul class="simple">
<li>create file ptp.cfg with content as below:</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>[global]
tx_timestamp_timeout     400
</pre></div>
</div>
<ul class="simple">
<li>pass configuration file to ptp4l using “-f” option:</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>ptp4l -E -2 -H -i eth0  -l 6 -m -q -p /dev/ptpN -f ptp.cfg
</pre></div>
</div>
<ul class="simple">
<li>Slave Side Examples</li>
</ul>
<p>The following command can be used to run a ptp-over-L4 client on the evm
in slave mode</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>./ptp4l -E -4 -H -i eth0 -s -l 7 -m -q -p /dev/ptpN
</pre></div>
</div>
<p>For ptp-over-L2 client, use the command</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>./ptp4l -E -2 -H -i eth0 -s -l 7 -m -q -p /dev/ptpN
</pre></div>
</div>
<ul class="simple">
<li>Master Side Examples</li>
</ul>
<p>ptp4l can also be run in master mode. For example, the following command
starts a ptp4l-over-L2 master on an EVM using hardware timestamping,</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>./ptp4l -E -2 -H -i eth0 -l 7 -m -q -p /dev/ptpN
</pre></div>
</div>
<p>On a Linux PC which does not supoort hardware timestamping, the
following command starts a ptp4l-over-L2 master using software
timestamping.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>./ptp4l -E -2 -S -i eth0 -l 7 -m -q
</pre></div>
</div>
<p class="rubric" id="k3-testing-using-testptp-tool-from-linux-kernel">Testing using testptp tool from Linux kernel</p>
<ul class="simple">
<li>get the ptp clock time</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -d /dev/ptpN -g
clock time: 1493255613.608918429 or Thu Apr 27 01:13:33 2017
</pre></div>
</div>
<ul class="simple">
<li>query the ptp clock’s capabilities</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -d /dev/ptpN -c
capabilities:
  10000000 maximum frequency adjustment (ppb)
  0 programmable alarms
  4 external time stamp channels
  2 programmable periodic signals
  1 pulse per second
  0 programmable pins
  0 cross timestamping
</pre></div>
</div>
<ul class="simple">
<li>Sanity testing of cpts ref frequency</li>
</ul>
<p>Time difference between to testptp -g calls should be equal sleep time</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -g -d /dev/ptpN &amp;&amp; sleep 5 &amp;&amp; testptp -g -d /dev/ptpN
clock time: 1493255884.565859901 or Thu Apr 27 01:18:04 2017
clock time: 1493255889.611065421 or Thu Apr 27 01:18:09 2017
</pre></div>
</div>
<ul class="simple">
<li>shift the ptp clock time by ‘val’ seconds</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -g -d /dev/ptpN &amp;&amp; testptp -t 100 &amp;&amp; testptp -g -d /dev/ptpN
clock time: 1493256107.640649117 or Thu Apr 27 01:21:47 2017
time shift okay
clock time: 1493256207.678819093 or Thu Apr 27 01:23:27 2017
</pre></div>
</div>
<ul class="simple">
<li>set the ptp clock time to ‘val’ seconds</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -g -d /dev/ptpN &amp;&amp; testptp -T 1000000 &amp;&amp; testptp -g -d /dev/ptpN
clock time: 1493256277.568238925 or Thu Apr 27 01:24:37 2017
set time okay
clock time: 100.018944504 or Thu Jan  1 00:01:40 1970
</pre></div>
</div>
<ul class="simple">
<li>adjust the ptp clock frequency by ‘val’ ppb</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -g -d /dev/ptpN &amp;&amp; testptp -f 1000000 &amp;&amp; testptp -g -d /dev/ptpN
clock time: 151.347795184 or Thu Jan  1 00:02:31 1970
frequency adjustment okay
clock time: 151.386187454 or Thu Jan  1 00:02:31 1970
</pre></div>
</div>
<p class="rubric" id="k3-example-of-using-time-stamp-external-events">Example of using Time stamp external events</p>
<p>Timestamping of external events can be tested using
testptp tool. Before testing the proper CPTS signal routing has to be done by
using timesync router in DT.</p>
<p>For example, output of GENF0 can be routed to HW3_TS_PUSH_EN input.
It’s required to rebuild kernel with below changes first</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#define TS_OFFSET(pa, val)     (0x4+(pa)*4) (0x80000000 | val)

&amp;timesync_router {
   pinctrl-names = &quot;default&quot;;
   pinctrl-0 = &lt;&amp;mcu_cpts&gt;;

       /* Example of the timesync routing */
           mcu_cpts: mcu_cpts {
                   pinctrl-single,pins = &lt;
                           /* pps [cpts genf0] in12 -&gt; out24 [cpts hw4_push] */
                           TS_OFFSET(24, 12)
                   &gt;;
           };
};
</pre></div>
</div>
<p>Then execute:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># testptp -d /dev/ptpN -p 500000000 -i 0
# testptp -d /dev/ptpN -e 100 -i 2
event index 2 at 384.250000025
event index 2 at 384.750000025
event index 2 at 385.250000025
event index 2 at 385.750000025
</pre></div>
</div>
<p class="rubric" id="k3-cpts-pps-support">PPS Pulse Per Second support</p>
<p>By default, PPS support for J721E is implemented and enabled in TI SDK by wiring
GENF1 output to HW3_TS_PUSH_EN input:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>k3-am654-base-board.dts
#define TS_OFFSET(pa, val)     (0x4+(pa)*4) (0x80000000 | val)

&amp;timesync_router {
       pinctrl-names = &quot;default&quot;;
       pinctrl-0 = &lt;&amp;mcu_cpts&gt;;

       /* Example of the timesync routing */
       mcu_cpts: mcu_cpts {
              pinctrl-single,pins = &lt;
                     /* pps [cpts genf1] in13 -&gt; out25 [cpts hw4_push] */
                     TS_OFFSET(25, 13)
              &gt;;
       };
};

&amp;mcu_cpsw {
       ...
       cpts {
              ti,pps = &lt;3 1&gt;;
       };
};
</pre></div>
</div>
<p>Once enabled, PPS can be tested using testptp and ppstest tools:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># ./testptp -d /dev/ptp1 -P 1
pps for system time request okay
# ./ppstest /dev/pps0
trying PPS source &quot;/dev/pps0&quot;
found PPS source &quot;/dev/pps0&quot;
ok, found 1 source(s), now start fetching data...
source 0 - assert 198.000000700, sequence: 7 - clear  0.000000000, sequence: 0
source 0 - assert 199.000000700, sequence: 8 - clear  0.000000000, sequence: 0
</pre></div>
</div>
<p class="rubric" id="k3-am65x-switch-config">TI AM65x switch-config tool</p>
<p>The TI Processor SDK includes precompiled correct version of Jacinto 7 switch-config tool.</p>
<p>The TI Jacinto 7 switch-config tool sources for J721E  SoC can be found at:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>git@git.ti.com:switch-config/switch-config.git
</pre></div>
</div>
<p>branch:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>origin/am65x-v1.0
</pre></div>
</div>
<p>Usage:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># switch-config -h
Switch configuration commands.....
switch-config -I,--ndev &lt;dev&gt; &lt;command&gt;

commands:
switch-config -d,--dump-ale :dump ALE table
switch-config -D,--dump=&lt;0..9&gt; :dump registers (0 - all)
switch-config -v,--version

dump values:
 :1 - cpsw-nuss regs
 :2 - cpsw-nuss-rgmii-status regs
 :3 - cpsw-nuss-mdio regs
 :4 - cpsw-nu regs
 :5 - cpsw-nu-p0 regs
 :6 - cpsw-nu-p1 regs
 :7 - cpsw-nu-cpts regs
 :8 - cpsw-nu-ale regs
 :9 - cpsw-nu-ale-tbl regs
</pre></div>
</div>
<p>Example, ALE table dump:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># switch-config -d
K3 cpsw dump version (1) len(6328)
ALE table dump ents(64):
0   : type: vlan , vid = 0, untag_force = 0x3, reg_mcast = 0x0, unreg_mcast = 0x0, member_list = 0x3
1   : type: ucast, addr = f4:84:4c:eb:a0:00, ucast_type = persistant, port_num = 0x0, Secure
2   : type: mcast, addr = ff:ff:ff:ff:ff:ff, mcast_state = f, no super, port_mask = 0x3
3   : type: mcast, addr = 01:00:5e:00:00:01, mcast_state = f, no super, port_mask = 0x3
4   : type: mcast, addr = 01:80:c2:00:00:00, mcast_state = f, no super, port_mask = 0x3
5   : type: mcast, addr = 01:80:c2:00:00:03, mcast_state = f, no super, port_mask = 0x3
6   : type: mcast, addr = 01:80:c2:00:00:0e, mcast_state = f, no super, port_mask = 0x3
8   : type: mcast, addr = 01:00:5e:00:00:fc, mcast_state = f, no super, port_mask = 0x3
9   : type: ucast, vid = 0, addr = 9c:b6:d0:89:0d:85, ucast_type = touched   , port_num = 0x1
26  : type: ucast, vid = 0, addr = c4:71:54:a9:6e:b4, ucast_type = touched   , port_num = 0x1
27  : type: ucast, vid = 0, addr = 00:25:22:a9:4c:b3, ucast_type = touched   , port_num = 0x1
</pre></div>
</div>
<p>Example, CPTS registers dump:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>switch-config -D7
K3 cpsw dump version (1) len(6328)
cpsw-nu-cpts regdump: num_regs(38)
0003d000:reg(4E8A2109)
0003d004:reg(00000C21)
0003d008:reg(00000000)
0003d00c:reg(00000000)
0003d010:reg(7EA3BA9B)
0003d014:reg(00000000)
0003d018:reg(00000000)
0003d01c:reg(00000000)
0003d020:reg(00000000)
0003d024:reg(00000000)
0003d028:reg(00000001)
0003d02c:reg(00000000)
0003d030:reg(00000000)
0003d034:reg(C7298A99)
0003d038:reg(03300000)
0003d03c:reg(00000000)
0003d040:reg(0000028E)
0003d044:reg(00000000)
0003d048:reg(00000000)
</pre></div>
</div>
</div>
<div class="section" id="ehnancements-for-scheduled-traffic-est-offload">
<h2>3.2.2.8.3. Ehnancements for Scheduled Traffic (EST) Offload<a class="headerlink" href="#ehnancements-for-scheduled-traffic-est-offload" title="Permalink to this headline">¶</a></h2>
<p>IEEE 802.1Qbv/D2.2 Enhancements for Scheduled Traffic (EST), Formerly known as Time Aware Shaper (TAS), is an enhancement to Transmission Selection algorithm defined in 802.1Q standard. It became formally part of 802.1Q-2018 edition of the standard. As per standard, a Bridge or an end station may support enhancements that allow transmission from each queue to be scheduled relative to a known timescale.  In order to achieve this, a transmission gate is associated with each queue; the state of the transmission gate determines whether or not queued frames can be selected for transmission. For a given queue, the transmission gate can be in one of two states:</p>
<blockquote>
<div><ul class="simple">
<li>Open: Queued frames are selected for transmission, in accordance with the definition of the transmission selection algorithm associated with the queue.</li>
<li>Closed: Queued frames are not selected for transmission.</li>
</ul>
</div></blockquote>
<p>In Linux, EST/TAS offload to hardware is implemented using taprio offload. Time Aware Priority Shaper (TAPRIO) TAPRIO, is a qdisc that implements a simplified version of the scheduling state machine defined by IEEE 802.1Q-2018 Section 8.6.9, which allows configuration of a sequence of gate states, where each gate state allows outgoing traffic for a subset (potentially empty) of traffic classes. EST is configured using tc command. Please refer the manual page <a class="reference external" href="http://www.man7.org/linux/man-pages/man8/tc-taprio.8.html">TAPRIO for more details on command syntax and description</a></p>
<p>CPSW2g h/w supports EST configuration or offload. EST is configured through tc command as described in the above manual page. User indicate “flag 2” in the command which is then parsed by taprio scheduler in net core and indicate that the command is to be offloaded to h/w. taprio then offloads the command to the
driver by calling ndo_setup_tc() ndo ops.</p>
<p>Currently driver supports only SetGateStates operation. EST operates on a repeating time interval generated by the CPTS EST function generator. Each Ethernet port has a global EST fetch RAM that can be configured as 2 buffers, each of 64 locations or one large buffer of 128 location. In 2 buffer configuration, a ping pong mechanism is used to hold the active schedule (oper) in one buffer and new (admin) command in the other.  Each 22-bit fetch command consists of a 14-bit fetch count (14 MSB’s) and an 8-bit priority fetch allow (8 LSB’s) that will be applied for the fetch count time in wireside clocks. Driver process each of the sched-entry in the offload command and update the fetch RAM.  Driver configures duration in sched-entry into the fetch count and Gate mask into the priority fetch bits of the RAM. Then configures the CPTS EST function generator to activate the schedule. Since driver uses 2 buffer configuration for fetch ram, this results in a max cycle time of ~8 msec (64 * 128 usec).</p>
<p>CPSW2g supports a configurable number of priority queues (up to 8) and needs to be switched to this mode from the default round robin mode before EST can be configured. User configures these through ethtool commands:- -L for changing number of queues and –set-priv-flags to disable round robin mode. Driver doesn’t enable EST if pf_p0_rx_ptype_rrobin privat flag is set. The flag is common for all ports, and so can’t be just overridden by taprio configuration w/o user involvement. Command fails if pf_p0_rx_ptype_rrobin is already set in the driver. Also note that –set-priv-flags ethtool can be execute only when the Ethernet interface is down. So execute ifconfig down or equivalent command before execute the ethtool command.</p>
<p>Schedule (commands) configuration depends on interface speed so driver translates the duration to the fetch count based on link speed. Each schedule can be constructed with several command entries in fetch RAM depending on interval. For example if each schedule has timer interval &lt; ~128us on 1G link then each sched consumes one command and have 1:1 mapping. When Ethernet link goes down, driver purge the configuration if link is down for more than 1 second.</p>
<p class="rubric" id="est-example-schedule">example schedule</p>
<dl class="docutils">
<dt>An example configuration with 3 schedule entries given below:-</dt>
<dd><ul class="first last simple">
<li>Uses 3 Queues (Q0-Q2). Each Q has a Gate associated in h/w. Maximum 8 Queues/Gates supported</li>
<li>2 higher priority Gates open for 125usec (Q1 and Q2) each about 10 packets</li>
<li>Q7 is the higest priority Queue and Q0 is the lowest priority</li>
<li>1 lower priority (Q0) opens remaining gates for 250 usec</li>
</ul>
</dd>
</dl>
<p>Here are the steps to configure this schedule.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#Setup interface and queue configuration
       ip link set dev eth0 down
       ethtool -L eth0 tx 3

#disable rrobin
ethtool --set-priv-flags eth0 p0-rx-ptype-rrobin off

#bring up eth0 interface
ip link set dev eth0 up
#Setup EST schedule with 3 Gates (Q0-Q2). For description of Command parameters, see manual page for taprio.
#TC0 &lt;-&gt; Q0, TC1 &lt;-&gt; Q1, and TC2 &lt;-&gt; Q2
tc qdisc replace dev eth0 parent root handle 100 taprio \
   num_tc 3 \
   map 0 0 1 2 0 0 0 0 0 0 0 0 0 0 0 0 \
   queues 1@0 1@1 1@2 \
   base-time 0000 \
   sched-entry S 4 125000 \
   sched-entry S 2 125000 \
   sched-entry S 1 250000 \
   flags 2

#Where num_tc is same as number of queues = 3, map, maps 16 priorities to one of 3 TCs, queues specify the
#Queue associated with each TC, TC0 - One queue @0, TC1 - One queue @1 and TC2 - One queue @2
# sched-entry S 4 125000
#  S - SetGateStates operation
#  4 - Bit mask showing bit 2 set (Q2/TC2)
#  125000 - 125000 nsecs (125 usecs ) duration of Gate open
#  The cycle-time is 500 msec

#enable classifier. Classifier is used to mark the packet based on packet meta data. For example UDP port
#number
tc qdisc add dev eth0 clsact

#Using tc filter command edit the SKB priority based on udp port number. i.e Udp port 5003 -&gt; prio 3 (TC2/Q2), port 5002 -&gt; prio 2 (TC1/Q1),  5001 -&gt; prio 1( TC0/Q0)
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5003 0xffff action skbedit priority 3
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 2
tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5001 0xffff action skbedit priority 1

#Network core and Driver uses the skb priority to deliver frames to specific h/w queues. In the above case,
#priority 3 SKB (packet) goes to Q2 (4th entry in map in the tc qdisc command), priority 2 SKB goes to Q1
#(3rd entry in map) and priority 1 SKB goes to Q0 (2nd entry in map)

#Run 3 iperf sessions, each with udp port 5001, 5002 and 5003 as
#Remote PC connected to eth0 with IP address 192.168.2.10
iperf3 -s -i30 -p5001&amp;
iperf3 -s -i30 -p5002&amp;
iperf3 -s -i30 -p5003&amp;

#At DUT, start trasmission of stream using iperf3
ip addr add 192.168.2.20/24 dev eth0
ip link set dev eth0 up
iperf3 -c 192.168.2.10 -u -b100M  -p 5003 -l1472 -t10 -i5&amp;
iperf3 -c 192.168.2.10 -u -b100M  -p 5002 -l1472 -t10 -i5&amp;
iperf3 -c 192.168.2.10 -u -b100M  -p 5001 -l1472 -t10 -i5&amp;

#Capture frame using wireshark at the PC to see how EST work. The frames will be on the wire only at
#scheduled time and a periodic burst of frames will be seen every 500 milli seconds.
</pre></div>
</div>
<p>A sample wireshark capture for the example above is shown below</p>
<div><img alt="../../../../../_images/wireshark-tas.jpg" src="../../../../../_images/wireshark-tas.jpg" />
</div><p>Packet highlighted are the first packet transmitted during Gate open of Q2/TC2 and are spaced apart by about 500 msec which is the cycle-time of the TAS schedule. Also there are about 9 packets transmitted during the window which is about 12 * 9 = 108 usec within the Gate open interval of 125 usec.</p>
<p class="rubric" id="est-guard-band">Guard band</p>
<p>CPSW2g EST H/W will transmit the frame during Gate open. If a frame happens to arrive at the h/w queue just before the Gate closes, it gets spilled over to the next schedule window. If this is not desirable, user may add a guard band between schedule window, duration of which should equal to the transmission time of a MTU frame (1518 * 8 = 12144 nsec) + 2336 nsec (TRM describes this as 292 wire clocks = 292 * 8 = 2336).  This ensures that frames don’t splill over to the next sched window. For example, for the example schedule described above, to ensure no spill over, guard bands may be introduced as follows:-</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>tc qdisc replace dev eth0 parent root handle 100 taprio \
   num_tc 3 \
   map 0 0 1 2 0 0 0 0 0 0 0 0 0 0 0 0 \
   queues 1@0 1@1 1@2 \
   base-time 0000 \
   sched-entry S 4 110520 \
   sched-entry S 0 14480  \
   sched-entry S 2 110520 \
   sched-entry S 0 14480  \
   sched-entry S 1 235520 \
   sched-entry S 0 14480  \
   flags 2
</pre></div>
</div>
<p>The above schedule still have a cycle-time of 500 msec, however there are guard bands inserted between Gate Close/Open and uses 0 Gate mask during the period of 12144 usec.</p>
<p class="rubric" id="est-cycle-time">cycle-time</p>
<p>In the example schedule described earlier, there are 3 schedule windows described by sched-entry, first 2 being each of 125 usec and a third of 250 usec. So the schedule has a cycle-time of 500 msec which is the sum of the intervals of individual schedule. tc command also allow user to specify cycle-time as part of the command which can be used to truncate or stretch an entry. For example in the typical schedule, if user specify cycle-time of 600000</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>tc qdisc replace dev eth0 parent root handle 100 taprio \
   num_tc 3 \
   map 0 0 1 2 0 0 0 0 0 0 0 0 0 0 0 0 \
   queues 1@0 1@1 1@2 \
   base-time 0000 \
   sched-entry S 4 110520 \
   sched-entry S 0 14480  \
   sched-entry S 2 110520 \
   sched-entry S 0 14480  \
   sched-entry S 1 235520 \
   sched-entry S 0 14480  \
   cycle-time 600000 \
   flags 2
</pre></div>
</div>
<p>In the above example, the last window gets stretched for a total of 350 usec instead of 250 usec resulting in a cycle-time of 600 usec. Similarly if the cycle-time is less than the sum of individual sched-entry, then schedule would get tructated.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>tc qdisc replace dev eth0 parent root handle 100 taprio \
   num_tc 3 \
   map 0 0 1 2 0 0 0 0 0 0 0 0 0 0 0 0 \
   queues 1@0 1@1 1@2 \
   base-time 0000 \
   sched-entry S 4 110520 \
   sched-entry S 0 14480  \
   sched-entry S 2 110520 \
   sched-entry S 0 14480  \
   sched-entry S 1 235520 \
   sched-entry S 0 14480  \
   cycle-time 400000 \
   flags 2
</pre></div>
</div>
<p>In the above case, last sched-entry will become truncated to 150 usec resulting in a cycle-time of 400 usec.  Also it takes about 16 wireside clock cycles (128 nsec) to fetch the sched-entry from the fetch ram. So that determines the minimum value of sched-entry interval. If it is less than this, packet splills over to the next window.</p>
<p class="rubric" id="est-admin-command">Admin command</p>
<dl class="docutils">
<dt>802.1Q standard describes admin as a way for operator to switch to a new schedule while there is an existing (oper) schedule running. In Linux this is done by sending another tc command while one is running. A limited admin command support is provided by driver with following constraints:-</dt>
<dd><ul class="first last simple">
<li>cycle-time of the new schedule must match that of the existing schedule</li>
<li>start-time must be in the past</li>
</ul>
</dd>
</dl>
<p class="rubric" id="est-not-supported-features">Not supported features</p>
<ul class="simple">
<li>Admin command with cycle-time different from oper schedule</li>
<li>Admin command at a future time</li>
<li>AdminCycleTimeExtension/OperCycleTimeExtension</li>
<li>Configuring of queueMaxSDUTable</li>
<li>Configuring of ConfigChange</li>
<li>Show ConfigPending status (tc command shows  Oper and Admin schedule. So if admin schedule shows up, user application may consider this as ConfigPending)</li>
<li>Show ConfigChangeError</li>
<li>Show SupportedListMax - Maximum supported is 64 sched-entries if interval is &lt; 128 usec)</li>
</ul>
</div>
<div class="section" id="intersperse-express-traffic-iet-frame-preemption-offload">
<h2>3.2.2.8.4. Intersperse Express Traffic (IET) Frame Preemption offload<a class="headerlink" href="#intersperse-express-traffic-iet-frame-preemption-offload" title="Permalink to this headline">¶</a></h2>
<p>CPSW2g h/w support Intersperse Express Traffic (IET, defined in P802.3br/D2.0 spec which later is included in IEEE 802.3 2018) Frame preemption (FPE) feature and also to allow MAC layer to Verify if the peer supports IET MAC merge layer or not. MAC merge layer is responsible for preempting the transmission of frame from a preemptible queue if there is frame waiting for transmission at a higher priority Express queue. The h/w sends an initial segment of the frame satisfying min fragment size requirement and then schedule frame from the Express queue for transmission. Finally when no more frames available at the Express queue, it will resume transmission of remaining segments of the frame of the preemptible queue which was preempted. At the peer end, the segments are re-assembled and delivered to the MAC interface.</p>
<p>IET FPE feature is configured for a port through ethtool –set-priv-flags command. Note that this is a temporary interface to allow configure IET FPE in CPSW2g driver and is not approved by netdev subsystem maintainers in Linux Kernel Mailing List (LKML) and may change in the future. Driver configures IET FPE for a port when network device is opened (ndo_open()) if user has turned ON the iet-frame-preemption priv flag. Note that since IET is a common feature applicable to all slave ports, this has to be done before the network ports of the CPSW2g are brought up. The user may also turn ON the iec-mac-verify flag if the peer device connected to CPSW2g port is also capable of verifying MAC merge/FPE capability. For this, driver schedules a worker thread to do the MAC/Verify process as soon as the Link is up and iec-mac-verify priv flag is set.  It resets the LINKFAIL bit and check if the Verify succeeds or not.  On failure, the MAC Verify state machine is reset by toggling LINKFAIL bit and process repeats for 20 times before bailing out. If iec-mac-verify priv flag is not set, driver assumes that peer is capable of supporting FPE, but not able to do MAC Verify. So it configures the device into force mode. User needs to verify that peer device is capable of supporting IET FPE to use force mode.</p>
<p>Driver assumes highest priority h/w Queue as the express Queue and configures lower queues (Q0-QN-2, where N is the maximum number of queues configured) as preemptible queues by programming the PN_REG_IET_CTRL register if the MAC Verify succeeds or if the force mode is enabled. p0-rx-ptype-rrobin flag should be turned off before using IET feature. i.e CPSW2g h/w should be programmed into strict priority mode for IET to work.</p>
<p>To enable IET FPE with MAC Verify, do</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ethtool --set-priv-flags eth0 p0-rx-ptype-rrobin off
ethtool --set-priv-flags eth0 iet-frame-preemption on
ethtool --set-priv-flags eth0 iet-mac-verify on
</pre></div>
</div>
<p>To enable IET FPE with no MAC Verify (Force mode)</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ethtool --set-priv-flags eth0 p0-rx-ptype-rrobin off
ethtool --set-priv-flags eth0 iet-frame-preemption on
</pre></div>
</div>
<p>To disable IET FPE and restore rrobin mode</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ethtool --set-priv-flags eth0 iet-frame-preemption off
ethtool --set-priv-flags eth0 iet-mac-verify off
ethtool --set-priv-flags eth0 p0-rx-ptype-rrobin on
</pre></div>
</div>
<p class="rubric" id="iet-mac-verify">Example session to enable IET FPE with MAC Verify.</p>
<p>Assume 2 AM65x IDKs are connected back to back over MCU Ethernet port (typically eth0 interface. Example assumes 2 h/w queues configured. Q1 will be express queue and Q0 the preemption queue in this configuration.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>root@am65xx-evm:~# ifconfig eth0 down
[  169.798571] am65-cpsw-nuss 46000000.ethernet eth0: Link is Down
root@am65xx-evm:~# ethtool -L eth0 tx 2
root@am65xx-evm:~# ethtool -l eth0
Channel parameters for eth0:
Pre-set maximums:
RX:             1
TX:             8
Other:          0
Combined:       0
Current hardware settings:
RX:             1
TX:             2
Other:          0
Combined:       0
@am65xx-evm:~# ethtool --set-priv-flags eth0 p0-rx-ptype-rrobin off
root@am65xx-evm:~# ethtool --set-priv-flags eth0 iet-frame-preemption on
root@am65xx-evm:~# ethtool --show-priv-flags eth0
Private flags for eth0:
p0-rx-ptype-rrobin  : off
iet-frame-preemption: on
iet-mac-verify      : off
root@am65xx-evm:~# ethtool --set-priv-flags eth0 iet-mac-verify on
root@am65xx-evm:~# ethtool --show-priv-flags eth0
Private flags for eth0:
p0-rx-ptype-rrobin  : off
iet-frame-preemption: on
iet-mac-verify      : on
root@am65xx-evm:~# ifconfig eth0 up
root@am65xx-evm:~#
root@am65xx-evm:~# [  267.393967] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
[  267.400353] am65-cpsw-nuss 46000000.ethernet eth0: Starting IET/FPE MAC Verify
[  267.465086] am65-cpsw-nuss 46000000.ethernet eth0: IET/FPE MAC Verify Success
[  267.472276] am65-cpsw-nuss 46000000.ethernet eth0: Link is Up - 1Gbps/Full - flow control off
</pre></div>
</div>
<p class="rubric" id="iet-no-mac-verify">Example session to enable IET FPE with no MAC Verify (Force mode)</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>root@am65xx-evm:~# ifconfig eth0 down
[  394.590576] am65-cpsw-nuss 46000000.ethernet eth0: Link is Down
root@am65xx-evm:~# ethtool --set-priv-flags eth0 iet-frame-preemption on
#if iet-mac-verify was enabled before, turn it off
root@am65xx-evm:~# ethtool --set-priv-flags eth0 iet-mac-verify off
root@am65xx-evm:~# ethtool --show-priv-flags eth0
Private flags for eth0:
p0-rx-ptype-rrobin  : off
iet-frame-preemption: on
iet-mac-verify      : off
root@am65xx-evm:~#
root@am65xx-evm:~# ifconfig eth0 192.168.100.20
[  500.502660] TI DP83867 46000f00.mdio:00: attached PHY driver [TI DP83867] (mii_bus:phy_addr=46000f00.mdio:00, irq=POLL)
root@am65xx-evm:~# [  500.516232] am65-cpsw-nuss 46000000.ethernet eth0: Link is Down
root@am65xx-evm:~# [  552.738077] am65-cpsw-nuss 46000000.ethernet eth0: IET Enable Force mode
[  552.744839] am65-cpsw-nuss 46000000.ethernet eth0: Link is Up - 1Gbps/Full - flow control off
[  552.753434] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready
</pre></div>
</div>
<p class="rubric" id="iep-fpe-testing">IET FPE example</p>
<p>Highest priority Queue is Express queue. i.e if there are 8 queues configured through ethtool -L command, Q7 will be express and Q0-Q6 will be preemptible. Similarly if 4 queues are configured then Q3 will be express queue and Q0-Q2 will be preemptible queues. See below an example on how to verify preemption is happening in the hardware.  Setup requires 2 IDKs (Example AM65x) connected over MCU Ethernet/CPSW2g port. Assume that IET is enabled on both IDKs as in previous sections and either Force mode or MAC Verify mode is enabled. As soon as the Link comes up, the IET FPE gets enabled. The test requires MQPRIO qdisc to be configured at the Talker DUT’e eth0 port and enable classifier to map UDP frames with specific port to be to a given traffic class. Traffic class is used as the index to direct traffic to the specific h/w queue. CPSW2g stats module provide a statistics counter for following that can be used to verify the IET FPE is functional:-</p>
<ul class="simple">
<li>iet_rx_assembly_ok - Incremenets at the receiver if re-assembly of MAC fragements are successful.</li>
<li>iet_rx_frag - Incremenets at the receiver if MAC fragments are received due to preemption</li>
<li>iet_tx_frag - Increments at the sender side if fragments are created due to frame preemption.</li>
</ul>
<p>So to test, need to have traffic at the preemption queue as well as at the express queue and use the above statistics counters to verify if fragmentation happens at the sender side and re-assembly at the receiver side. Below logs provide some example usage.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># At the Talker side
# Set up mqprio qdisc at eth0 - 2 Queues configured. Q0 - preemption queue and Q1 express queue
root@am65xx-evm:~# tc qdisc replace dev eth0 handle 100: parent root mqprio num_tc 2  map 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 queues 1@0
1@1 hw 0
root@am65xx-evm:~# tc -g class show dev eth0
+---(100:ffe1) mqprio
|    +---(100:2) mqprio
|
+---(100:ffe0) mqprio
    +---(100:1) mqprio
# Enable classifier at net core
root@am65xx-evm:~# tc qdisc add dev eth0 clsact
# Add tc filter rule to mark packet priority based on destination UDP port number - Port 5002 mapped to prio 2
# From above mqprio settings, TC at index 2 is 0. So this TC packets go to Q0
root@am65xx-evm:~# tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5002 0xffff action skbedit priority 2
[  285.576105] u32 classifier
[  285.578910]     input device check on
[  285.582640]     Actions configured
# Add tc filter rule to map packets with UDP port number - Port 5003 to prio 3
# From above mqprio settings, TC at index 3 is 1. So this TC packets go to Q1
root@am65xx-evm:~# tc filter add dev eth0 egress protocol ip prio 1 u32 match ip dport 5003 0xffff action skbedit priority 3
root@am65xx-evm:~#
root@am65xx-evm:~# ifconfig eth0 192.168.100.20

# At the Listener DUT, setup ip address and run iperf3 server session listening to port 5002 and 5003.
# ifconfig eth0 192.168.100.30
root@am65xx-evm:~# iperf3 -s -i30 -p5002&amp;
[1] 1224
root@am65xx-evm:~# iperf3 -s -i30 -p5003&amp;
-----------------------------------------------------------
Server listening on 5002
-----------------------------------------------------------
[2] 1225
-----------------------------------------------------------
Server listening on 5003
-----------------------------------------------------------
root@am65xx-evm:~#
# At Listener DUT start iperf3 client session to port 5002 and 5003
root@am65xx-evm:~# iperf3 -c 192.168.100.30 -u -b200M -l1472 -u -t30 -i30 -p5002&amp;
[1] 1050
root@am65xx-evm:~# iperf3 -c 192.168.100.30 -u -b50M -l1472 -u -t30 -i30 -p5003&amp;
[2] 1051
root@am65xx-evm:~#
root@am65xx-evm:~# warning: UDP block size 1472 exceeds TCP MSS 1448, may result in fragmentation / drops
warning: UDP block size 1472 exceeds TCP MSS 1448, may result in fragmentation / drops
Connecting to host 192.168.100.30, port 5003
Connecting to host 192.168.100.30, port 5002
[  5] local 192.168.100.20 port 60646 connected to 192.168.100.30 port 5003
[  5] local 192.168.100.20 port 39515 connected to 192.168.100.30 port 5002

# Now at the Talker DUT, dump statistics counter for Q0 and Q1 as well as IET statistics
root@am65xx-evm:~# ethtool -S eth0 | grep &#39;tx_pri1&#39;
    p0_tx_pri1: 0
    p0_tx_pri1_bcnt: 0
    p0_tx_pri1_drop: 0
    p0_tx_pri1_drop_bcnt: 0
    tx_pri1: 24869
    tx_pri1_bcnt: 37722660
    tx_pri1_drop: 0
    tx_pri1_drop_bcnt: 0
root@am65xx-evm:~# ethtool -S eth0 | grep &#39;tx_pri0&#39;
    p0_tx_pri0: 0
    p0_tx_pri0_bcnt: 0
    p0_tx_pri0_drop: 0
    p0_tx_pri0_drop_bcnt: 0
    tx_pri0: 100271
    tx_pri0_bcnt: 152067960
    tx_pri0_drop: 0
    tx_pri0_drop_bcnt: 0
root@am65xx-evm:~# ethtool -S eth0 | grep iet
    iet_rx_assembly_err: 0
    iet_rx_assembly_ok: 0
    iet_rx_smd_err: 0
    iet_rx_frag: 0
    iet_tx_hold: 0
    iet_tx_frag: 159
root@am65xx-evm:~# ethtool -S eth0 | grep &#39;tx_pri1&#39;
    p0_tx_pri1: 0
    p0_tx_pri1_bcnt: 0
    p0_tx_pri1_drop: 0
    p0_tx_pri1_drop_bcnt: 0
    tx_pri1: 27718
    tx_pri1_bcnt: 42047442
    tx_pri1_drop: 0
    tx_pri1_drop_bcnt: 0
root@am65xx-evm:~# ethtool -S eth0 | grep &#39;tx_pri0&#39;
    p0_tx_pri0: 0
    p0_tx_pri0_bcnt: 0
    p0_tx_pri0_drop: 0
    p0_tx_pri0_drop_bcnt: 0
    tx_pri0: 111637
    tx_pri0_bcnt: 169320030
    tx_pri0_drop: 0
    tx_pri0_drop_bcnt: 0
root@am65xx-evm:~# ethtool -S eth0 | grep iet
    iet_rx_assembly_err: 0
    iet_rx_assembly_ok: 0
    iet_rx_smd_err: 0
    iet_rx_frag: 0
    iet_tx_hold: 0
    iet_tx_frag: 175

# As seen, iet_tx_frag statistics counter increments at the Talker showing fragmentation at the Talker
# Also dump the statistics at the listener DUT
ethtool -S eth0 | grep iet
    iet_rx_assembly_err: 0
    iet_rx_assembly_ok: 248
    iet_rx_smd_err: 0
    iet_rx_frag: 248
    iet_tx_hold: 0
    iet_tx_frag: 0
root@am65xx-evm:~# ethtool -S eth0 | grep iet
    iet_rx_assembly_err: 0
    iet_rx_assembly_ok: 252
    iet_rx_smd_err: 0
    iet_rx_frag: 252
    iet_tx_hold: 0
    iet_tx_frag: 0
root@am65xx-evm:~# ethtool -S eth0 | grep iet
    iet_rx_assembly_err: 0
    iet_rx_assembly_ok: 252
    iet_rx_smd_err: 0
    iet_rx_frag: 252
    iet_tx_hold: 0
    iet_tx_frag: 0
# As seen, iet_rx_frag and iet_rx_assembly_ok statistics counter increments at the Listener showing re-assembly at the Listener
</pre></div>
</div>
<p class="rubric" id="iet-with-est">Using IET together with EST</p>
<p>Express and preemption queues/Gates may be used as part of the EST schedule. If only Preemption queues are in a schedule entry, preceeding an entry with Express queue, the guard band requirement reduces to 2048 nsec (0x100 = 256 * 8) so that packets don’t spill over to the next sched-entry. Otherwise, the guard band required is as explained in the EST section.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CPSW9g_virt_mac.html" class="btn btn-neutral float-right" title="3.2.2.9. CPSW9g virtual MAC (remoteproc)" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../I2C.html" class="btn btn-neutral" title="3.2.2.7. I2C" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2020</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../../',
            VERSION:'07_01_00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>