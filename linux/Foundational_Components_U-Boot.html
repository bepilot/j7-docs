

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.1. U-Boot &mdash; Processor SDK Linux for J721e Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Processor SDK Linux for J721e Documentation" href="../index.html"/>
        <link rel="up" title="3. Foundational Components" href="Foundational_Components.html"/>
        <link rel="next" title="3.2. Kernel" href="Foundational_Components_Kernel.html"/>
        <link rel="prev" title="3. Foundational Components" href="Foundational_Components.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../devices/J7/linux/index.html" class="icon icon-home"> Processor SDK Linux for J721e
          

          
          </a>

          
            
            
              <div class="version">
                07_01_00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devices/J7/linux/Release_Specific.html">2. Release Specific</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="Foundational_Components.html">3. Foundational Components</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.1. U-Boot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#u-boot-user-s-guide">3.1.1. U-Boot User’s Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">3.1.1.1. Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#general-information">3.1.1.2. General Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#usb-device-firmware-upgrade-dfu">3.1.1.3. USB Device Firmware Upgrade (DFU)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#network-wired-or-usb-client">3.1.1.4. Network (Wired or USB Client)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nand">3.1.1.5. NAND</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sd-emmc-or-usb-storage">3.1.1.6. SD, eMMC or USB Storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spi">3.1.1.7. SPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ospi-qspi">3.1.1.8. OSPI/QSPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nor">3.1.1.9. NOR</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uart">3.1.1.10. UART</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sata">3.1.1.11. SATA</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ufs">3.1.1.12. UFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ddr3-ecc">3.1.1.13. DDR3 ECC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hyperbus-and-hyperflash">3.1.1.14. HyperBus and HyperFlash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#remoteproc">3.1.1.15. REMOTEPROC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uboot-spl-debugging-tips">3.1.1.16. Uboot SPL Debugging Tips</a></li>
<li class="toctree-l4"><a class="reference internal" href="#loading-uboot-through-code-composer-studio-ccs">3.1.1.17. Loading Uboot through Code Composer Studio (CCS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#u-boot-release-notes">3.1.2. U-Boot Release Notes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-information">3.1.2.1. Build Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#known-issues">3.1.2.2. Known Issues</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#u-boot-splash-screen">3.1.3. U-Boot Splash Screen</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">3.1.4. Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_Kernel.html">3.2. Kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_Filesystem.html">3.3. Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_Tools.html">3.4. Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_IPCLLD.html">3.5. IPC Low Level Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_Graphics.html">3.6. Graphics and Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_Virtualization.html">3.7. Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_Machine_Learning.html">3.8. Machine Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_ATF.html">3.9. ARM Trusted Firmware-A</a></li>
<li class="toctree-l2"><a class="reference internal" href="Foundational_Components_OPTEE.html">3.10. OP-TEE</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="How_to_Guides.html">4. How to Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="Documentation_Tarball.html">5. Documentation Tarball</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../devices/J7/linux/index.html">Processor SDK Linux for J721e</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../devices/J7/linux/index.html">Docs</a> &raquo;</li>
      
          <li><a href="Foundational_Components.html">3. Foundational Components</a> &raquo;</li>
      
    <li>3.1. U-Boot</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <span class="target" id="foundational-components-u-boot"></span><div class="section" id="u-boot">
<h1>3.1. U-Boot<a class="headerlink" href="#u-boot" title="Permalink to this headline">¶</a></h1>
<div class="section" id="u-boot-user-s-guide">
<h2>3.1.1. U-Boot User’s Guide<a class="headerlink" href="#u-boot-user-s-guide" title="Permalink to this headline">¶</a></h2>
<div class="section" id="overview">
<h3>3.1.1.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h3>
<p>This document covers the general use of Linux Core Release of U-Boot on
following platforms:</p>
<p><strong>32-bit platforms</strong></p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.ti.com/tool/tmdxevm3358">AM335x GP EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/tmdssk3358">AM335x EVM-SK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/tmdsice3359">AM335x ICE</a></li>
<li><a class="reference external" href="http://beagleboard.org/bone">BeagleBone White</a></li>
<li><a class="reference external" href="https://beagleboard.org/black">BeagleBone Black</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/J6PEVM577P">DRA76x EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/j6evm5777">DRA74x EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/dra72xevm">DRA72x EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/product/DRA718">DRA71x EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/tmdsevm437x">AM437x GP EVM</a></li>
<li>AM43xx ePOS EVM</li>
<li><a class="reference external" href="http://www.ti.com/tool/tmdxsk437x">AM437x EVM-SK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/TMDSIDK437X">AM437x IDK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/TMDSIDK574">AM574x IDK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/tmdsevm572x">AM572x GP EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/TMDXIDK5728">AM572x IDK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/tmdxidk5718">AM571x IDK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/EVMK2H">66AK2H EVM</a></li>
<li>K2K EVM</li>
<li><a class="reference external" href="http://www.ti.com/tool/xevmk2ex">K2Ex EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/xevmk2lx">K2L EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/evmk2g">K2G GP EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/k2gice">K2G ICE EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/product/omap-l138">OMAP-L138 LCDK</a></li>
</ul>
</div></blockquote>
<p><strong>64-bit platforms</strong></p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://www.ti.com/tool/TMDX654GPEVM">AM65x EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/TMDX654IDKEVM">AM65x IDK</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/J721EXSOMXEVM">J721E EVM</a></li>
<li><a class="reference external" href="http://www.ti.com/tool/J7200XSOMXEVM">J7200 EVM</a></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="general-information">
<h3>3.1.1.2. General Information<a class="headerlink" href="#general-information" title="Permalink to this headline">¶</a></h3>
<div class="section" id="getting-the-u-boot-source-code">
<h4>3.1.1.2.1. Getting the U-Boot Source Code<a class="headerlink" href="#getting-the-u-boot-source-code" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The easiest way to get access to the U-boot source code is by
downloading and installing the Processor SDK Linux. Once installed,
the U-Boot source code is included in the SDK’s board-support
directory. For your convenience the sources also includes the U-Boot’s
git repository including commit history.</div>
<div class="line">Alternatively, U-Boot sources can directly be fetched from GIT.</div>
</div>
<blockquote>
<div></div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="build-and-boot-flow-on-32-bit-platforms">
<h4>3.1.1.2.2. Build and Boot Flow on 32-bit platforms<a class="headerlink" href="#build-and-boot-flow-on-32-bit-platforms" title="Permalink to this headline">¶</a></h4>
<p>We strongly recommend the use of separate object directories when
building. This is done with O= parameter to make. We also recommend that
you use an output directory name that is identical to the configuration
target name. That way if you are working with multiple configuration
targets it is very easy to know which folder contains the u-boot
binaries that you are interested in.</p>
<p class="rubric" id="setting-the-tool-chain-path">Setting the tool chain path</p>
<p>We strongly recommend using the toolchain that came with the Linux Core
release that corresponds to this U-Boot release. For e.g:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>export PATH=$HOME/&lt;TOOLCHAIN_PATH&gt;/bin:$PATH
</pre></div>
</div>
<p class="rubric" id="cleaning-the-sources">Cleaning the Sources</p>
<p>If you did not use a separate object directory:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ make CROSS_COMPILE=arm-linux-gnueabihf- distclean
</pre></div>
</div>
<p>If you used ‘O=am335x_evm’ as your object directory:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ rm -rf ./am335x_evm
</pre></div>
</div>
<p class="rubric" id="compiling-mlo-and-u-boot">Compiling MLO and u-boot</p>
<p>Building of both u-boot and SPL is done at the same time. You must
however first configure the build for the board you are working with.
Use the following table to determine what defconfig to use to configure
with:</p>
<table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="9%" />
<col width="15%" />
<col width="9%" />
<col width="9%" />
<col width="9%" />
<col width="14%" />
<col width="15%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Board</th>
<th class="head">SD Boot</th>
<th class="head">eMMC Boot</th>
<th class="head">NAND Boot</th>
<th class="head">UART Boot</th>
<th class="head">Ethernet Boot</th>
<th class="head">USB Ethernet Boot</th>
<th class="head">USB Host Boot</th>
<th class="head">SPI Boot</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x GP EVM</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>am335x_evm_defconfig</td>
<td>am335x_evm_defconfig</td>
<td>am335x_evm_defconfig</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AM335x EVM-SK</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>AM335x ICE</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>BeagleBone Black</td>
<td>am335x_evm_defconfig</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>BeagleBone White</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am335x_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AM437x GP EVM</td>
<td>am43xx_evm_defconfig</td>
<td>&#160;</td>
<td>am43xx_evm_defconfig</td>
<td>am43xx_evm_defconfig</td>
<td>am43xx_evm_defconfig</td>
<td>am43xx_evm_defconfig</td>
<td>am43xx_evm_usbhost_boot_defconfig</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>AM437x EVM-Sk</td>
<td>am43xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am43xx_evm_usbhost_boot_defconfig</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AM437x IDK</td>
<td>am43xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am43xx_evm_qspiboot_defconfig (XIP)</td>
</tr>
<tr class="row-even"><td>AM437x ePOS EVM</td>
<td>am43xx_evm_defconfig</td>
<td>&#160;</td>
<td>am43xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am43xx_evm_usbhost_boot_defconfig</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AM572x GP EVM</td>
<td>am57xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>am57xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>AM572x IDK</td>
<td>am57xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>AM571x IDK</td>
<td>am57xx_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>DRA74x/DRA72x/DRA71x EVM</td>
<td>dra7xx_evm_defconfig</td>
<td>dra7xx_evm_defconfig</td>
<td>dra7xx_evm_defconfig (DRA71x EVM only)</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>dra7xx_evm_defconfig(QSPI)</td>
</tr>
<tr class="row-odd"><td>K2HK EVM</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2hk_evm_defconfig</td>
<td>k2hk_evm_defconfig</td>
<td>k2hk_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2hk_evm_defconfig</td>
</tr>
<tr class="row-even"><td>K2L EVM</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2l_evm_defconfig</td>
<td>k2l_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2l_evm_defconfig</td>
</tr>
<tr class="row-odd"><td>K2E EVM</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2e_evm_defconfig</td>
<td>k2e_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2e_evm_defconfig</td>
</tr>
<tr class="row-even"><td>K2G GP EVM</td>
<td>k2g_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2g_evm_defconfig</td>
<td>k2g_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>k2g_evm_defconfig</td>
</tr>
<tr class="row-odd"><td>K2G ICE</td>
<td>k2g_evm_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>OMAP-L138 LCDK</td>
<td>omapl138_lcdk_defconfig</td>
<td>&#160;</td>
<td>omapl138_lcdk_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p>Then:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># Use &#39;am335x_evm&#39; and &#39;AM335x GP EVM&#39; in this example
$ make CROSS_COMPILE=arm-linux-gnueabihf- O=am335x_evm am335x_evm_defconfig
$ make CROSS_COMPILE=arm-linux-gnueabihf- O=am335x_evm
</pre></div>
</div>
<p>Note that not all possible build targets for a given platform are listed
here as the community has additional build targets that are not
supported by TI. To find these read the ‘boards.cfg’ file and look for
the build target listed above. And please note that the main config file
will leverage other files under include/configs, as seen by #include
statements.</p>
<p class="rubric" id="boot-flow">Boot Flow</p>
<p>Booting the Linux kernel on an embedded platform is not as simple as simply
pointing a program counter to the kernel location and letting the processor
run. This section will review the four bootloader software stages that must
be run before the kernel can be booted and run on the device.</p>
<p>Application processors such as the the AM335x are complex pieces of hardware,
but have limited internal RAM (e.g., 128KB). Because of this limited amount
of RAM, multiple bootloader stages are needed. These bootloader stages
systematically unlock the full functionality of the device so that all
complexities of the device are available to the kernel.</p>
<p>There are four distinct bootloader stages:</p>
<img alt="../_images/U-Boot_Boot_Order_32bit.png" src="../_images/U-Boot_Boot_Order_32bit.png" />
<ol class="arabic simple">
<li>ROM Code</li>
</ol>
<p>The first stage bootloader is housed in ROM on the device. The ROM code is
the first block of code that is automatically run on device start-up or
after power-on reset (POR). The ROM bootloader code is hardcoded into the
device and cannot be changed by the user. Because of this, it is important
to get an understanding of what exactly the ROM code is doing.</p>
<p>The ROM code has two main functions:</p>
<ul class="simple">
<li>Configuration of the device and initialization of primary peripherals
such as stack setup, configuring the Watchdog Timer (see TRM for details)
as well as the PLL and system clocks configuration</li>
<li>Readies the device for next bootloader by checking boot sources for next
stage of bootloader (SPL) as well as loading the actual next stage
bootloader code into memory and starting it</li>
</ul>
<p>The list of booting devices that the ROM code will search through for the
second stage bootloader is configured by the voltage levels set on the
devices SYSBOOT pins on startup. These pins also set other boot parameters
(i.e. expected crystal frequency, bus width of external memory). For more
information on the SYSBOOT pins and associated boot parameters see the
device TRM.</p>
<ol class="arabic simple" start="2">
<li>SPL or MLO</li>
</ol>
<p>The second stage bootloader is known as the SPL (Secondary Program Loader),
but is sometimes referred to as the MLO (MMC Card Loader). The SPL is the
first stage of U-Boot, and must be loaded from one of the boot sources into
internal RAM. The SPL has very limited configuration or user interaction,
and mainly serves to initialize the external DDR memory and set-up the boot
process for the next bootloader stage: U-Boot.</p>
<ol class="arabic simple" start="3">
<li>U-Boot</li>
</ol>
<p>U-Boot allows for powerful command-based control over the kernel boot
environment via a serial terminal. The user has control over a number of
parameters such as boot arguments and the kernel boot command. In addition,
U-Boot environment variables can be configured. These environment variables
are stored in the <strong>uEnv.txt</strong> file on your storage medium or directly in
a Flash-based memory if configured such. These environment variables can be
viewed, modified, and saved using the <strong>env print</strong>, <strong>env set</strong>, and
<strong>env save</strong> commands, respectively. U-Boot is also a very useful tool to
program and manipulate a wide range of external memory devices as well as
a helpful aid during custom board bringup.</p>
<ol class="arabic simple" start="4">
<li>Linux Kernel</li>
</ol>
<p><strong>zImage</strong> is the compressed kernel image wrapped with header info that
describes the kernel. This header includes the target architecture, the
operating system, kernel size, entry points, etc. The loading of the kernel
image is typically performed through the use of scripts stored in the U-Boot
environment (all starting with the <strong>bootcmd</strong> ENV variable that gets
executed after the autoboot countdown expires or manually by entering the
<strong>boot</strong> command at the U-Boot prompt). This also involves passing a board-
specific device tree blob (DTB) as an argument to U-Boot’s <strong>bootz</strong>
command that will extract and start the actual kernel.</p>
</div>
<div class="section" id="build-and-boot-flow-on-64-bit-platforms-based-on-k3-architecture">
<h4>3.1.1.2.3. Build and Boot Flow on 64-bit platforms (based on K3 architecture)<a class="headerlink" href="#build-and-boot-flow-on-64-bit-platforms-based-on-k3-architecture" title="Permalink to this headline">¶</a></h4>
<p>Several prebuilt images are required from the TI Processor SDK for building U-Boot on K3 based platforms.
Go <a class="reference external" href="Overview/Download_and_Install_the_SDK.html">here</a> to download and install the SDK.</p>
<p>TI-u-boot is included in the SDK in &lt;path to tisdk&gt;/board-support. Ensure that the u-boot version matches the
<span class="xref std std-ref">release-specific-build-information-u-boot</span>.</p>
<p class="rubric" id="setting-the-full-tool-chain-path">Setting the tool chain path</p>
<p>We strongly recommend using the toolchain that came with the Linux Core
release that corresponds to this U-Boot release. For e.g:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>export PATH=$HOME/gcc-arm-8.3-2019.03-x86_64-arm-linux-gnueabihf/bin:$PATH
export PATH=$HOME/gcc-arm-8.3-2019.03-x86_64-aarch64-linux-gnu/bin:$PATH
</pre></div>
</div>
<p class="rubric" id="compiling-r5-and-arm64-images">Compiling R5 and ARM64 images</p>
<p>Use the following table to determine what defconfig to use to configure with:</p>
<table border="1" class="docutils">
<colgroup>
<col width="15%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Board</th>
<th class="head">SD/eMMC Boot</th>
<th class="head">UART boot</th>
<th class="head">OSPI boot</th>
<th class="head">Hyper Flash</th>
<th class="head">USB DFU</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM65x EVM/IDK</td>
<td>am65x_evm_r5_defconfig
am65x_evm_a53_defconfig</td>
<td>am65x_evm_r5_defconfig
am65x_evm_a53_defconfig</td>
<td>am65x_evm_r5_defconfig
am65x_evm_a53_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><td>J721E EVM</td>
<td>j721e_evm_r5_defconfig
j721e_evm_a72_defconfig</td>
<td>j721e_evm_r5_defconfig
j721e_evm_a72_defconfig</td>
<td>j721e_evm_r5_defconfig
j721e_evm_a72_defconfig</td>
<td>j721e_evm_r5_defconfig
j721e_evm_a72_defconfig</td>
<td>j721e_evm_r5_defconfig
j721e_evm_a72_defconfig</td>
</tr>
<tr class="row-even"><td>J7200 EVM</td>
<td>j7200_evm_r5_defconfig
j7200_evm_a72_defconfig</td>
<td>j7200_evm_r5_defconfig
j7200_evm_a72_defconfig</td>
<td>&#160;</td>
<td>&#160;</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p><strong>Building Bootloader for AM65x EVM/IDK</strong></p>
<p><em>R5</em></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- am65x_evm_r5_defconfig <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/r5
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/r5
</pre></div>
</div>
<p><em>A53</em></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- am65x_evm_a53_defconfig <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/a53
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- <span class="nv">ATF</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/bl31.bin <span class="nv">TEE</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/bl32.bin <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/a53
</pre></div>
</div>
<p><strong>Building Bootloader for J721E EVM</strong></p>
<p><em>R5</em></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- j721e_evm_r5_defconfig <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/r5
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/r5
</pre></div>
</div>
<p><em>A72</em></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- j721e_evm_a72_defconfig <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/a53
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- <span class="nv">ATF</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/bl31.bin <span class="nv">TEE</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/bl32.bin <span class="nv">DM</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/ipc_echo_testb_mcu1_0_release_strip.xer5f <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/a72
</pre></div>
</div>
<p><strong>Building bootloader for J7200 EVM</strong></p>
<p><em>R5</em></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- j7200_evm_r5_defconfig <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/r5
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>arm-linux-gnueabihf- <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/r5
</pre></div>
</div>
<p><em>A72</em></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- j7200_evm_a72_defconfig <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/a53
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- <span class="nv">ATF</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/bl31.bin <span class="nv">TEE</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/bl32.bin <span class="nv">DM</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images/ipc_echo_testb_mcu1_0_release_strip.xer5f <span class="nv">O</span><span class="o">=</span>&lt;output directory&gt;/a72
<span class="gp">$</span> <span class="nb">cd</span> &lt;path to K3-image-gen project&gt;
<span class="gp">$</span> make <span class="nv">ARCH</span><span class="o">=</span>arm <span class="nv">CROSS_COMPILE</span><span class="o">=</span>aarch64-linux-gnu- <span class="nv">SOC</span><span class="o">=</span>j7200 <span class="nv">ROM_COMBINED_IMAGE</span><span class="o">=</span><span class="m">1</span> <span class="nv">SBL</span><span class="o">=</span>&lt;path to tisdk&gt;/board-support/prebuilt-images&gt;/u-boot-spl.bin
</pre></div>
</div>
<p class="rubric">Dependent Project location</p>
<ul class="simple">
<li>K3-image-gen (For generating tiboot3.bin and sysfw.itb) project is located <a class="reference external" href="https://git.ti.com/cgit/k3-image-gen/k3-image-gen">here</a></li>
<li>Linux Firmware (for device specific ti-dm and ti-sysfw binaries) project is located <a class="reference external" href="https://git.ti.com/cgit/processor-firmware/ti-linux-firmware/log/?h=ti-linux-firmware">here</a></li>
</ul>
<p class="rubric">Target Images</p>
<p>Copy the below images to the boot partition of an SD card and boot.
Instructions to format the SD card can be found <a class="reference external" href="Overview/Processor_SDK_Linux_create_SD_card_script.html">here</a>.</p>
<p><em>AM65x</em></p>
<ul class="simple">
<li>tiboot3.bin from &lt;output directory&gt;/r5</li>
<li>tispl.bin, u-boot.img from &lt;output directory&gt;/a53</li>
<li>sysfw.itb from &lt;path to tisdk&gt;/board-support/prebuilt-images/</li>
</ul>
<p><em>J721E</em></p>
<ul class="simple">
<li>tiboot3.bin from &lt;output directory&gt;/r5</li>
<li>tispl.bin, u-boot.img from &lt;output directory&gt;/a72</li>
<li>sysfw.itb from &lt;path to tisdk&gt;/board-support/prebuilt-images/</li>
</ul>
<p><em>J7200</em></p>
<ul class="simple">
<li>tiboot3.bin from &lt;path to K3-image-gen&gt; (This is combined image of tiboot3.bin and sysfw.itb)</li>
<li>tispl.bin, u-boot.img from &lt;output directory&gt;/a72</li>
</ul>
<p class="rubric">Image Formats</p>
<ul class="simple">
<li>tiboot3.bin</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">+-----------------------+</span>
<span class="go">|        X.509          |</span>
<span class="go">|      Certificate      |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |        R5         | |</span>
<span class="go">| |   u-boot-spl.bin  | |</span>
<span class="go">| |                   | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |     FIT header    | |</span>
<span class="go">| | +---------------+ | |</span>
<span class="go">| | |               | | |</span>
<span class="go">| | |   DTB 1...N   | | |</span>
<span class="go">| | +---------------+ | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">+-----------------------+</span>
</pre></div>
</div>
<ul class="simple">
<li>tispl.bin</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">+-----------------------+</span>
<span class="go">|                       |</span>
<span class="go">|       FIT HEADER      |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |      ARM64 ATF    | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |     ARM64 OPTEE   | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |      ARM64 SPL    | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |   SPL DTB 1...N   | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">+-----------------------+</span>
</pre></div>
</div>
<ul class="simple">
<li>sysfw.itb</li>
</ul>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">+-----------------------+</span>
<span class="go">|                       |</span>
<span class="go">|       FIT HEADER      |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |     sysfw.bin     | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |    board config   | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |     PM config     | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |     RM config     | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">| |                   | |</span>
<span class="go">| |    Secure config  | |</span>
<span class="go">| +-------------------+ |</span>
<span class="go">+-----------------------+</span>
</pre></div>
</div>
<p class="rubric" id="k3-boot-flow">Boot Flow</p>
<p>On K3 architecture based devices, ROM supports boot only via MCU(R5). This means that
bootloader has to run on R5 core. In order to meet this constraint, keeping
safety in picture and to have faster boot time, the software boot architecture
is designed as below:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">+------------------------------------------------------------------------+</span>
<span class="go">|        DMSC            |         R5            |        ARM64          |</span>
<span class="go">+------------------------------------------------------------------------+</span>
<span class="go">|    +--------+          |                       |                       |</span>
<span class="go">|    |  Reset |          |                       |                       |</span>
<span class="go">|    +--------+          |                       |                       |</span>
<span class="go">|         :              |                       |                       |</span>
<span class="go">|    +--------+          |   +-----------+       |                       |</span>
<span class="go">|    | *ROM*  |----------|--&gt;| Reset rls |       |                       |</span>
<span class="go">|    +--------+          |   +-----------+       |                       |</span>
<span class="go">|    |        |          |         :             |                       |</span>
<span class="go">|    |  ROM   |          |         :             |                       |</span>
<span class="go">|    |services|          |         :             |                       |</span>
<span class="go">|    |        |          |   +-------------+     |                       |</span>
<span class="go">|    |        |          |   |  *R5 ROM*   |     |                       |</span>
<span class="go">|    |        |          |   +-------------+     |                       |</span>
<span class="go">|    |        |&lt;---------|---|Load and auth|     |                       |</span>
<span class="go">|    |        |          |   | tiboot3.bin |     |                       |</span>
<span class="go">|    |        |          |   +-------------+     |                       |</span>
<span class="go">|    |        |          |         :             |                       |</span>
<span class="go">|    |        |          |         :             |                       |</span>
<span class="go">|    |        |          |         :             |                       |</span>
<span class="go">|    |        |          |   +-------------+     |                       |</span>
<span class="go">|    |        |          |   |  *R5 SPL*   |     |                       |</span>
<span class="go">|    |        |          |   +-------------+     |                       |</span>
<span class="go">|    |        |          |   |    Load     |     |                       |</span>
<span class="go">|    |        |          |   |  sysfw.itb  |     |                       |</span>
<span class="go">|    | Start  |          |   +-------------+     |                       |</span>
<span class="go">|    | System |&lt;---------|---|    Start    |     |                       |</span>
<span class="go">|    |Firmware|          |   |    SYSFW    |     |                       |</span>
<span class="go">|    +--------+          |   +-------------+     |                       |</span>
<span class="go">|        :               |   |             |     |                       |</span>
<span class="go">|    +---------+         |   |   Load      |     |                       |</span>
<span class="go">|    | *SYSFW* |         |   |   system    |     |                       |</span>
<span class="go">|    +---------+         |   | Config data |     |                       |</span>
<span class="go">|    |         |&lt;--------|---|             |     |                       |</span>
<span class="go">|    |         |         |   +-------------+     |                       |</span>
<span class="go">|    |         |         |   |             |     |                       |</span>
<span class="go">|    |         |         |   |    DDR      |     |                       |</span>
<span class="go">|    |         |         |   |   config    |     |                       |</span>
<span class="go">|    |         |         |   +-------------+     |                       |</span>
<span class="go">|    |         |         |   |             |     |                       |</span>
<span class="go">|    |         |&lt;--------|---| Start A53   |     |                       |</span>
<span class="go">|    |         |         |   |  and Reset  |     |                       |</span>
<span class="go">|    |         |         |   +-------------+     |                       |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |---------|-----------------------|----&gt;| Reset rls |     |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |  DMSC   |         |                       |          :            |</span>
<span class="go">|    |Services |         |                       |     +-----------+     |</span>
<span class="go">|    |         |&lt;--------|-----------------------|----&gt;|*ATF/OPTEE*|     |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |         |                       |          :            |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |&lt;--------|-----------------------|----&gt;| *A53 SPL* |     |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |         |                       |     |   Load    |     |</span>
<span class="go">|    |         |         |                       |     | u-boot.img|     |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |         |                       |          :            |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |&lt;--------|-----------------------|----&gt;| *U-Boot*  |     |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    |         |         |                       |     |  prompt   |     |</span>
<span class="go">|    |         |         |                       |     +-----------+     |</span>
<span class="go">|    +---------+         |                       |                       |</span>
<span class="go">|                        |                       |                       |</span>
<span class="go">+------------------------------------------------------------------------+</span>
</pre></div>
</div>
<p>Here DMSC acts as master and provides all the critical services. R5/ARM64
requests DMSC to get these services done as shown in the above diagram.</p>
</div>
<div class="section" id="u-boot-environment">
<h4>3.1.1.2.4. U-Boot Environment<a class="headerlink" href="#u-boot-environment" title="Permalink to this headline">¶</a></h4>
<p>Please note that on many boards we modify the environment during system
start for a variety of variables such as <strong>board_name</strong> and if unset,
<strong>ethaddr</strong>. When we restore defaults some variables will become unset,
and this can lead to other things not working such as <strong>findfdt</strong> that
rely on these run-time set variables.</p>
<p class="rubric" id="restoring-defaults">Restoring defaults</p>
<p>It is possible to reset the set of U-Boot environment variables to their
defaults and if desired, save them to where the environment is stored,
if applicable. It is also required to restore the default setting when
u-boot version changes from an upgrade or downgrade. To do so, issue the
following commands:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # env default -f -a
U-Boot # saveenv
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric" id="networking-environment">Networking Environment</p>
<p>When using a USB-Ethernet dongle a valid MAC address must be set in the
environment. To create a valid address please read <a class="reference external" href="http://www.denx.de/wiki/view/DULG/WhereCanIGetAValidMACAddress">**this
page**</a>.
Then issue the following command:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv usbethaddr value:from:link:above
</pre></div>
</div>
<p>You can use the <strong>printenv</strong> command to see if <strong>usbethaddr</strong> is already
set.</p>
<p>Then start the USB subsystem:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # usb start
</pre></div>
</div>
<p>The default behavior of U-Boot is to utilize all information that a DHCP
server passes to us when the user issues the <strong>dhcp</strong> command. This will
include the dhcp parameter <em>next-server</em> which indicates where to fetch
files from via TFTP. There may be times however where the dhcp server on
your network provides incorrect information and you are unable to modify
the server. In this case the following steps can be helpful:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv autoload no
U-Boot # dhcp
U-Boot # setenv serverip correct.server.ip
U-Boot # tftp
</pre></div>
</div>
<p>Another alternative is to utilize the full syntax of the tftp command:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv autoload no
U-Boot # dhcp
U-Boot # tftp ${loadaddr} server.ip:fileName
</pre></div>
</div>
</div>
<div class="section" id="available-ram-for-image-download">
<h4>3.1.1.2.5. Available RAM for image download<a class="headerlink" href="#available-ram-for-image-download" title="Permalink to this headline">¶</a></h4>
<p>To know the amount of RAM available for downloading images or for other
usage, use <code class="docutils literal"><span class="pre">bdinfo</span></code> command.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; bdinfo
arch_number = 0x00000000
boot_params = 0x80000100
DRAM bank   = 0x00000000
-&gt; start    = 0x80000000
-&gt; size     = 0x7F000000
baudrate    = 115200 bps
TLB addr    = 0xFEFF0000
relocaddr   = 0xFEF30000
reloc off   = 0x7E730000
irq_sp      = 0xFCEF8880
sp start    = 0xFCEF8870
Early malloc usage: 890 / 2000
</pre></div>
</div>
<p>After booting, U-Boot relocates itself (along with its various reserved
RAM areas) and places itself at end of available RAM (starting at
<code class="docutils literal"><span class="pre">relocaddr</span></code> in <code class="docutils literal"><span class="pre">bdinfo</span></code> output above). Only the stack is located
just before that area. The address of top of the stack is in
<code class="docutils literal"><span class="pre">sp</span> <span class="pre">start</span></code> in <code class="docutils literal"><span class="pre">bdinfo</span></code> output and it grows downwards. Users should
reserve at least about 1MB for stack, so in the example output above,
RAM in the range of <code class="docutils literal"><span class="pre">[0x80000000,</span> <span class="pre">0xFCE00000]</span></code> is safely available for
use.</p>
</div>
<div class="section" id="device-trees">
<h4>3.1.1.2.6. Device Trees<a class="headerlink" href="#device-trees" title="Permalink to this headline">¶</a></h4>
<p>A note about device trees. Now all supported boards are required to use a
device tree to boot. To facilitate this in supported platforms, a command
in U-Boot environment <strong>findfdt</strong> is available that will set the <strong>fdtfile</strong>
variable to the name of the device tree to use, as found with the kernel
sources. In the Keystone-2 family devices (K2H/K/E/L/G), it is specified
by <strong>name_fdt</strong> variable for each platform. The device tree is expected
to be loaded from the same media as the kernel, and from the same relative path.</p>
</div>
</div>
<div class="section" id="usb-device-firmware-upgrade-dfu">
<h3>3.1.1.3. USB Device Firmware Upgrade (DFU)<a class="headerlink" href="#usb-device-firmware-upgrade-dfu" title="Permalink to this headline">¶</a></h3>
<p>When working with USB Device Firmware Upgrade (DFU), regardless of the
medium to be written to and of the board being used, there are some
general things to keep in mind. First of all, you will need to get a
copy of the <strong>dfu-util</strong> program installed on your host. If your
distribution does not provide this package you will need to build it
from source. Second, the examples that follow assume a single board is
plugged into the host PC. If you have more than one device plugged in
you will need to use the options that <strong>dfu-util</strong> provides for
specifying a single device to work with. Finally, to program via DFU for
a given storage device see the section for the storage device you are
working with.</p>
<div class="section" id="usb-peripheral-boot-mode-spl-dfu-support">
<h4>3.1.1.3.1. USB Peripheral boot mode (SPL-DFU support)<a class="headerlink" href="#usb-peripheral-boot-mode-spl-dfu-support" title="Permalink to this headline">¶</a></h4>
<p>The USB Peripheral boot mode is used to boot using USB
interface using SPL-DFU feature. Steps outlined here can be used on
platform that support USB Peripheral boot mode.</p>
<ol class="arabic simple">
<li>Enable the SPL-DFU feature in u-boot and build MLO/u-boot binaries.</li>
<li>Load the MLO and u-boot.img using the dfu-util from host PC.</li>
<li>Once the u-boot is up, use DFU command from u-boot to flash the
binary images from Host PC (using dfu-utils tool) to the eMMC, or
QSPI to fresh/factory boards.</li>
</ol>
<ul class="simple">
<li>Example provided here is for dra7xx platform.</li>
<li>Use default “dra7xx_evm_defconfig” to build spl/u-boot-spl.bin,
u-boot.img.</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>host$ make dra7xx_evm_defconfig
host$ make menuconfig

select SPL/DFU support
menuconfig-&gt;SPL/TPL---&gt;
   ..
   [*] Support booting from RAM
   [*] Support USB Gadget drivers
   [ ]    Support USB Ethernet drivers
   [*]    Support DFU (Device Firmware Upgrade)
             DFU device selection (RAM device) --&gt;
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>Unselect CONFIG_HUSH_PARSER
menuconfig---&gt;Command Line interface
   [*] Support U-boot commands
   [ ]   Use hush shell
</pre></div>
</div>
<ul class="simple">
<li>Build spl/u-boot-spl.bin and u-boot.img</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>host$ make
</pre></div>
</div>
<p class="rubric" id="dfu-j721e">USB Peripheral boot mode on J721E EVM (SPL-DFU boot mode)</p>
<ul class="simple">
<li>Set SYSBOOT switches to USB Peripheral boot mode (Refer to <strong>Initialization</strong> chapter of J721E TRM for boot switch details)</li>
<li>Make sure USB0 port in UFP/DRP mode: SW3[3:4] = 01 or 1x</li>
<li>Connect EVM’s TypeC port (USB0 port) to PC through USB cable</li>
<li>Power on the board</li>
</ul>
<p>On host side:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>host$ sudo dfu-util -l
</pre></div>
</div>
<p>This will show the following DFU entities:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Found DFU: [0451:6163] ver=0200, devnum=50, cfg=1, intf=0, path=&quot;3-2&quot;, alt=1, name=&quot;SocId&quot;, serial=&quot;01.00.00.00&quot;
Found DFU: [0451:6163] ver=0200, devnum=50, cfg=1, intf=0, path=&quot;3-2&quot;, alt=0, name=&quot;bootloader&quot;, serial=&quot;01.00.00.00&quot;
</pre></div>
</div>
<p>Send boot images in this order: tiboot3.bin -&gt; sysfw.itb -&gt; tispl.bin -&gt; u-boot.img.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>host$  sudo dfu-util -R -a bootloader -D tiboot3.bin
host$ sudo dfu-util -l

Found DFU: [0451:6163] ver=0224, devnum=51, cfg=1, intf=0, path=&quot;3-2&quot;, alt=0, name=&quot;sysfw.itb&quot;, serial=&quot;UNKNOWN&quot;

host$ sudo dfu-util -R -a sysfw.itb -D sysfw.itb
host$ sudo dfu-util -l

Found DFU: [0451:6163] ver=0224, devnum=52, cfg=1, intf=0, path=&quot;3-2&quot;, alt=1, name=&quot;u-boot.img&quot;, serial=&quot;UNKNOWN&quot;
Found DFU: [0451:6163] ver=0224, devnum=52, cfg=1, intf=0, path=&quot;3-2&quot;, alt=0, name=&quot;tispl.bin&quot;, serial=&quot;UNKNOWN&quot;

host$ sudo dfu-util -R -a tispl.bin -D tispl.bin
host$ sudo dfu-util -R  -a u-boot.img -D u-boot.img
</pre></div>
</div>
<p>At this point, the board should boot to the U-Boot prompt.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This mode is not supported on J721E Rev E2 and earlier boards.</p>
</div>
</div>
</div>
<div class="section" id="network-wired-or-usb-client">
<h3>3.1.1.4. Network (Wired or USB Client)<a class="headerlink" href="#network-wired-or-usb-client" title="Permalink to this headline">¶</a></h3>
<p>This section documents how to configure the network and use it to load
files and then boot the Linux Kernel using a root filesystem mounted
over NFS. At this time, no special builds of U-Boot are required to
perform these operations on the supported hardware.</p>
<div class="section" id="booting-u-boot-from-the-network">
<h4>3.1.1.4.1. Booting U-Boot from the network<a class="headerlink" href="#booting-u-boot-from-the-network" title="Permalink to this headline">¶</a></h4>
<p>In some cases we support loading SPL and U-Boot over the network because
of ROM support. In some cases, a special build of U-Boot may be
required. In addition, the DHCP server is needed to reply to the target
with the file to fetch via tftp. In order to facilitate this, the
<strong>vendor-class-identifier</strong> DHCP field is filled out by the ROM and the
values are listed in the table below. Finally, you will need to use the
<strong>spl/u-boot-spl.bin</strong> and <strong>u-boot.img</strong> files to boot.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Booting U-Boot/SPL from network is supported only on the following platforms.</p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="8%" />
<col width="21%" />
<col width="30%" />
<col width="21%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Board</th>
<th class="head">make target</th>
<th class="head">Supported interfaces</th>
<th class="head">ROM vendor-class-identifier value</th>
<th class="head">SPL vendor-class-identifier value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x GP EVM</td>
<td>am335x_evm</td>
<td>CPSW ethernet</td>
<td>DM814x ROM (PG1.0) or AM335x ROM (PG2.0 and later)</td>
<td>AM335x U-Boot SPL</td>
</tr>
<tr class="row-odd"><td>AM335x GP EVM (PG2.0 and later)</td>
<td>am335x_evm</td>
<td>SPL and U-Boot via USB RNDIS</td>
<td>AM335x ROM</td>
<td>AM335x U-Boot SPL</td>
</tr>
<tr class="row-even"><td>AM335x GP EVM (PG1.0)</td>
<td>am335x_evm</td>
<td>SPL via UART, U-Boot via USB RNDIS</td>
<td>N/A</td>
<td>AM335x U-Boot SPL</td>
</tr>
<tr class="row-odd"><td>AM43xx EVM</td>
<td>am43xx_evm</td>
<td>CPSW ethernet</td>
<td>AM43xx ROM</td>
<td>AM43xx U-Boot SPL</td>
</tr>
<tr class="row-even"><td>AM43xx EVM (PG1.2 and later)</td>
<td>am43xx_evm</td>
<td>SPL and U-Boot via USB RNDIS</td>
<td>AM43xx ROM</td>
<td>AM43xx U-Boot SPL</td>
</tr>
</tbody>
</table>
<p>If using ISC dhcpd an example host entry would look like this:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>host am335x_evm {
  hardware ethernet de:ad:be:ee:ee:ef;
  # Check for PG1.0, typically CPSW
  if substring (option vendor-class-identifier, 0, 10) = &quot;DM814x ROM&quot; {
    filename &quot;u-boot-spl.bin&quot;;
  # Check for PG2.0, CPSW or USB RNDIS
  } elsif substring (option vendor-class-identifier, 0, 10) = &quot;AM335x ROM&quot; {
    filename &quot;u-boot-spl.bin&quot;;
  } elsif substring (option vendor-class-identifier, 0, 17) = &quot;AM335x U-Boot SPL&quot; {
    filename &quot;u-boot.img&quot;;
  } else {
    filename &quot;zImage-am335x-evm.bin&quot;;
  }
}
</pre></div>
</div>
<p>Note that in a factory type setting, the substring tests can be done
inside of the subnet declaration to set the default filename value for
the subnet, and overriden (if needed) in a host entry.</p>
<p>If you have removed NetworkManager from your system (which is not the
default in most distributions) you need to configure your
/etc/network/interfaces file thusly:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>allow-hotplug usb0
iface usb0 inet static
        address 192.168.1.1
        netmask 255.255.255.0
        post-up service isc-dhcp-server reload
</pre></div>
</div>
<p>If you are using NetworkManager you need to create two files. First, as
root create /etc/NetworkManager/system-connections/AM335x USB RNDIS (and
use \ to escape the space) with the following content:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>[802-3-ethernet]
duplex=full
mac-address=AA:BB:CC:11:22:33

[connection]
id=AM335X USB RNDIS
uuid=INSERT THE CONTENTS OF &#39;uuidgen&#39; HERE
type=802-3-ethernet

[ipv6]
method=ignore

[ipv4]
method=manual
addresses1=192.168.1.1;16;
</pre></div>
</div>
<p>Seccond as root, and ensuring execute permissions, create
/etc/NetworkManager/dispatcher.d/99am335x-dhcp-server</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#!/bin/sh

IF=$1
STATUS=$2

if [ &quot;$IF&quot; = &quot;usb0&quot; ] &amp;&amp; [ &quot;$STATUS&quot; = &quot;up&quot; ]; then
    service isc-dhcp-server reload
fi
</pre></div>
</div>
<p>A walk through of these steps can be seen at <a class="reference external" href="http://processors.wiki.ti.com/index.php/Ubuntu_12.04_Set_Up_to_Network_Boot_an_AM335x_Based_Platform">Ubuntu 12.04 Set Up to
Network Boot an AM335x Based
Platform</a>.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="multiple-interfaces">
<h4>3.1.1.4.2. Multiple Interfaces<a class="headerlink" href="#multiple-interfaces" title="Permalink to this headline">¶</a></h4>
<p>On some boards, for example when we have both a wired interface and USB
RNDIS gadget ethernet, it can be desirable to change from the default
U-Boot behavior of cycling over each interface it knows to telling
U-Boot to use a single interface. For example, on start you may see
lines like:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Net:   cpsw, usb_ether
</pre></div>
</div>
<p>So to ensure that we use <strong>usb_ether</strong> first issue the following
command:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv ethact usb_ether
</pre></div>
</div>
</div>
<div class="section" id="network-configuration-via-dhcp">
<h4>3.1.1.4.3. Network configuration via DHCP<a class="headerlink" href="#network-configuration-via-dhcp" title="Permalink to this headline">¶</a></h4>
<p>To configure the network via DHCP, use the following commands:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv autoload no
U-Boot # dhcp
</pre></div>
</div>
<p>And ensure that a DHCP server is configured to serve addresses for the
network you are connected to.</p>
</div>
<div class="section" id="manual-network-configuration">
<h4>3.1.1.4.4. Manual network configuration<a class="headerlink" href="#manual-network-configuration" title="Permalink to this headline">¶</a></h4>
<p>To configure the network manually, the <strong>ipaddr</strong>, <strong>serverip</strong>,
<strong>gatewayip</strong> and <strong>netmask</strong>:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv ipaddr 192.168.1.2
U-Boot # setenv serverip 192.168.1.1
U-Boot # setenv gatewayip 192.168.1.1
U-Boot # setenv netmask 255.255.255.0
</pre></div>
</div>
</div>
<div class="section" id="disabling-gigabit-phy-advertising">
<h4>3.1.1.4.5. Disabling Gigabit Phy Advertising<a class="headerlink" href="#disabling-gigabit-phy-advertising" title="Permalink to this headline">¶</a></h4>
<p>On some boards like DRA72x Rev B or earlier, there is an issue like
ethernet doesn’t connect to 1Gbps switch. This issue is due to the use
of an old ti phy with history of bad behaviour, due to this several J6
EVMs have been marked 100M only. So here is the U-Boot command to
disable phy’s 1Gbps support and connect as 100Mbps max capable.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; mii modify 0x3 0x9 0x0 0x300      /* Disable Gigabit advertising */
=&gt; mii modify 0x3 0x0 0x0 0x1000     /* Disable Auto Negotiation */
=&gt; mii modify 0x3 0x0 0x1000 0x1000  /* Enable Auto Negotiation */
</pre></div>
</div>
</div>
<div class="section" id="booting-linux-from-the-network">
<h4>3.1.1.4.6. Booting Linux from the network<a class="headerlink" href="#booting-linux-from-the-network" title="Permalink to this headline">¶</a></h4>
<p>Within the default environment for each board that supports networking
there is a boot command called <strong>netboot</strong> in AM EVMs and <strong>boot=net</strong>
in KS2 EVMs that will automatically load the kernel and boot. For the
exact details of each use <strong>printenv</strong> on the <strong>netboot</strong> variable and
then in turn <strong>printenv</strong> other sub-sections of the command. The most
important variables in AM57x/DRA7x are <strong>rootpath</strong> and <strong>nfsopts</strong>,
and <strong>tftp_root</strong> and <strong>nfs_root</strong> in K2H/K/E/L/G.</p>
<p>On AM65x GP and IDK boards, Linux kernel can be booted over PRU-ICSSG
Ethernet port as well. In the release u-boot image, only first port
(MII port 0)    of ICSSG0, ICSSG1 and ICSSG2 are enabled. To use
second port (MII port 1), user needs to edit the DTS file to enable
second port instead of first port and rebuild u-boot images using the
updated DTS file.  First port is marked as Eth0 on base board (ICSSG2),
Eth0 (ICSSG0) and Eth2 (ICSSG1) on IDK Application board. User needs
to load and run pru/rtu firmware on ICSSG using env script as shown
below before doing network operations such as dhcp, tftp over ICSSG
ports. The firmware is loaded from the rootfs/lib/firmware/ti-pruss/
folder for this purpose. For more information on using rproc/RemoteProc
in Uboot, see section <a class="reference external" href="Foundational_Components_U-Boot.html#remoteproc">here</a>.
A sample U-Boot env script for AM65x EVM/IDK is shown below for ICSSG0,
ICSSG1 and ICSSG2. User needs to customize the serverip and bootdir
env variable to that of the tftp server used in the setup.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently only 100Mbps and 1Gbps Full Duplex (FD) links are supported for ICSSG ports. Linux Kernel boot with NFS rootfs over PRUETH Ethernet interface has not been validated.</p>
</div>
<p>ICSSG0 port 0</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>setenv start_icssg0 &#39;rproc start 2; rproc start 3&#39;
setenv stop_icssg0 &#39;rproc stop 2; rproc stop 3&#39;
setenv firmware_dir &#39;/lib/firmware/ti-pruss&#39;
setenv get_fdt_net &#39;run start_icssg0; tftp ${fdtaddr} ${serverip}:${bootdir}/${name_fdt}; run stop_icssg0&#39;
setenv get_kern_net &#39;run start_icssg0; tftp ${loadaddr} ${serverip}:${bootdir}/${name_kern}; run stop_icssg0&#39;
setenv get_overlay_net &#39;fdt address ${fdtaddr};fdt resize 0x0fffff;for overlay in $overlay_files;do; run start_icssg0; \
        tftp ${overlayaddr} ${bootdir}/${overlay};fdt apply ${overlayaddr}; run stop_icssg0; done;&#39;
setenv get_firmware_mmc &#39;load mmc ${bootpart} ${loadaddr} ${firmware_dir}/${firmware_file}&#39;
setenv serverip 158.218.113.14
setenv bootdir 06.02.00.58-am6
setenv name_fdt k3-am654-base-board.dtb
setenv name_kern Image-am65xx-evm.bin
setenv overlay_files &#39;k3-am654-idk.dtbo k3-am654-pcie-usb2.dtbo&#39;
setenv init_icssg0 &#39;setenv ethact pruss0_eth; setenv autoload no; rproc init; setenv loadaddr 0x80000000; \
        setenv firmware_file &#39;am65x-pru0-prueth-fw.elf&#39;; run get_firmware_mmc;  rproc load 2 0x80000000 13040; rproc start 2; \
        setenv loadaddr 0x89000000; setenv firmware_file am65x-rtu0-prueth-fw.elf; run get_firmware_mmc; rproc load 3 0x89000000 5676; \
        rproc start 3; dhcp; run stop_icssg0;&#39;
setenv bootcmd &#39;run init_mmc; run init_icssg0; run get_kern_net; run get_fdt_net ; run get_overlay_net ; run run_kern&#39;
saveenv
boot
</pre></div>
</div>
<p>ICSSG1 port 0</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>setenv start_icssg1 &#39;rproc start 6; rproc start 7&#39;
setenv stop_icssg1 &#39;rproc stop 6; rproc stop 7&#39;
setenv firmware_dir &#39;/lib/firmware/ti-pruss&#39;
setenv get_fdt_net &#39;run start_icssg1; tftp ${fdtaddr} ${serverip}:${bootdir}/${name_fdt}; run stop_icssg1&#39;
setenv get_kern_net &#39;run start_icssg1; tftp ${loadaddr} ${serverip}:${bootdir}/${name_kern}; run stop_icssg1&#39;
setenv get_overlay_net &#39;fdt address ${fdtaddr};fdt resize 0x0fffff;for overlay in $overlay_files;do; run start_icssg1; \
      tftp ${overlayaddr} ${bootdir}/${overlay};fdt apply ${overlayaddr}; run stop_icssg1; done;&#39;
setenv get_firmware_mmc &#39;load mmc ${bootpart} ${loadaddr} ${firmware_dir}/${firmware_file}&#39;
setenv serverip 158.218.113.14
setenv bootdir 06.02.00.58-am6
setenv name_fdt k3-am654-base-board.dtb
setenv name_kern Image-am65xx-evm.bin
setenv overlay_files &#39;k3-am654-idk.dtbo k3-am654-pcie-usb2.dtbo&#39;
setenv init_icssg1 &#39;setenv ethact pruss1_eth; setenv autoload no; rproc init; setenv loadaddr 0x80000000; \
      setenv firmware_file &#39;am65x-pru0-prueth-fw.elf&#39;; run get_firmware_mmc;  rproc load 6 0x80000000 13040; rproc start 6; \
      setenv loadaddr 0x89000000; setenv firmware_file am65x-rtu0-prueth-fw.elf; run get_firmware_mmc; rproc load 7 0x89000000 5676; \
      rproc start 7; dhcp; run stop_icssg1;&#39;
setenv bootcmd &#39;run init_mmc; run init_icssg1; run get_kern_net; run get_fdt_net ; run get_overlay_net ; run run_kern&#39;
saveenv
boot
</pre></div>
</div>
<p>ICSSG2 port 0</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>setenv start_icssg2 &#39;rproc start 10; rproc start 11&#39;
setenv stop_icssg2 &#39;rproc stop 10; rproc stop 11&#39;
setenv firmware_dir &#39;/lib/firmware/ti-pruss&#39;
setenv get_fdt_net &#39;run start_icssg2; tftp ${fdtaddr} ${serverip}:${bootdir}/${name_fdt}; run stop_icssg2&#39;
setenv get_kern_net &#39;run start_icssg2; tftp ${loadaddr} ${serverip}:${bootdir}/${name_kern}; run stop_icssg2&#39;
setenv get_overlay_net &#39;fdt address ${fdtaddr};fdt resize 0x0fffff;for overlay in $overlay_files;do; run start_icssg2; \
     tftp ${overlayaddr} ${bootdir}/${overlay};fdt apply ${overlayaddr}; run stop_icssg2; done;&#39;
setenv get_firmware_mmc &#39;load mmc ${bootpart} ${loadaddr} ${firmware_dir}/${firmware_file}&#39;
setenv serverip 158.218.113.14
setenv bootdir 06.02.00.58-am6
setenv name_fdt k3-am654-base-board.dtb
setenv name_kern Image-am65xx-evm.bin
setenv overlay_files &#39;k3-am654-idk.dtbo k3-am654-pcie-usb2.dtbo&#39;
setenv init_icssg2 &#39;setenv ethact pruss2_eth; setenv autoload no; rproc init; setenv loadaddr 0x80000000; \
     setenv firmware_file &#39;am65x-pru0-prueth-fw.elf&#39;; run get_firmware_mmc;  rproc load 10 0x80000000 13040; rproc start 10; \
     setenv loadaddr 0x89000000; setenv firmware_file am65x-rtu0-prueth-fw.elf; run get_firmware_mmc; rproc load 11 0x89000000 5676; \
     rproc start 11; dhcp; run stop_icssg2;&#39;
setenv bootcmd &#39;run init_mmc; run init_icssg2; run get_kern_net; run get_fdt_net ; run get_overlay_net ; run run_kern&#39;
saveenv
boot
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To boot over second port (MII port 1) of ICSSG2, user needs to edit arch/arm/dts/k3-am654-base-board-u-boot.dtsi in the U-Boot source tree. See DTS file for instruction. For example, user needs to comment pruss2_emac0 DT node and uncomment pruss2_emac1 node. Similarly to enable second port for ICSSG0 and ICSSG1, user needs to edit arch/arm/dts/k3-am654-idk.dtso and enable pruss0_emac1 and pruss1_emac1 nodes respectives. After this rebuild u-boot images and use it. Port 1 is marked as by Eth1 on on base board (ICSSG2), Eth1 (ICSSG0) and Eth3 (ICSSG1) on IDK Application board.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="nand">
<h3>3.1.1.5. NAND<a class="headerlink" href="#nand" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">NAND is not supported on J721E platform.</p>
</div>
<p>This section documents how to write files to the NAND device and use it
to load and then boot the Linux Kernel using a root filesystem also
found on NAND.</p>
<div class="section" id="erasing-reading-and-writing-to-from-nand-partitions">
<h4>3.1.1.5.1. Erasing, Reading and Writing to/from NAND partitions<a class="headerlink" href="#erasing-reading-and-writing-to-from-nand-partitions" title="Permalink to this headline">¶</a></h4>
<p class="rubric" id="listing-nand-partitions">Listing NAND partitions</p>
<p>Below command is used to see the list of mtd devices enabled in U-boot</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>mtdparts
</pre></div>
</div>
<p>Example output on DRA71x EVM:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>device nand0 &lt;nand.0&gt;, # parts = 10
 #: name                size            offset          mask_flags
 0: NAND.SPL            0x00020000      0x00000000      0
 1: NAND.SPL.backup1    0x00020000      0x00020000      0
 2: NAND.SPL.backup2    0x00020000      0x00040000      0
 3: NAND.SPL.backup3    0x00020000      0x00060000      0
 4: NAND.u-boot-spl-os  0x00040000      0x00080000      0
 5: NAND.u-boot         0x00100000      0x000c0000      0
 6: NAND.u-boot-env     0x00020000      0x001c0000      0
 7: NAND.u-boot-env.backup10x00020000   0x001e0000      0
 8: NAND.kernel         0x00800000      0x00200000      0
 9: NAND.file-system    0x0f600000      0x00a00000      0
</pre></div>
</div>
<p>Note: In later sections the &lt;partition name&gt; symbol should be replaced
with the partition name seen when executing the mtdparts command.</p>
<p class="rubric" id="erasing-partition">Erasing Partition</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>nand erase.part &lt;partition name&gt;
</pre></div>
</div>
<p class="rubric" id="writing-to-partition">Writing to Partition</p>
<p>When writing to NAND partition the file to be written must have
previously been copied to memory.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>nand write &lt;ddr address&gt; &lt;partition name&gt; &lt;file size&gt;
</pre></div>
</div>
<p>The symbol &lt;ddr address&gt; refers to the location in memory that a file
was read into DDR memory. The symbol &lt;file size&gt; represents the amount
of bytes (in hex) of the file to write into the NAND partition. Note:
When reading a file into DDR, U-boot by default sets the value of
environment variable “filesize” to the number of bytes (in hex) that was
read via the last read/load command.</p>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">As an example below shows the process of writing a kernel (zImage)
into the NAND’s kernel partition. The zImage to be written is loaded
from the SD card’s rootfs (2nd) partition. Loading zImage from MMC to
DDR memory</div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc dev 0;
U-Boot # setenv devnum 0
U-Boot # setenv devtype mmc
U-Boot # mmc rescan
U-Boot # load ${devtype} 1:2 ${loadaddr} /boot/zImage
</pre></div>
</div>
<p>Now that zImage is loaded into memory time to write it into the NAND
partition</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # nand erase.part NAND.kernel
U-Boot # nand write ${loadaddr} NAND.kernel ${filesize}
</pre></div>
</div>
<p class="rubric" id="reading-from-partition">Reading from Partition</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>nand read &lt;ddr address&gt; &lt;partition name&gt;
</pre></div>
</div>
<p>The symbol &lt;ddr address&gt; should be replaced with the location in DDR
that you want the contents of the NAND partition to be copied to. The
symbol &lt;partition name&gt; contains the NAND partition name you want to
read from.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="writing-to-nand-via-dfu">
<h4>3.1.1.5.2. Writing to NAND via DFU<a class="headerlink" href="#writing-to-nand-via-dfu" title="Permalink to this headline">¶</a></h4>
<p>Currently in boards that support using DFU, the default build supports
writing to NAND, so no custom build is required. To see the list of
available places to write to (in DFU terms, altsettings) use the
<strong>mtdparts</strong> command to list the known MTD partitions and <strong>printenv
dfu_alt_settings</strong> to see how they are mapped and exposed to
<strong>dfu-util</strong>.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mtdparts

device nand0 &lt;nand0&gt;, # parts = 8
 #: name                size            offset          mask_flags
 0: NAND.SPL            0x00020000      0x00000000      0
 1: NAND.SPL.backup1    0x00020000      0x00020000      0
 2: NAND.SPL.backup2    0x00020000      0x00040000      0
 3: NAND.SPL.backup3    0x00020000      0x00060000      0
 4: NAND.u-boot         0x001e0000      0x00080000      0
 5: NAND.u-boot-env     0x00020000      0x00260000      0
 6: NAND.kernel         0x00500000      0x00280000      0
 7: NAND.file-system    0x0f880000      0x00780000      0

active partition: nand0,0 - (SPL) 0x00080000 @ 0x00000000
U-Boot # printenv dfu_alt_info_nand
dfu_alt_info=NAND.SPL part 0 1;NAND.SPL.backup1 part 0 2;NAND.SPL.backup2 part 0 3;NAND.SPL.backup3 part 0 4;NAND.u-boot part 0 5;NAND.kernel part 0 7;NAND.file-system part 0 8
</pre></div>
</div>
<p>This means that you can tell dfu-util to write anything to any of:</p>
<ul class="simple">
<li>NAND.SPL</li>
<li>NAND.SPL.backup1</li>
<li>NAND.SPL.backup2</li>
<li>NAND.SPL.backup3</li>
<li>NAND.u-boot</li>
<li>NAND.kernel</li>
<li>NAND.file-system</li>
</ul>
<p>Before writing you must erase at least the area to be written to. Then
to start DFU on the target on the first NAND device:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # nand erase.chip
U-Boot # setenv dfu_alt_info ${dfu_alt_info_nand}
U-Boot # dfu 0 nand 0
</pre></div>
</div>
<p>Then on the host PC to write <strong>MLO</strong> to the first SPL partition:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sudo dfu-util -D MLO -a NAND.SPL
</pre></div>
</div>
</div>
<div class="section" id="nand-boot">
<h4>3.1.1.5.3. NAND Boot<a class="headerlink" href="#nand-boot" title="Permalink to this headline">¶</a></h4>
<p>If you want to load and run U-Boot from NAND the first step is insuring
that the appropriate U-boot files are loaded in the correct partition.
For AM335x, AM437x, DRA7x devices this means writing the file MLO to the
NAND’s SPL partition. For OMAP-L138 device, write the .ais image to the
NAND’s partition. For all devices this requires writing u-boot.img to
the NAND’s U-Boot partition.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The NAND partition of OMAP-L138 is different from other devices, please use the
following commands to program the NAND</p>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; setenv ipaddr &lt;EVM_IPADDR&gt;
=&gt; setenv serverip &lt;TFTP_SERVER_IPADDR&gt;
=&gt; tftp ${loadaddr} ${serverip}:u-boot-omapl138-lcdk.ais
=&gt; print filesize
=&gt; nand erase 0x20000 &lt;hex_len&gt;
=&gt; nand write ${loadaddr} 0x20000 &lt;hex_len&gt;
* hex_len is next sector boundary of the filesize. The sector size is 0x10000.
set dip switch to NAND boot and power cycle the EVM
</pre></div>
</div>
<p>Once the file(s) have been written to NAND the board should then be
powered off. Next evm’s boot switches need to be configured for NAND
booting. To understand the appropriate boot switches settings please see
the evm’s hardware setup guide.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="booting-kernel-and-filesystem-from-nand">
<h4>3.1.1.5.4. Booting Kernel and Filesystem from NAND<a class="headerlink" href="#booting-kernel-and-filesystem-from-nand" title="Permalink to this headline">¶</a></h4>
<p>If a user wants to use NAND as their primary storage then the NAND flash
must have individual partitions for all the critical software needed to
boot the kernel. At a minimum this includes kernel, dtb, file system.
Some SoCs require additional files and firmware which also need to be
stored in different NAND partitions.</p>
<p>Similar to booting the kernel from any interface the user must insure
that all required files needed for booting are loaded in DDR memory. The
only exception is the filesystem which will be loaded by the kernel via
the bootargs parameters. Bootargs contains information passed to the
kernel including where and how to mount the file system.</p>
<p>The below contains example bootargs used by DRA7x evm for using a ubifs
filesystem</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>setenv bootargs console=${console} ${optargs} root=ubi0:rootfs rw ubi.mtd=NAND.file-system,2048 rootfstype=ubifs rootwait=1
</pre></div>
</div>
<p>In the above example bootargs, “rootfs” stands for the value specified
by in the “vol_name” parameter defined in the ubinize.cfg file. In
ubi.mtd “NAND.file-system” and “2048” represents the name of the
partition that contains the ubifs and page size. Rootfstype simply tells
the kernel what type of file system to use.</p>
<p>By default for our evms properly loading, setting bootargs and booting
the kernel is handled by running “run nandboot” in U-boot. Information
on creating a UBIFS can be found
<a class="reference external" href="Foundational_Components/Kernel/Kernel_Drivers/Storage/NAND.html#building-ubi-file-system">here</a>.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="sd-emmc-or-usb-storage">
<h3>3.1.1.6. SD, eMMC or USB Storage<a class="headerlink" href="#sd-emmc-or-usb-storage" title="Permalink to this headline">¶</a></h3>
<p>The commands for using SD cards, eMMC flash and USB mass storage devices
(hard drives, flash drives, card readers, etc) are all very similar. The
biggest difference is that on some hardware we may not be able to run
U-Boot out of ROM from the storage device as it is unsupported. Once
U-Boot is running however, any of these may be used for the kernel and
the root filesystem.</p>
<div class="section" id="partitioning-emmc-from-u-boot">
<h4>3.1.1.6.1. Partitioning eMMC from U-Boot<a class="headerlink" href="#partitioning-emmc-from-u-boot" title="Permalink to this headline">¶</a></h4>
<p>The eMMC device typically ships without any partition table. We make use
of the GPT support in U-Boot to write a GPT partition table to eMMC. In
this case we need to use the <strong>uuidgen</strong> program on the host to create
the UUIDs used for the disk and each partition.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ uuidgen
...first uuid...
$ uuidgen
...second uuid...
</pre></div>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # printenv partitions
uuid_disk=${uuid_gpt_disk};name=rootfs,start=2MiB,size=-,uuid=${uuid_gpt_rootfs}
U-Boot # setenv uuid_gpt_disk ...first uuid...
U-Boot # setenv uuid_gpt_rootfs ...second uuid...
U-Boot # gpt write mmc 1 ${partitions}
</pre></div>
</div>
<p>A reset is required for the partition table to be visible.</p>
</div>
<div class="section" id="updating-an-sd-card-from-a-host-pc">
<h4>3.1.1.6.2. Updating an SD card from a host PC<a class="headerlink" href="#updating-an-sd-card-from-a-host-pc" title="Permalink to this headline">¶</a></h4>
<p>This section assume that you have created an SD card following the
instructions on <a class="reference external" href="Overview/Processor_SDK_Linux_create_SD_card_script.html">Processor SDK Linux Create SD Card
Script</a> or have
made a compatible layout by hand. In this case, you will need to copy
the all the boot images (<strong>MLO</strong> and <strong>u-boot.img</strong> for 32-bit platforms,
<strong>tiboot3.bin</strong>, <strong>sysfw.itb</strong>, <strong>tispl.bin</strong>, <strong>u-boot.img</strong> for K3 based platforms)
files to the <em>boot</em> partition. At this point, the card is now bootable in the SD card slot.
We default to using <strong>/boot/${bootfile}</strong> on the <em>rootfs</em> partition and the device tree file
loaded from <strong>/boot</strong> with the same name as in the kernel.</p>
<p>However, if you are using OMAP-L138 based board (like the LCDK), then
you need to write the generated <code class="docutils literal"><span class="pre">u-boot.ais</span></code> image to the SD card
using <code class="docutils literal"><span class="pre">dd</span></code> command.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sudo dd if=u-boot.ais of=/dev/sd&lt;N&gt; seek=117 bs=512 conv=fsync
</pre></div>
</div>
</div>
<div class="section" id="updating-an-sd-card-or-emmc-using-dfu">
<h4>3.1.1.6.3. Updating an SD card or eMMC using DFU<a class="headerlink" href="#updating-an-sd-card-or-emmc-using-dfu" title="Permalink to this headline">¶</a></h4>
<p>To see the list of available places to write to (in DFU terms,
altsettings) use the <strong>mmc part</strong> command to list the partitions on the
MMC device and <strong>printenv dfu_alt_settings_mmc</strong> or
<strong>dfu_alt_settings_emmc</strong> to see how they are mapped and exposed to
<strong>dfu-util</strong>.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot# mmc part

Partition Map for MMC device 0  --   Partition Type: DOS

Partition     Start Sector     Num Sectors     Type
    1                   63          144522       c Boot
    2               160650         1847475      83
    3              2024190         1815345      83
U-Boot# printenv dfu_alt_info_mmc
dfu_alt_info=boot part 0 1;rootfs part 0 2;MLO fat 0 1;u-boot.img fat 0 1;uEnv.txt fat 0 1&quot;
</pre></div>
</div>
<p>This means that you can tell dfu-util to write anything to any of:</p>
<ul class="simple">
<li>boot</li>
<li>rootfs</li>
<li>MLO</li>
<li>u-boot.img</li>
<li>uEnv.txt</li>
</ul>
<p>And that the <strong>MLO</strong>, <strong>u-boot.img</strong> and <strong>uEnv.txt</strong> files are to be
written to a FAT filesystem.</p>
<p>To start DFU on the target on the first MMC device:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # setenv dfu_alt_info ${dfu_alt_info_mmc}
U-Boot # dfu 0 mmc 0
</pre></div>
</div>
<p>On boards like AM57x GP EVM or BeagleBoard x15, where the second USB
instance is used as USB client, the dfu command becomes:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # dfu 1 mmc 0
</pre></div>
</div>
<p>Then on the host PC to write <strong>MLO</strong> to an existing boot partition:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sudo dfu-util -D MLO -a MLO
</pre></div>
</div>
<p>On the host PC to overwrite the current boot partition contents with a
new created on the host FAT filesystem image:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sudo dfu-util -D fat.img -a boot
</pre></div>
</div>
</div>
<div class="section" id="updating-an-sd-card-or-emmc-with-raw-writes">
<h4>3.1.1.6.4. Updating an SD card or eMMC with RAW writes<a class="headerlink" href="#updating-an-sd-card-or-emmc-with-raw-writes" title="Permalink to this headline">¶</a></h4>
<p>In some cases it is desirable to write <strong>MLO</strong> and <strong>u-boot.img</strong> as raw
images to the MMC device rather than in a filesystem. eMMC requires
this, for example. In that case, the following is how to program these
files and not overwrite the partition table on the device. We assume
that the files exist on a SD card. In addition you may wish to write a
filesystem image to the device, so an example is also provided.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc dev 0
U-Boot # mmc rescan
U-Boot # mmc dev 1
U-Boot # fatload mmc 0 ${loadaddr} MLO
U-Boot # mmc write ${loadaddr} 0x100 0x100
U-Boot # mmc write ${loadaddr} 0x200 0x100
U-Boot # fatload mmc 0 ${loadaddr} u-boot.img
U-Boot # mmc write ${loadaddr} 0x300 0x400
U-Boot # fatload mmc 0 ${loadaddr} rootfs.ext4
U-Boot # mmc write ${loadaddr} 0x1000 ...rootfs.ext4 size in bytes divided by 512, in hex...
</pre></div>
</div>
</div>
<div class="section" id="booting-linux-from-sd-card-or-emmc">
<h4>3.1.1.6.5. Booting Linux from SD card or eMMC<a class="headerlink" href="#booting-linux-from-sd-card-or-emmc" title="Permalink to this headline">¶</a></h4>
<p>Within the default environment for each board that supports SD/MMC there
is a boot command called <strong>mmcboot</strong> that will set the boot arguments
correctly and start the kernel. In this case however, you must first run
<strong>loaduimagefat</strong> or <strong>loaduimage</strong> to first load the kernel into
memory. For the exact details of each use <strong>printenv</strong> on the
<strong>mmcboot</strong>, <strong>loaduimagefat</strong> and <strong>loaduimage</strong> variables and then in
turn <strong>printenv</strong> other sub-sections of the command. The most important
variables here are <strong>mmcroot</strong> and <strong>mmcrootfstype</strong>.</p>
</div>
<div class="section" id="booting-mlo-and-u-boot-from-emmc-boot-partition">
<h4>3.1.1.6.6. Booting MLO and u-boot from eMMC boot partition<a class="headerlink" href="#booting-mlo-and-u-boot-from-emmc-boot-partition" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body">booting-mlo-and-u-boot-from-emmc-boot-partition</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The dra7xx and am57xx processors support booting from the eMMC boot partition. The following commands load the boot images from network and write them into the boot0 partition.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-boot # setenv autoload no
U-boot # dhcp
U-boot # mmc dev 1 1
U-boot # tftp ${loadaddr} dra7xx/MLO
U-boot # mmc write ${loadaddr} 0x0 0x300
U-boot # tftp ${loadaddr} dra7xx/u-boot.img
U-boot # mmc write ${loadaddr} 0x300 0x400
</pre></div>
</div>
<p>We also need to configure the eMMC using the bootbus and partconf commands. The bootbus command sets the eMMC into dual data rate mode with a bus width of 8 to match with the bus configuration supported by the Boot ROM. The partconf command gives access to the boot0 partition during boot operation. Note that these configurations are limited to boot operation and the eMMC can be set to its highest speed mode once boot operation is complete. All these are non-volatile configurations that need to be done <strong>once per eMMC/board</strong> .</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-boot # mmc bootbus 1 2 0 2
U-boot # mmc partconf 1 1 1 0
U-boot # mmc rst-function 1 1
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="booting-tiboot3-bin-tispl-bin-and-u-boot-img-from-emmc-boot-partition">
<h4>3.1.1.6.7. Booting tiboot3.bin, tispl.bin and u-boot.img from eMMC boot partition<a class="headerlink" href="#booting-tiboot3-bin-tispl-bin-and-u-boot-img-from-emmc-boot-partition" title="Permalink to this headline">¶</a></h4>
<p>The K3 based processors support booting from the eMMC boot partition.
The following commands can be used to download tiboot3.bin, tispl.bin and
u-boot.img from an SD card and write them to the eMMC boot0 partition at
respective addresses.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; mmc dev 0 1</span>
<span class="go">=&gt; fatload mmc 1 ${loadaddr} tiboot3.bin</span>
<span class="go">=&gt; mmc write ${loadaddr} 0x0 0x400</span>
<span class="go">=&gt; fatload mmc 1 ${loadaddr} tispl.bin</span>
<span class="go">=&gt; mmc write ${loadaddr} 0x400 0x1000</span>
<span class="go">=&gt; fatload mmc 1 ${loadaddr} u-boot.img</span>
<span class="go">=&gt; mmc write ${loadaddr} 0x1400 0x2000</span>
<span class="go">=&gt; fatload mmc 1 ${loadaddr} sysfw.itb</span>
<span class="go">=&gt; mmc write ${loadaddr} 0x3600 0x800</span>
</pre></div>
</div>
<p>To give the ROM access to the boot partition, the following commands must be
used for the first time:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; mmc partconf 0 1 1 1</span>
<span class="go">=&gt; mmc bootbus 0 2 0 0</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="booting-linux-from-usb-storage">
<h4>3.1.1.6.8. Booting Linux from USB storage<a class="headerlink" href="#booting-linux-from-usb-storage" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">name:</th><td class="field-body">booting-linux-from-usb-storage</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>To load the Linux Kernel and rootfs from USB rather than SD/MMC card on
AMx/DRA7x EVMs, if we assume that the USB device is partitioned the same
way as an SD/MMC card is, we can utilize the <strong>mmcboot</strong> command to
boot. To do this, perform the following steps:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # usb start
U-Boot # setenv mmcroot /dev/sda2 ro
U-Boot # run mmcargs
U-Boot # run bootcmd_usb
</pre></div>
</div>
<p>On K2H/K/E/L EVMs, the USB drivers in Kernel needs to be built-in
(default modules). The configuration changes are:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>CONFIG_USB=y
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_XHCI_PCI=y
CONFIG_USB_XHCI_PLATFORM=y
CONFIG_USB_STORAGE=y
CONFIG_USB_DWC3=y
CONFIG_USB_DWC3_HOST=y
CONFIG_USB_DWC3_KEYSTONE=y
CONFIG_EXTCON=y
CONFIG_EXTCON_USB_GPIO=y
CONFIG_SCSI_MOD=y
CONFIG_SCSI=y
CONFIG_BLK_DEV_SD=y
</pre></div>
</div>
<p>The USB should have boot partition of FAT32 format, and rootfs partition
of EXT4 format. The boot partition must contain the following images:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>keystone-&lt;platform&gt;-evm.dtb
skern-&lt;platform&gt;.bin
k2-fw-initrd.cpio.gz
zImage

where &lt;platform&gt;=k2hk, k2e, k2l
</pre></div>
</div>
<p>The rootfs partition contains the filesystem from ProcSDK release
package.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># mkdir /mnt/temp
# mount -t ext4 /dev/sdb2 /mnt/temp
# cd /mnt/temp
# tar xvf &lt;Linux_Proc_Sdk_Install_DIR&gt;/filesyste/tisdk-server-rootfs-image-k2hk-evm.tar.xz
# cd /mnt
# umount temp
</pre></div>
</div>
<p>Set up the following u-boot environment variables:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>setenv args_all &#39;setenv bootargs console=ttyS0,115200n8 rootwait&#39;
setenv args_usb &#39;setenv bootargs ${bootargs} rootdelay=3 rootfstype=ext4 root=/dev/sda2 rw&#39;
setenv get_fdt_usb &#39;fatload usb 0:1 ${fdtaddr} ${name_fdt}&#39;
setenv get_kern_usb &#39;fatload usb 0:1 ${loadaddr} ${name_kern}&#39;
setenv get_mon_usb &#39;fatload usb 0:1 ${addr_mon} ${name_mon}&#39;
setenv init_fw_rd_usb &#39;fatload usb 0:1 ${rdaddr} ${name_fw_rd}; setenv filesize &lt;hex_len&gt;; run set_rd_spec&#39;
setenv init_usb &#39;usb start; run args_all args_usb&#39;
setenv boot usb
saveenv
boot
</pre></div>
</div>
<p><strong>Note:</strong>: &lt;hex_len&gt; must be at least the hex size of the k2-fw-initrd.cpio.gz file size.</p>
<p class="rubric" id="j721e-evm-usb-30-host">Enabling USB 3.0 host port on J721e EVM</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">J721e SoC does not support booting from USB mass storage devices. But can be used as storage device at U-Boot prompt.</p>
</div>
<p>USB0 instance on J721e base board is connected to TypeC port that can be
used both as host port and device port. By default, USB0 is port is
configured to be in <strong>peripheral mode</strong>. Since U-Boot does not support
dynamic switching of USB roles, below DT fragment needs to be
applied and U-Boot image needs to be rebuilt to make USB0 port to be
USB 3.0 host port.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>diff --git a/arch/arm/dts/k3-j721e-common-proc-board-u-boot.dtsi b/arch/arm/dts/k3-j721e-common-proc-board-u-boot.dtsi
index 50effb4812b2..28986c4d2c2a 100644
--- a/arch/arm/dts/k3-j721e-common-proc-board-u-boot.dtsi
+++ b/arch/arm/dts/k3-j721e-common-proc-board-u-boot.dtsi
@@ -184,11 +184,10 @@

 &amp;usbss0 {
        u-boot,dm-spl;
-       ti,usb2-only;
 };

 &amp;usb0 {
-       dr_mode = &quot;peripheral&quot;;
+       dr_mode = &quot;host&quot;;
        u-boot,dm-spl;
 };
</pre></div>
</div>
</div>
<div class="section" id="booting-from-sd-emmc-from-spl-single-stage-or-falcon-mode">
<h4>3.1.1.6.9. Booting from SD/eMMC from SPL (Single stage or Falcon mode)<a class="headerlink" href="#booting-from-sd-emmc-from-spl-single-stage-or-falcon-mode" title="Permalink to this headline">¶</a></h4>
<p>In this boot mode SPL (first stage bootloader) directly boots the Linux
kernel. Optionally, in order to enter into U-Boot, reset the board while
keeping ‘c’ key on the serial terminal pressed. When falcon mode is
enabled in U-Boot build (usually enabled by default), <code class="docutils literal"><span class="pre">MLO</span></code> checks if
there is a valid <code class="docutils literal"><span class="pre">uImage</span></code> present at a defined offset. If <code class="docutils literal"><span class="pre">uImage</span></code>
is present, it is booted directly. If valid <code class="docutils literal"><span class="pre">uImage</span></code> is not found,
<code class="docutils literal"><span class="pre">MLO</span></code> falls back to checking if the <code class="docutils literal"><span class="pre">uImage</span></code> exists in a FAT
partition. If it fails, it falls back to booting <code class="docutils literal"><span class="pre">u-boot.img</span></code>.</p>
<p>The falcon boot uses <code class="docutils literal"><span class="pre">uImage</span></code>. To build the kernel <code class="docutils literal"><span class="pre">uImage</span></code>, you
will need to keep the U-Boot tool <code class="docutils literal"><span class="pre">mkimage</span></code> in your <code class="docutils literal"><span class="pre">$PATH</span></code></p>
<div class="highlight-text"><div class="highlight"><pre><span></span># make uImage modules dtbs LOADADDR=80008000
</pre></div>
</div>
<p>If kernel is not build with <code class="docutils literal"><span class="pre">CONFIG_CMDLINE</span></code> to set correct bootargs,
then add the needed <code class="docutils literal"><span class="pre">bootargs</span></code> in <code class="docutils literal"><span class="pre">chosen</span></code> node in DTB file, using
<code class="docutils literal"><span class="pre">fdtput</span></code> host utility. For example, for DRA74x EVM:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># fdtput -v -t s arch/arm/boot/dts/dra7-evm.dtb &quot;/chosen&quot; bootargs &quot;console=ttyO0,115200n8 root=&lt;rootfs&gt;&quot;
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">MLO</span></code>, <code class="docutils literal"><span class="pre">u-boot.img</span></code> (optional), DTB, <code class="docutils literal"><span class="pre">uImage</span></code> are all stored on
the same medium, either the SD or the eMMC. There are two ways to store
the binaries in the SD (resp. eMMC):</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>* raw: binaries are stored at fixed offset in the medium
* fat: binaries are stored as file in a FAT partition
</pre></div>
</div>
<p>To flash binaries to SD or eMMC, you can use DFU. For SD boot, from
u-boot prompt</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; env default -a; setenv dfu_alt_info ${dfu_alt_info_mmc}; dfu 0 mmc 0
</pre></div>
</div>
<p>For eMMC boot, from u-boot prompt</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; env default -a; setenv dfu_alt_info ${dfu_alt_info_emmc}; dfu 0 mmc 1
</pre></div>
</div>
<p>Note: On boards like AM57x GP EVM or BeagleBoard x15, where the second
USB instance is used as USB client, replace “dfu 0 mmc X” with “dfu 1
mmc X”</p>
<p>On the host side: binaries in FAT:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sudo dfu-util -D MLO -a MLO
$ sudo dfu-util -D u-boot.img -a u-boot.img
$ sudo dfu-util -D dra7-evm.dtb -a spl-os-args
$ sudo dfu-util -D uImage -a spl-os-image
</pre></div>
</div>
<p>raw binaries:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sudo dfu-util -D MLO -a MLO.raw
$ sudo dfu-util -D u-boot.img -a u-boot.img.raw
$ sudo dfu-util -D dra7-evm.dtb -a spl-os-args.raw
$ sudo dfu-util -D uImage -a spl-os-image.raw
</pre></div>
</div>
<p>If the binaries are files in a fat partition, you need to specify their
name if they differ from the default values (“uImage” and “args”). Note
that DFU uses the names “spl-os-image” and “spl-os-args”, so this step
is required in the case of DFU. From u-boot prompt</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; setenv falcon_image_file spl-os-image
=&gt; setenv falcon_args_file spl-os-args
=&gt; saveenv
</pre></div>
</div>
<p>Set the environment variable “boot_os” to 1. From u-boot prompt</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; setenv boot_os 1
=&gt; saveenv
</pre></div>
</div>
<p>Set the board boot from SD (or eMMC respectively) and reset the EVM. The
SPL directly boots the kernel image from SD (or eMMC).</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="spi">
<h3>3.1.1.7. SPI<a class="headerlink" href="#spi" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SPI is not supported on J721E platform (not be confused with QSPI/OSPI).</p>
</div>
<p>This section documents how to write files to the SPI device and use it
to load and then boot the Linux Kernel using a root filesystem also
found on SPI. At this time, no special builds of U-Boot are required to
perform these operations on the supported hardware. The table below
however, lists builds that will also use the SPI flash for the
environment instead of the default, which typically is NAND in AM57x and
DRA7x EVMs, but in Keystone-2 EVMs, it is only NOR. Finally, for
simplicity we assume the files are being loaded from an SD card. Using
the network interface (if applicable) is documented above.</p>
<div class="section" id="writing-to-spi-from-u-boot">
<h4>3.1.1.7.1. Writing to SPI from U-Boot<a class="headerlink" href="#writing-to-spi-from-u-boot" title="Permalink to this headline">¶</a></h4>
<p>Note for AM57x and DRA7x platforms:</p>
<ul class="simple">
<li>From the U-Boot build, the <strong>MLO.byteswap</strong> and <strong>u-boot.img</strong> files
are the ones to be written.</li>
<li>We load all files from an SD card in this example but they can just
as easily be loaded via network (documented above) or other interface
that exists.</li>
<li>At this time the SPI mtd partition map has not yet been updated to
include an example location for the device tree.</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc rescan
U-Boot # sf probe 0
U-Boot # sf erase 0 +80000
U-Boot # fatload mmc 0 ${loadaddr} MLO.byteswap
U-Boot # sf write ${loadaddr} 0 ${filesize}
U-Boot # fatload mmc 0 ${loadaddr} u-boot.img
U-Boot # sf write ${loadaddr} 0x20000 ${filesize}
U-Boot # sf erase 80000 +${spiimgsize}
U-Boot # fatload mmc 0 ${loadaddr} zImage
U-Boot # sf write ${loadaddr} ${spisrcaddr} ${filesize}
</pre></div>
</div>
<p>Note for Keystone-2 (K2H/K/E/L/G) platforms:</p>
<ul class="simple">
<li>From the U-Boot build, the <strong>u-boot-spi.gph</strong> file is the one to be
written.</li>
<li>We load the file from a tftp server via netowrk in this example.</li>
<li>The series commands burns the u-boot image to the SPI NOR flash</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # env default -f -a
U-Boot # setenv serverip &lt;ip address of tftp server&gt;
U-Boot # setenv tftp_root &lt;tftp root directory&gt;
U-Boot # setenv name_uboot u-boot-spi.gph
U-Boot # run get_uboot_net
U-Boot # run burn_uboot_spi
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="booting-from-spi">
<h4>3.1.1.7.2. Booting from SPI<a class="headerlink" href="#booting-from-spi" title="Permalink to this headline">¶</a></h4>
<p>Within the default environment for each board that supports SPI there is
a boot command called <strong>spiboot</strong> that will automatically load the
kernel and boot. For the exact details of each use <strong>printenv</strong> on the
<strong>spiboot</strong> variable and then in turn <strong>printenv</strong> other sub-sections of
the command. The most important variables here are <strong>spiroot</strong> and
<strong>spirootfstype</strong>. For Keystone-2 platforms, it is configured to be
<strong>ARM SPI</strong> boot mode using SW1 dip switch setting. Please refer to the
Hardware Setup of each Keystone-2 EVM.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="ospi-qspi">
<h3>3.1.1.8. OSPI/QSPI<a class="headerlink" href="#ospi-qspi" title="Permalink to this headline">¶</a></h3>
<p>OSPI/QSPI is a serial peripheral interface like SPI the major difference
being the support for Octal/Quad read, uses 8/4 data lines for read compared to
2 lines used by the traditional SPI. This section documents how to write
files to the QSPI device and use it to load and then boot the Linux
Kernel using a root filesystem also found on QSPI. At this time, no
special builds of U-Boot are required to perform these operations on the
supported hardware. For simplicity we assume the files are being loaded
from an SD card. Using the network interface (if applicable) is
documented above.</p>
<div class="section" id="am654-j721e-support">
<h4>3.1.1.8.1. AM654/J721E Support<a class="headerlink" href="#am654-j721e-support" title="Permalink to this headline">¶</a></h4>
<p>ROM supports booting from OSPI from offset 0x0.</p>
<p><strong>Flashing Images to OSPI</strong></p>
<p>Below commands can be used to download tiboot3.bin, tispl.bin and
u-boot.img over tftp and then flash it to OSPI at respective addresses.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; sf probe</span>
<span class="go">=&gt; tftp ${loadaddr} tiboot3.bin</span>
<span class="go">=&gt; sf update $loadaddr 0x0 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} tispl.bin</span>
<span class="go">=&gt; sf update $loadaddr 0x80000 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} u-boot.img</span>
<span class="go">=&gt; sf update $loadaddr 0x280000 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} sysfw.itb</span>
<span class="go">=&gt; sf update $loadaddr 0x6C0000 $filesize</span>
</pre></div>
</div>
<p><strong>PHY Calibration</strong></p>
<p>PHY calibration allows for higher read performance. To enable PHY, the PHY
calibration pattern must be flashed to OSPI at the start of the last erase
sector. For the Micron MT35XU512ABA flash, this lies at the address 0x3fe0000.</p>
<p>Below commands can be used to flash the PHY pattern, with the location of the
pattern depending on which flash is being used:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; sf probe</span>
<span class="go">=&gt; tftp ${loadaddr} pattern_file</span>
<span class="go">=&gt; sf update $loadaddr 0x3fe0000 $filesize</span>
</pre></div>
</div>
<p><strong>Flash Layout for OSPI</strong></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">      0x0 +----------------------------+</span>
<span class="go">          |     ospi.tiboot3(512K)     |</span>
<span class="go">          |                            |</span>
<span class="go">  0x80000 +----------------------------+</span>
<span class="go">          |     ospi.tispl(2M)         |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x280000 +----------------------------+</span>
<span class="go">          |     ospi.u-boot(4M)        |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x680000 +----------------------------+</span>
<span class="go">          |     ospi.env(128K)         |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x6A0000 +----------------------------+</span>
<span class="go">          |   ospi.env.backup (128K)   |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x6C0000 +----------------------------+</span>
<span class="go">          |      ospi.sysfw(1M)        |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x7C0000 +----------------------------+</span>
<span class="go">          |      padding (256k)        |</span>
<span class="go"> 0x800000 +----------------------------+</span>
<span class="go">          |     ospi.rootfs(UBIFS)     |</span>
<span class="go">          |                            |</span>
<span class="go">0x3FE0000 +----------------------------+</span>
<span class="go">          |   ospi.phypattern (128k)   |</span>
<span class="go">          |                            |</span>
<span class="go">          +----------------------------+</span>
</pre></div>
</div>
<p>Kernel Image and DT are expected to be present in the /boot folder of UBIFS
ospi.rootfs just like in SD card case. U-Boot looks for UBI volume named
“rootfs” for rootfs.</p>
<p>To boot kernel from OSPI, at the U-Boot prompt:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; setenv boot ubi</span>
<span class="go">=&gt; boot</span>
</pre></div>
</div>
</div>
<div class="section" id="j7200-support">
<h4>3.1.1.8.2. J7200 Support<a class="headerlink" href="#j7200-support" title="Permalink to this headline">¶</a></h4>
<p>J7200 is largely similar to J721E and AM654. The major differences are that it
has the Cypress S28HS512T flash and sysfw is bundled with tiboot3.bin.</p>
<p><strong>Flashing Images to OSPI</strong></p>
<p>Below commands can be used to download tiboot3.bin, tispl.bin and
u-boot.img over tftp and then flash it to OSPI at respective addresses.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; sf probe</span>
<span class="go">=&gt; tftp ${loadaddr} tiboot3.bin</span>
<span class="go">=&gt; sf update $loadaddr 0x0 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} tispl.bin</span>
<span class="go">=&gt; sf update $loadaddr 0x80000 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} u-boot.img</span>
<span class="go">=&gt; sf update $loadaddr 0x280000 $filesize</span>
</pre></div>
</div>
<p><strong>PHY Calibration</strong></p>
<p>PHY calibration allows for higher read performance. To enable PHY, the PHY
calibration pattern must be flashed to OSPI at the start of the last erase
sector. For the Cypress S28HS512T flash, this lies at the address 0x3fc0000.</p>
<p>Below commands can be used to flash the PHY pattern, with the location of the
pattern depending on which flash is being used:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; sf probe</span>
<span class="go">=&gt; tftp ${loadaddr} pattern_file</span>
<span class="go">=&gt; sf update $loadaddr 0x3fc0000 $filesize</span>
</pre></div>
</div>
<p><strong>Flash Layout for OSPI</strong></p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">      0x0 +----------------------------+</span>
<span class="go">          |     ospi.tiboot3(512K)     |</span>
<span class="go">          |                            |</span>
<span class="go">  0x80000 +----------------------------+</span>
<span class="go">          |     ospi.tispl(2M)         |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x280000 +----------------------------+</span>
<span class="go">          |     ospi.u-boot(4M)        |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x680000 +----------------------------+</span>
<span class="go">          |     ospi.env(256K)         |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x6C0000 +----------------------------+</span>
<span class="go">          |   ospi.env.backup (256K)   |</span>
<span class="go">          |                            |</span>
<span class="go"> 0x700000 +----------------------------+</span>
<span class="go">          |       padding (1M)         |</span>
<span class="go"> 0x800000 +----------------------------+</span>
<span class="go">          |     ospi.rootfs(UBIFS)     |</span>
<span class="go">          |                            |</span>
<span class="go">0x3FC0000 +----------------------------+</span>
<span class="go">          |   ospi.phypattern (256k)   |</span>
<span class="go">          |                            |</span>
<span class="go">          +----------------------------+</span>
</pre></div>
</div>
</div>
<div class="section" id="dra7xx-support">
<h4>3.1.1.8.3. DRA7xx support<a class="headerlink" href="#dra7xx-support" title="Permalink to this headline">¶</a></h4>
<p>Memory Layout of QSPI Flash</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>+----------------+ 0x00000
|      MLO       |
|                |
+----------------+ 0x040000
|   u-boot.img   |
|                |
+----------------+ 0x140000
|   DTB blob     |
+----------------+ 0x1c0000
|   u-boot env   |
+----------------+ 0x1d0000
|   u-boot env   |
|    (backup)    |
+----------------+ 0x1e0000
|                |
|     uImage     |
|                |
|                |
+----------------+ 0x9e0000
|                |
|  other data    |
|                |
+----------------+
</pre></div>
</div>
<p class="rubric" id="writing-to-qspi-from-u-boot">Writing to QSPI from U-Boot</p>
<p>Note:</p>
<ul class="simple">
<li>From the U-Boot build, the <strong>MLO</strong> and <strong>u-boot.img</strong> files are the
ones to be written.</li>
<li>We load all files from an SD card in this example but they can just
as easily be loaded via network (documented above) or other interface
that exists.</li>
</ul>
<p>Writing MLO and u-boot.img binaries.</p>
<p>For QSPI_1 build U-Boot with <code class="docutils literal"><span class="pre">dra7xx_evm_config</span></code></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc rescan
U-Boot # fatload mmc 0 ${loadaddr} MLO
U-Boot # sf probe 0
U-Boot # sf erase 0x00000 0x100000
U-Boot # sf write ${loadaddr} 0x00000 ${filesize}
U-Boot # fatload mmc 0 ${loadaddr} u-boot.img
U-Boot # sf write ${loadaddr} 0x40000 ${filesize}
</pre></div>
</div>
<p>change SW2[5:0] = 110110 for qspi boot.</p>
<p>For QSPI_4 build U-Boot with <code class="docutils literal"><span class="pre">dra7xx_evm_qspiboot_config</span></code></p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc rescan
U-Boot # fatload mmc 0 ${loadaddr} MLO
U-Boot # sf probe 0
U-Boot # sf erase 0x00000 0x100000
U-Boot # sf write ${loadaddr} 0x00000 0x10000
U-Boot # fatload mmc 0 ${loadaddr} u-boot.img
U-Boot # sf write ${loadaddr} 0x40000 0x60000
</pre></div>
</div>
<p>change SW2[5:0] = 110111 for qspi boot.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p class="rubric" id="writing-to-qspi-using-dfu">Writing to QSPI using DFU</p>
<p>Setup: Connect the usb0 port of EVM to ubuntu host PC. Make sure
dfu-util tool is installed.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#sudo apt-get install dfu-util
</pre></div>
</div>
<p>From u-boot:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # env default -a
U-Boot # setenv dfu_alt_info ${dfu_alt_info_qspi}; dfu 0 sf &quot;0:0:64000000:0&quot;
</pre></div>
</div>
<p>From ubuntu PC: Using dfu-util utilities to flash the binares to QSPI
flash.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># sudo dfu-util -l
(C) 2005-2008 by Weston Schmidt, Harald Welte and OpenMoko Inc.
(C) 2010-2011 Tormod Volden (DfuSe support)
This program is Free Software and has ABSOLUTELY NO WARRANTY
dfu-util does currently only support DFU version 1.0
Found DFU: [0451:d022] devnum=0, cfg=1, intf=0, alt=0, name=&quot;MLO&quot;
Found DFU: [0451:d022] devnum=0, cfg=1, intf=0, alt=1, name=&quot;u-boot.img&quot;
Found DFU: [0451:d022] devnum=0, cfg=1, intf=0, alt=2, name=&quot;u-boot-spl-os&quot;
Found DFU: [0451:d022] devnum=0, cfg=1, intf=0, alt=3, name=&quot;u-boot-env&quot;
Found DFU: [0451:d022] devnum=0, cfg=1, intf=0, alt=4, name=&quot;u-boot-env.backup&quot;
Found DFU: [0451:d022] devnum=0, cfg=1, intf=0, alt=5, name=&quot;kernel&quot;
</pre></div>
</div>
<p>Flash the binaries to the respective regions using alternate interface
number (alt=&lt;x&gt;).</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># sudo dfu-util -c 1 -i 0 -a 0 -D MLO
# sudo dfu-util -c 1 -i 0 -a 1 -D u-boot.img
# sudo dfu-util -c 1 -i 0 -a 2 -D &lt;DTB-file&gt;
# sudo dfu-util -c 1 -i 0 -a 5 -D uImage
</pre></div>
</div>
<p class="rubric" id="booting-from-qspi-from-u-boot">Booting from QSPI from u-boot</p>
<p>The default environment does not contain a QSPI boot command. The
following example uses the partition table found in the kernel.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # sf probe 0
U-Boot # sf read ${loadaddr} 0x1e0000 0x800000
U-Boot # sf read ${fdtaddr} 0x140000 0x80000
U-Boot # setenv bootargs console=${console} root=/dev/mtdblock19 rootfstype=jffs2
U-Boot # bootz ${loadaddr} - ${fdtaddr}
</pre></div>
</div>
<p class="rubric" id="booting-from-qspi-from-spl-single-stage-or-falcon-mode">Booting from QSPI from SPL (Single stage or Falcon mode)</p>
<p>In this boot mode SPL (first stage bootloader) directly boots the Linux
kernel. Optionally, in order to enter into U-Boot, reset the board while
keeping ‘c’ key on the serial terminal pressed. When falcon mode is
enabled in U-Boot build (usually enabled by default), MLO checks if
there is a valid uImage present at a defined offset. If uImage is
present, it is booted directly. If valid uImage is not found, MLO falls
back to booting u-boot.img.</p>
<p>For QSPI single stage or Falcon mode, the CONFIG_QSPI_BOOT shall
enabled.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Menuconfig-&gt;Bood media
   [ ] Support for booting from NAND flash
   ..
   [*] Support for booting from QSPI flash
   [ ] Support for booting from SATA
   ...
</pre></div>
</div>
<p>MLO, u-boot.img (optional), DTB, uImage are stored in QSPI flash memory.
Refer the “Memory Layout” section for offset details. To flash binaries
to QSPI, you can use
<a class="reference external" href="Foundational_Components_U-Boot.html#writing-to-qspi-using-dfu">DFU</a>,
for example.</p>
<p>The QSPI boot uses uImage. Build the kernel uImage. You will need to
keep the U-Boot tool <code class="docutils literal"><span class="pre">mkimage</span></code> in your <code class="docutils literal"><span class="pre">$PATH</span></code></p>
<div class="highlight-text"><div class="highlight"><pre><span></span># make uImage modules dtbs LOADADDR=80008000
</pre></div>
</div>
<p>If kernel is not build with <code class="docutils literal"><span class="pre">CONFIG_CMDLINE</span></code> to set correct bootargs,
then add the needed bootargs in chosen node in DTB file, using fdtput
host utility. For example, for DRA74x EVM:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span># fdtput -v -t s arch/arm/boot/dts/dra7-evm.dtb &quot;/chosen&quot; bootargs &quot;console=ttyO0,115200n8 root=&lt;rootfs&gt;&quot;
</pre></div>
</div>
<p>Set the environment variable “boot_os” to 1.</p>
<p>From u-boot prompt</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; setenv boot_os 1
=&gt; saveenv
</pre></div>
</div>
<p>Set the <a class="reference external" href="Foundational_Components_U-Boot.html#writing-to-qspi-from-u-boot">board boot from
QSPI</a>
and reset the EVM. The SPL directly boots the kernel image from QSPI.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="am335x-support">
<h4>3.1.1.8.4. AM335X support<a class="headerlink" href="#am335x-support" title="Permalink to this headline">¶</a></h4>
<p>SPI boot is supported on the following platforms:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Board</th>
<th class="head">Config target</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x ICE</td>
<td>am335x_evm_spiboot_defconfig</td>
</tr>
</tbody>
</table>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc rescan
U-Boot # sf probe 0
U-Boot # sf erase 0x0 0x100000
U-Boot # fatload mmc 0 ${loadaddr} MLO.byteswap
U-Boot # sf write ${loadaddr} 0x0 ${filesize}
U-Boot # fatload mmc 0 ${loadaddr} u-boot.img
U-Boot # sf write ${loadaddr} 0x20000 ${filesize}
</pre></div>
</div>
<p>Note:</p>
<ul class="simple">
<li>AM335X ICE boots from SPI by default. To boot from SD card, erase the
MLO partition:</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # sf erase 0x0 0x20000
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="am43xx-support">
<h4>3.1.1.8.5. AM43xx support<a class="headerlink" href="#am43xx-support" title="Permalink to this headline">¶</a></h4>
<p>Using QSPI on AM43xx platforms is done as eXecute In Place and U-Boot is
directly booted.</p>
<p class="rubric" id="writing-to-qspi-from-u-boot-1">Writing to QSPI from U-Boot</p>
<p>Note:</p>
<ul class="simple">
<li>From the U-Boot build the <strong>u-boot.bin</strong> file is the one to be
written.</li>
<li>We load all files from an SD card in this example but they can just
as easily be loaded via network (documented above) or other interface
that exists.</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc rescan
U-Boot # fatload mmc 0 ${loadaddr} u-boot.bin
U-Boot # sf probe 0
U-Boot # sf erase 0x0 0x100000
U-Boot # sf write ${loadaddr} 0x0 ${filesize}
</pre></div>
</div>
<p class="rubric" id="booting-from-qspi">Booting from QSPI</p>
<p>The default environment does not contain a QSPI boot command. The
following example uses the partition table found in the kernel.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # sf probe 0
U-Boot # sf read ${loadaddr} 0x1a0000 0x800000
U-Boot # sf read ${fdtaddr} 0x100000 0x80000
U-Boot # setenv bootargs console=${console} spi-ti-qspi.enable_qspi=1 root=/dev/mtdblock6 rootfstype=jffs2
U-Boot # bootz ${loadaddr} - ${fdtaddr}
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="nor">
<h3>3.1.1.9. NOR<a class="headerlink" href="#nor" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Parallel NOR is not supported on J721E platform.</p>
</div>
<p>This section documents how to write files to the NOR device and use it
to load and then boot the Linux Kernel using a root filesystem also
found on NOR. In order for NOR to be visible to U-Boot a special build
of U-Boot is required on the supported hardware. The table below lists
builds that see NOR and in some cases also use theit for the environment
instead of the default, which typically is NAND. Finally, for simplicity
we assume the files are being loaded from an SD card. Using the network
interface (if applicable) is documented above.</p>
<div class="section" id="writing-to-nor-from-u-boot">
<h4>3.1.1.9.1. Writing to NOR from U-Boot<a class="headerlink" href="#writing-to-nor-from-u-boot" title="Permalink to this headline">¶</a></h4>
<p>Note:</p>
<ul class="simple">
<li>From the U-Boot build, the <strong>u-boot.bin</strong> file is the one to be
written.</li>
<li>We load all files from an SD card in this example but they can just
as easily be loaded via network (documented above) or other interface
that exists.</li>
<li>At this time the NOR mtd partition map has not yet been updated to
include an example location for the device tree.</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Board</th>
<th class="head">Config target</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AM335x EVM</td>
<td>am335x_evm_nor_config / am335x_evm_norboot_config</td>
</tr>
</tbody>
</table>
<div class="highlight-text"><div class="highlight"><pre><span></span>U-Boot # mmc rescan
U-Boot # load mmc 0 ${loadaddr} u-boot.bin
U-Boot # protect off 08000000 +4c0000
U-Boot # erase 08000000 +4c0000
U-Boot # cp.b ${loadaddr} 08000000 ${filesize}
U-Boot # fatload mmc 0 ${loadaddr} zImage
U-Boot # cp.b ${loadaddr} 080c0000 ${filesize}
</pre></div>
</div>
</div>
<div class="section" id="booting-from-nor">
<h4>3.1.1.9.2. Booting from NOR<a class="headerlink" href="#booting-from-nor" title="Permalink to this headline">¶</a></h4>
<p>Within the default environment there is not a shortcut for booting. One
needs to pass <strong>root=/dev/mtdblockN</strong> where N is the number of the
rootfs partition in <strong>bootargs</strong>.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="uart">
<h3>3.1.1.10. UART<a class="headerlink" href="#uart" title="Permalink to this headline">¶</a></h3>
<p>This section documents how to use the UART to load files to boot the
board into U-Boot. After that the user is expected to know how they want
to continue loading files.</p>
<div class="section" id="booting-u-boot-from-the-console-uart">
<h4>3.1.1.10.1. Booting U-Boot from the console UART<a class="headerlink" href="#booting-u-boot-from-the-console-uart" title="Permalink to this headline">¶</a></h4>
<p>In some cases we support loading SPL and U-Boot over the console UART.
You will need to use the <strong>spl/u-boot-spl.bin</strong> and <strong>u-boot.img</strong> files
to boot. As per the TRM, the file is to be loaded via the X-MODEM
protocol at 115200 baud 8 stop bits no parity (same as using it for
console). SPL in turn expects to be sent <strong>u-boot.img</strong> at the same rate
but via Y-MODEM. An example session from the host PC, assuming console
is on ttyUSB0 and already configured would be and the <strong>lrzsz</strong> package
is installed</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sx -kb /path/to/u-boot-spl.bin &lt; /dev/ttyUSB0 &gt; /dev/ttyUSB0
$ sx -kb --ymodem /path/to/u-boot.img &lt; /dev/ttyUSB0 &gt; /dev/ttyUSB0
</pre></div>
</div>
<p>In K3 based platforms, ROM supports booting from MCU_UART0 via X-Modem protocol.
The entire UART-based boot process up to U-Boot (proper) prompt goes through
different stages and uses different UART peripherals as follows:</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="27%" />
<col width="24%" />
<col width="22%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">WHO</th>
<th class="head">Loading WHAT</th>
<th class="head">HW Module</th>
<th class="head">Protocol</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Boot ROM</td>
<td>tiboot3.bin</td>
<td>MCU_UART0</td>
<td>X-Modem</td>
</tr>
<tr class="row-odd"><td>R5 SPL</td>
<td>sysfw.itb</td>
<td>MCU_UART0</td>
<td>Y-Modem</td>
</tr>
<tr class="row-even"><td>R5 SPL</td>
<td>tispl.bin</td>
<td>MAIN_UART0</td>
<td>Y-Modem</td>
</tr>
<tr class="row-odd"><td>A53/A72 SPL</td>
<td>u-boot.img</td>
<td>MAIN_UART0</td>
<td>Y-Modem</td>
</tr>
</tbody>
</table>
<p>UART_BOOT_MAIN_UART and UART_BOOT_MCU_UART should be set to serial ports such as /dev/ttyUSBx.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$ sb --xmodem $OUT_R5/tiboot3.bin &gt; $UART_BOOT_MCU_UART &lt; $UART_BOOT_MCU_UART
$ sb --ymodem $SYSFW_ITB &gt; $UART_BOOT_MCU_UART &lt; $UART_BOOT_MCU_UART
$ sb --ymodem $OUT_AXX/tispl.bin &gt; $UART_BOOT_MAIN_UART &lt; $UART_BOOT_MAIN_UART
$ sb --xmodem $OUT_AXX/u-boot.img &gt; $UART_BOOT_MAIN_UART &lt; $UART_BOOT_MAIN_UART
</pre></div>
</div>
</div>
</div>
<div class="section" id="sata">
<h3>3.1.1.11. SATA<a class="headerlink" href="#sata" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">SATA is not supported on J721E platform.</p>
</div>
<p>SATA and eSATA devices show up as SCSI devices in U-boot.</p>
<div class="section" id="viewing-sata-devices">
<h4>3.1.1.11.1. Viewing SATA Devices<a class="headerlink" href="#viewing-sata-devices" title="Permalink to this headline">¶</a></h4>
<p>To view all SCSI devices that U-boot sees the command “scsi info” can be
used.</p>
<p>Output of this command when ran on AM57x General Purpose EVM can be seen
below.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>scsi part
Device 0: (0:0) Vendor: ATA Prod.: PLEXTOR PX-64M6M Rev: 1.08
            Type: Hard Disk
            Capacity: 61057.3 MB = 59.6 GB (125045424 x 512)
</pre></div>
</div>
<p>Device 0 represents the instance of the scsi device. Therefore, in later
commands when a “&lt;dev&gt;” parameter is seen replace it with the
appropriate device number.</p>
</div>
<div class="section" id="viewing-partitions">
<h4>3.1.1.11.2. Viewing Partitions<a class="headerlink" href="#viewing-partitions" title="Permalink to this headline">¶</a></h4>
<p>To view all the partitions found on the SATA device the command “scsi
part &lt;dev&gt;” can be used.</p>
<p>Output of this command when ran on AM57x General Purpose EVM can be seen
below.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Partition Map for SCSI device 0  --   Partition Type: DOS

Part    Start Sector    Num Sectors     UUID            Type
  1     2048            161793          6cc50771-01     0c Boot
  2     165888          33552385        6cc50771-02     83
  3     33720320        91325104        6cc50771-03     83
</pre></div>
</div>
<p>All entries above represent different partitions that exist on the
particular scsi device. To reference a particular partition a user will
reference it the part number shown above. In commands shown below &lt;part&gt;
should be replaced with the appropriate partition number seen from this
table.</p>
</div>
<div class="section" id="identifying-partition-filesystem-type">
<h4>3.1.1.11.3. Identifying Partition Filesystem Type<a class="headerlink" href="#identifying-partition-filesystem-type" title="Permalink to this headline">¶</a></h4>
<p>As shown above the “scsi part &lt;dev&gt;” command can be used to view all the
partitions available on the particular scsi device. However, the proper
commands to use depend on the filesystem type each partition have been
formatted to.</p>
<p>In the “scsi part &lt;dev&gt;” command the partition type can be found under
the type column. The values under the Type column are referred to as
partition id. Depending on the partition id will dedicate which commands
to use to read and write partition. Partition id of “0c” refers to a
FAT32 partition. Partition id of “83” refers to a native Linux file
system which ext2,ext3 and ext4 fall under. Go
<a class="reference external" href="https://en.wikipedia.org/wiki/Partition_type#List_of_partition_IDs">here</a>
to find a complete list of partition ids.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="viewing-reading-and-writing-to-partition">
<h4>3.1.1.11.4. Viewing, Reading and Writing to Partition<a class="headerlink" href="#viewing-reading-and-writing-to-partition" title="Permalink to this headline">¶</a></h4>
<p>Depending on the filesystem type of the partition will depend on the
exact commands to use to read and write to the partition. The two most
common partitions are FAT32, EXT2 and EXT4. Luckily the commands to
view, read and write to the partition all look the same. Viewing
partition uses &lt;prefix&gt;ls, reading files is &lt;prefix&gt;load and writing
files is &lt;prefix&gt;write. Replace &lt;prefix&gt; with fat, ext2 and ext4
depending on the filesystem type.</p>
</div>
<div class="section" id="view-partition-contents">
<h4>3.1.1.11.5. View Partition Contents<a class="headerlink" href="#view-partition-contents" title="Permalink to this headline">¶</a></h4>
<p>To view the contents of a FAT32 partition the user would use “fatls scsi
&lt;dev&gt;:&lt;partition&gt;”</p>
<p>Below command list the contents of SCSI device 0 partition 1 on AM57x
General Purpose EVM:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; fatls scsi 0:1
   110578   test
1 file(s), 0 dir(s)
</pre></div>
</div>
<p class="rubric" id="write-file-to-partition">Write File to Partition</p>
<p>To write a file on a EXT4 partition the user must have first read the
file to be written into memory and then also know the size of the file.
Luckily U-boot automatically sets the environment variable “filesize” to
the filesize of a file that was loaded into memory via U-boot load
command.</p>
<p>To write to a ext4 partition the user would execute the below command:
ext4write scsi &lt;dev&gt;:&lt;partition&gt; &lt;ddr address&gt; &lt;absolute filename path&gt;
&lt;filesize&gt;</p>
<p>In the above command &lt;ddr address&gt; refers to the address in memory the
file has already been loaded into. Absolute filename path must start
with / to indicate the root. Filesize is the amount in bytes to be
written.</p>
<p>Below is an example of writing the file “tester” previously loaded into
memory onto a EXT4 partition</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; ext4write scsi 0:3 ${loadaddr} /tester ${filesize}
File System is consistent
update journal finished
110578 bytes written in 2650 ms (40 KiB/s)
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="ufs">
<h3>3.1.1.12. UFS<a class="headerlink" href="#ufs" title="Permalink to this headline">¶</a></h3>
<p>Universal Flash Subsystem (UFS) devices show up as scsi devices similar
to SATA in the <a class="reference external" href="Foundational_Components_U-Boot.html#sata">previous section</a>.
One additional command to initialize all ufs devices is:</p>
<dl class="docutils">
<dt>::</dt>
<dd>=&gt; ufs init
Device at <a class="reference external" href="mailto:ufs&#37;&#52;&#48;4e84000">ufs<span>&#64;</span>4e84000</a> up at:[RX, TX]: gear=[3, 3], lane[2, 2], pwr[FAST MODE, FAST MODE], rate = 2</dd>
</dl>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Then we can go ahead with ‘scsi scan’ to see the attached devices:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>  =&gt; scsi scan
  scanning bus for devices...
Device 0: (0:0) Vendor: TOSHIBA Prod.: THGAF8G8T23BAILB Rev: 0300
          Type: Hard Disk
          Capacity: 31.9 MB = 0.0 GB (8191 x 4096)
Device 0: (0:1) Vendor: TOSHIBA Prod.: THGAF8G8T23BAILB Rev: 0300
          Type: Hard Disk
          Capacity: 30499.9 MB = 29.7 GB (7807999 x 4096)
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>All the remaining scsi commands detailed in the
<a class="reference external" href="Foundational_Components_U-Boot.html#sata">previous section</a> are
also applicable.</p>
<p>For more information about UFS see
<a class="reference external" href="Foundational_Components_Kernel_Drivers.html#ufs">Kernel UFS Guide</a>.</p>
</div>
<div class="section" id="ddr3-ecc">
<h3>3.1.1.13. DDR3 ECC<a class="headerlink" href="#ddr3-ecc" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">DDR3 ECC feature described below is enabled for Keystone-II devices.</p>
</div>
<div class="section" id="ddr3-ecc-in-keystone-ii">
<h4>3.1.1.13.1. DDR3 ECC in Keystone-II<a class="headerlink" href="#ddr3-ecc-in-keystone-ii" title="Permalink to this headline">¶</a></h4>
<p>Some of the TI SoC devices have DDR ECC enabled. Keystone-II devices (K2H/K2E/K2G) enable the
DDR3 error detection and correction feature. The DDR3 controller supports ECC on the data
written or read from the SDRAM and is enabled by programming the ECC Control register.
8-bit ECC is calculated over 64-bit data quanta for K2H and K2E, but 4-bit ECC over 32-bit data for K2G.
The ECC is calculated for all accesses that are within the address ranges protected by ECC.
1-bit error is correctable by ECC and 2-bit error is not correctable and will be treated as
unrecoverable error by software and trigger the reset of the device.</p>
<div class="section" id="ddr3-ecc-handling">
<h5>3.1.1.13.1.1. DDR3 ECC Handling<a class="headerlink" href="#ddr3-ecc-handling" title="Permalink to this headline">¶</a></h5>
<p>Keystone-II U-boot checks if the DDR3 controller supports ECC RMW or not.
If ECC RMW is not supported (in K2H PG1.x devices), U-boot will disable the ECC by default,
otherwise it always enables ECC (in K2H PG2.0, K2E, and K2G devices)</p>
<p>During the ECC initialization, U-boot fills the entire memory (up to 8GB) to zeros
using an EDMA channel after ECC is enabled. For K2H device, U-boot configures
the chip level interrupt controller to route the DDR3 ECC error interrupt to
ARM interrupt controller. For K2E and K2G devices, since DDR3 ECC error interrupt is directly
routed to ARM interrupt controller, there is no need to configure the chip level interrupt controller.</p>
<p>A DDR3 command is added to simulate the ECC error by generating bit errors in DDR data at certain address. The command format is:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>ddr ecc_err &lt;addr in hex&gt; &lt;bit_err in hex&gt;
</pre></div>
</div>
<p>The command will read a 32-bit data from &lt;addr&gt;, and write (data ^ bit_err) back to &lt;addr&gt;</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>E.g.:
ddr ecc_err 0x90000000 0x1 (this will genereate a 1-bit error on bit 0 of the data in ddr address 0x9000_0000)
ddr ecc_err 0xa0000000 0x1001 (this will genereate 2-bit error on bit 0 &amp; 3 of the data in ddr address 0xa000_0000)
</pre></div>
</div>
<p>A new environment variable “ecc_test” is also introduced to test ECC. By default, ecc_test = 0, and any detection of 2-bit error will reset the device. If ecc_test = 1, U-boot will bypass the error and continues to boot Linux kernel so that Linux kernel can handle the error in interrupt service.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>DDR3 ECC Handling in Keystone-II Linux kernel</strong></p>
<p class="last">Linux kernel requests an IRQ handler for DDR3 ECC error interrupt, the handler checks the DDR3 controller interrupt
status register, if the error is 2-bit error, Linux kernel will reboot the device. User can also use a user mode
command to read the DDR3 ECC registers (e.g. 1-bit error count register, etc.), the DDR3 controller register and
interrupt mapping are defined in the sysctrl node of device tree binding:</p>
</div>
<div class="highlight-text"><div class="highlight"><pre><span></span>E.g. K2H SOC device tree:
sysctrl {
      reg = &lt;0x21010000 0x0200&gt;; /* DDR3 controller reg */
      interrupts = &lt;0 24 0xf01    /* L1L2 ECC error interrupt */
                    0 448 0xf01&gt;; /* DDR3 ECC error interrupt */
};
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
</div>
<div class="section" id="hyperbus-and-hyperflash">
<h3>3.1.1.14. HyperBus and HyperFlash<a class="headerlink" href="#hyperbus-and-hyperflash" title="Permalink to this headline">¶</a></h3>
<p>HyperBus is Low Signal Count, High Performance Double Data Rate (DDR) Bus interface between a host system master and one or more slave interfaces. Its a 8-bit data bus (DQ[7:0]) with  Read-Write Data Strobe (RWDS) signal and either Single-ended clock(3.0V parts) or Differential clock (1.8V parts). It uses ChipSelect lines to select b/w multiple slaves. At bus level, it follows a separate protocol described in HyperBus specification.</p>
<p>HyperFlash is a NOR flash based device storage over HyperBus.  HyperFlash follows CFI AMD/Fujitsu Extended Command Set (0x0002) similar to that of existing parallel NORs. Since Hyperbus is x8 DDR bus, its equivalent to x16 parallel NOR flash wrt bits per clk. But Hyperbus operates at very high frequencies.</p>
<p>HyperFlash on TI’s J721E EVM is connected to HyperBus Memory Controller that supports memory mapped IO access to flash. HyperFlash is supported under MTD framework and U-Boot’s standard MTD commands can be used to access HyperFlash</p>
<p><strong>Supported Devices</strong>
- J721E EVM</p>
<p>To list detected HyperFlash devices:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; mtd list
List of MTD devices:
* nor0
 - type: NOR flash
 - block size: 0x40000 bytes /* Each erase sector size is of 256KB */
 - min I/O: 0x1 bytes
 - 0x000000000000-0x000004000000 : &quot;nor0&quot; /* Detected 64MB devices labeled as &quot;nor0&quot; */
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On J721E EVM, SW3.1 should be set to ON position to select HyperFlash.</p>
</div>
<p>Below Example shows how to erase and write different boot images to HyperFlash from U-Boot prompt.
Erase has to be a multiple of erase sector size.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; mtd erase nor0 0 0x40000 /* Erase from offset 0 to 256KB of HyperFlash labeled nor0 */
Erasing 0x00000000 ... 0x0003ffff (1 eraseblock(s))
=&gt; fatload mmc 1 0x82000000 tiboot3.bin /* Load an img from SD into DDR to flash into HyperFlash */
180932 bytes read in 10 ms (17.3 MiB/s)
=&gt; mtd write nor0  0x82000000 0x0 $filesize /* Write the loaded image into HyperFlash labeled nor0 */
Writing 180932 byte(s) at offset 0x00000000
=&gt;
</pre></div>
</div>
<p>Below Example shows how to read back the data</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; mtd read nor0 0x82000000 0x0 0x40000 /* Read from offset 0 to 0x4000 to DDR address 0x82000000 from nor0 */
Reading 262144 byte(s) at offset 0x00000000
</pre></div>
</div>
<p><strong>Flashing Images to HyperFlash</strong></p>
<p>Below commands can be used to download tiboot3.bin, tispl.bin and
u-boot.img over tftp and then flash it to HyperFlash at respective addresses.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">=&gt; mtd erase nor0 0 0x800000</span>
<span class="go">=&gt; tftp ${loadaddr} tiboot3.bin</span>
<span class="go">=&gt; mtd write nor0 $loadaddr 0x0 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} tispl.bin</span>
<span class="go">=&gt; mtd write nor0 $loadaddr 0x80000 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} u-boot.img</span>
<span class="go">=&gt; mtd write nor0 $loadaddr 0x280000 $filesize</span>
<span class="go">=&gt; tftp ${loadaddr} sysfw.itb</span>
<span class="go">=&gt; mtd write nor0 $loadaddr 0x6C0000 $filesize</span>
</pre></div>
</div>
<dl class="docutils">
<dt><strong>Flash Layout for HyperFlash</strong></dt>
<dd>Below is the layout for HyperFlash in order to boot from HyperFlash:</dd>
</dl>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">     0x0 +----------------------------+</span>
<span class="go">         |     hbmc.tiboot3(512K)     |</span>
<span class="go">         |                            |</span>
<span class="go"> 0x80000 +----------------------------+</span>
<span class="go">         |     hbmc.tispl(2M)         |</span>
<span class="go">         |                            |</span>
<span class="go">0x280000 +----------------------------+</span>
<span class="go">         |     hbmc.u-boot(4M)        |</span>
<span class="go">         |                            |</span>
<span class="go">0x680000 +----------------------------+</span>
<span class="go">         |     hbmc.env(128K)         |</span>
<span class="go">         |                            |</span>
<span class="go">0x6C0000 +----------------------------+</span>
<span class="go">         |      hbmc.sysfw(1M)        |</span>
<span class="go">         |                            |</span>
<span class="go">0x7C0000 +----------------------------+</span>
<span class="go">         |      padding (256k)        |</span>
<span class="go">0x800000 +----------------------------+</span>
<span class="go">         |     hbmc.rootfs(UBIFS)     |</span>
<span class="go">         |                            |</span>
<span class="go">         +----------------------------+</span>
</pre></div>
</div>
<p><strong>Bootmode Switch Settings for J721E EVM</strong></p>
<p>After writing the images, change the bootmode switches on the EVM to the
following in order to boot from HyperFlash at 83MHz:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
<col width="8%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Switch No.</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>4</td>
<td>5</td>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
</tr>
<tr class="row-even"><td>SW8</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
</tr>
<tr class="row-odd"><td>SW9</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
<td>OFF</td>
</tr>
<tr class="row-even"><td>SW3</td>
<td>ON</td>
<td>ON</td>
<td>ON</td>
<td>ON</td>
<td>OFF</td>
<td>OFF</td>
<td>ON</td>
<td>OFF</td>
<td>ON</td>
<td>OFF</td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="remoteproc">
<h3>3.1.1.15. REMOTEPROC<a class="headerlink" href="#remoteproc" title="Permalink to this headline">¶</a></h3>
<p>This section documents how to initialize, load, start and stop remote cores from U-Boot prompt.
Following remotecores support is available in U-boot:</p>
<ul class="simple">
<li>Cortex-R5F in Lockstep more</li>
<li>Cortex-R5F in split mode</li>
<li>C66x DSP</li>
<li>C71x DSP</li>
</ul>
<div class="section" id="initialization">
<h4>3.1. Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h4>
<p>U-Boot supports for initializing all the available remotecores in one go or
initialize individual core based on the DT alias id.</p>
<p>The below command will initialize all the available remote cores:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; rproc init
</pre></div>
</div>
<p>The below command will initialize just the given remote core</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; rproc init &lt;id&gt;
</pre></div>
</div>
<p>The below command lists all the available/initialized remotecores in the system.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; rproc list
0 - Name:&#39;r5f@41000000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
1 - Name:&#39;r5f@41400000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
2 - Name:&#39;r5f@5c00000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
3 - Name:&#39;r5f@5d00000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
4 - Name:&#39;r5f@5e00000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
5 - Name:&#39;r5f@5f00000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
6 - Name:&#39;dsp@4d80800000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
7 - Name:&#39;dsp@4d81800000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
8 - Name:&#39;dsp@64800000&#39; type:&#39;internal memory mapped&#39; supports: load start stop reset
</pre></div>
</div>
</div>
<div class="section" id="loading">
<h4>3.1. Loading<a class="headerlink" href="#loading" title="Permalink to this headline">¶</a></h4>
<p>Once Initialized, remotecores can be loaded with a relevant image. Make sure
image is loaded only after initializing the core.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; load mmc 1:2 0x90000000 /lib/firmware/j7-main-r5f0_0-fw
2536540 bytes read in 112 ms (21.6 MiB/s)
=&gt; rproc load 2 0x90000000 0x${filesize}
Load Remote Processor 2 with data@addr=0x90000000 2536540 bytes: Success!
</pre></div>
</div>
</div>
<div class="section" id="starting">
<h4>3.1. Starting<a class="headerlink" href="#starting" title="Permalink to this headline">¶</a></h4>
<p>Successfully loaded remotecore can be started using the following command.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; rproc start 2
</pre></div>
</div>
</div>
<div class="section" id="stop">
<h4>3.1. Stop<a class="headerlink" href="#stop" title="Permalink to this headline">¶</a></h4>
<p>A running remotecore can be stopped using the following command.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>=&gt; rproc stop 2
</pre></div>
</div>
<p>Make sure all the commands are run in the above given sequence. Currently IPC
is not supported in U-boot.</p>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="uboot-spl-debugging-tips">
<h3>3.1.1.16. Uboot SPL Debugging Tips<a class="headerlink" href="#uboot-spl-debugging-tips" title="Permalink to this headline">¶</a></h3>
<p>The following section demonstrates how to connect a board to CCS and load the SPL symbols for debugging. For the experiment below, users are expected to boot their board from a SD card.</p>
<div class="section" id="step-1-downloading-ccs">
<h4>3.1.1.16.1. Step 1: Downloading CCS<a class="headerlink" href="#step-1-downloading-ccs" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Please download the CCS from the following link: <a class="reference external" href="http://software-dl.ti.com/ccs/esd/documents/ccs_downloads.html">http://software-dl.ti.com/ccs/esd/documents/ccs_downloads.html</a></li>
</ol>
<p><strong>NOTE</strong>: We will be building Uboot on a Linux machine and it is recommended to install CCS on the same operating system (OS). If CCS is not installed on the same OS, CCS will not be able to locate the code files. Please follow the Linux instructions on the following link: <a class="reference external" href="http://software-dl.ti.com/ccs/esd/documents/ccs_linux_host_support.html">http://software-dl.ti.com/ccs/esd/documents/ccs_linux_host_support.html</a></p>
</div>
<div class="section" id="step-2-creating-a-target-configuration-file">
<h4>3.1.1.16.2. Step 2: Creating a Target Configuration File<a class="headerlink" href="#step-2-creating-a-target-configuration-file" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">The first step is to create a target configuration file in CCS. Navigate to “View”-&gt; “Target Configurations”:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image1.png" src="../_images/Uboot_Image1.png" />
</div></blockquote>
</li>
<li><p class="first">Right click on the “Target Configurations” window and select “New Target Configuration”:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image2.png" src="../_images/Uboot_Image2.png" />
</div></blockquote>
</li>
<li><p class="first">Create a name for target configuration:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image3.png" src="../_images/Uboot_Image3.png" />
</div></blockquote>
</li>
<li><p class="first">Select the appropriate SoC and JTAG. <strong>Note</strong>: If we select the SoC name, the GEL files will not be loaded. However, if we select the board options, the GEL files will be loaded by default. In the below example, if GPEVM_AM65x or IDK_AM65x is selected, the GEL files are automatically enabled in the configuration. While debugging Uboot, it is recommended to avoid GEL files because Uboot is responsible for initializing the peripherals:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image4.png" src="../_images/Uboot_Image4.png" />
</div></blockquote>
</li>
<li><p class="first">Next, click save and test connection to ensure CCS is able to communicate with the debugger:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image5.png" src="../_images/Uboot_Image5.png" />
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="step-3-loading-symbol-files">
<h4>3.1.1.16.3. Step 3: Loading Symbol files<a class="headerlink" href="#step-3-loading-symbol-files" title="Permalink to this headline">¶</a></h4>
<p>Before the symbols are loaded, a test code will be added to the SPL code. The test code will loop within itself and the only way to break the loop is to change the Program Counter via the CCS. For the current experiment, the AM65EVM is used but the same experiment could be performed on other boards. The following test code is added to the “board_init_f” function in the file &lt;ti_sdk_dir&gt;/board-support/&lt;u-boot_version&gt;/arch/arm/mach-k3/am6_init.c:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">store_boot_index_from_rom</span><span class="p">();</span>

<span class="cm">/* Make all control module registers accessible */</span>
<span class="n">ctrl_mmr_unlock</span><span class="p">();</span>

<span class="k">asm</span><span class="p">(</span><span class="s">&quot;test: nop&quot;</span><span class="p">);</span>
<span class="k">asm</span><span class="p">(</span><span class="s">&quot;       nop&quot;</span><span class="p">);</span>
<span class="k">asm</span><span class="p">(</span><span class="s">&quot;  b test &quot;</span><span class="p">);</span>
<span class="k">asm</span><span class="p">(</span><span class="s">&quot; nop&quot;</span><span class="p">);</span>
<span class="k">asm</span><span class="p">(</span><span class="s">&quot; nop&quot;</span><span class="p">);</span>

<span class="n">setup_am654_navss_northbridge</span><span class="p">();</span>
</pre></div>
</div>
<p>If a user is working with AM335x/AM437x/AM57xx, the test code could be added in the “early_system_init” function in the file &lt;ti_sdk_dir&gt;/board-support/&lt;u-boot_version&gt;/arch/arm/mach-omap2/hwinit-common.c. The location of the test code on all platforms will vary based on the section of the SPL we are trying to debug.</p>
<ol class="arabic">
<li><p class="first">There are two methods of compiling Uboot: <a class="reference external" href="Top_Level_Makefile.html">method1</a> and <a class="reference external" href="Foundational_Components_U-Boot.html#build-and-boot-flow-on-32-bit-platforms">method2</a>. Both methods will generate the necessary symbol file required for SPL debugging.</p>
</li>
<li><p class="first">On AM335x/AM437x/AM57xx, the symbol file is located in the following directory “&lt;ti_sdk_dir&gt;/board-support/&lt;u-boot_version&gt;/spl/u-boot-spl”. For AM654x, the symbol file is located in the following directory “&lt;ti_sdk_dir&gt;/board-support/u-boot_build/r5/spl/u-boot-spl”.</p>
</li>
<li><p class="first">After building Uboot, copy the relevant images on the SD card. For AM335x/AM437x/AM57xx, copy MLO and u-boot.img to the SD card. For AM65x, copy sysfw.itb, tiboot3.bin, tispl.bin and u-boot.img to the SD card.</p>
</li>
<li><p class="first">Install the SD card and power on the board.</p>
</li>
<li><p class="first">On CCS, launch the target configuration file created in Step2:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image6.png" src="../_images/Uboot_Image6.png" />
</div></blockquote>
</li>
<li><p class="first">After successful launch, connect to one of the ARM cores. On AM65x, the inital SPL code is executed on the R5 so the user would connect to the R5 core. For the AM335x/AM437/AM57xx, please connect to the A8/A9/A15 core.</p>
<blockquote>
<div><img alt="../_images/Uboot_Image7.png" src="../_images/Uboot_Image7.png" />
</div></blockquote>
</li>
<li><p class="first">After connecting to the core, click on “Run”-&gt; “Load”-&gt;”Load Symbols…”:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image8.png" src="../_images/Uboot_Image8.png" />
<img alt="../_images/Uboot_Image9.png" src="../_images/Uboot_Image9.png" />
<img alt="../_images/Uboot_Image10.png" src="../_images/Uboot_Image10.png" />
</div></blockquote>
</li>
<li><p class="first">After loading the code, CCS should find the source code file and it should be stuck at the code previously added:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image11.png" src="../_images/Uboot_Image11.png" />
</div></blockquote>
</li>
<li><p class="first">To break out of the loop, change the program counter in the Register Window:</p>
<blockquote>
<div><img alt="../_images/Uboot_Image12.png" src="../_images/Uboot_Image12.png" />
</div></blockquote>
</li>
</ol>
<p>At this point, the user has the ability to step through the SPL code and debug issues in the SPL.</p>
<p><strong>NOTE</strong>: On K3 family of devices such as AM654x, a watchdog timer part of the DMSC is enabled by default by the ROM bootcode with a timeout of 3 minutes. The watchdog timer is serviced by System Firmware (SYSFW) during normal operation. If one is debugging SPL before the SYSFW is loaded, the watchdog timer will not get serviced automatically and the debug session will reset after 3 minutes. Therefore, it is recommended to start debugging SPL code only after the startup of SYSFW to avoid running into the watchdog timer reset. Similarly, the watchdog timer is also enabled on the AM335x/AM437x/AM57xx devices and please refer to the “Disable_Watchdog()” function in our gel files.</p>
</div>
</div>
<div class="section" id="loading-uboot-through-code-composer-studio-ccs">
<h3>3.1.1.17. Loading Uboot through Code Composer Studio (CCS)<a class="headerlink" href="#loading-uboot-through-code-composer-studio-ccs" title="Permalink to this headline">¶</a></h3>
<p>The below lab is going to walk you through the process of using CCS to load SPL/U-Boot images on the <a class="reference external" href="http://www.ti.com/tool/TMDSEVM437X">AM437x EVM</a>. The same process applies to other boards as well.</p>
<div class="section" id="step-1-software-downloads">
<h4>3.1.1.17.1. Step 1: Software Downloads<a class="headerlink" href="#step-1-software-downloads" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>A Linux host system configured in accordance with the <a class="reference external" href="http://software-dl.ti.com/processor-sdk-linux/esd/docs/latest/linux/Overview_Getting_Started_Guide.html">Processor SDK Linux Getting Started Guide</a>, with the latest Processor Software Development Kit (PSDK) and Code Composer Studios (CCS) installed. Please refer to the release notes. This document was written using Ubuntu 18.04, Processor SDK Linux 06.03, and CCS 10.0.</li>
</ul>
</div>
<div class="section" id="step-2-testing-hardware-connection">
<h4>3.1.1.17.2. Step 2: Testing Hardware Connection<a class="headerlink" href="#step-2-testing-hardware-connection" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Remove the SD card from board and setup USB cable connection between the board and your Linux Host</li>
<li>Power on the board</li>
<li>Open a terminal and run the following command to find the USB serial adapters available on the system : “dmesg | grep tty”</li>
</ul>
<div class="highlight-text"><div class="highlight"><pre><span></span>[    0.000000] console [tty0] enabled
[    0.554632] 00:06: ttyS0 at I/O 0x3f8 (irq = 4, base_baud = 115200) is a 16550A
[   29.566576] usb 2-1.6.1.1: pl2303 converter now attached to ttyUSB0
</pre></div>
</div>
<p><strong>NOTE:</strong> The ttyUSB&lt;x&gt; will be different based on the host machine connections.</p>
<ul>
<li><p class="first">Launch a serial terminal (the terminal displayed below is created with $minicom -w -s) and configure it as below:</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS1.png" src="../_images/Uboot_CCS1.png" />
</div></blockquote>
</li>
<li><p class="first">You should now see a minicom window with “ccccc” being printed. Go ahead and leave this console RUNNING in the background.</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS2.jpg" src="../_images/Uboot_CCS2.jpg" />
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="step-3-building-the-spl-uboot-images">
<h4>3.1.1.17.3. Step 3: Building the SPL/Uboot images<a class="headerlink" href="#step-3-building-the-spl-uboot-images" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Open another console terminal and navigate to the latest PSDK that was installed</li>
<li>Change directories to the Uboot source code and open the defconfig file associated with your board: <strong>“&lt;psdk_dir&gt;/board-support/u-boot-xxx+yyyy/configs/am43xx_evm_defconfig”</strong></li>
<li>Before we compile the Uboot, please add the following flag “CONFIG_OF_EMBED=y” in the am43xx_evm_defconfig file. If you refer to the &lt;u-boot_dir&gt;/README file, it mentions “If this variable is defined, U-Boot will embed a device tree binary in its image.” Please keep in mind that this is suitable for debugging and development only and is not recommended for production.</li>
<li>There are two methods of compiling Uboot: <a class="reference external" href="Overview/Top_Level_Makefile.html#top-level-makefile">method1</a> and <a class="reference external" href="Foundational_Components_U-Boot.html#build-and-boot-flow-on-32-bit-platforms">method2</a>. Both methods will generate the necessary files required for Uboot debugging</li>
<li>Upon successful compilation, there are a total of 3 images that we are interested:</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="11%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Location</th>
<th class="head">Image Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&lt;psdk_dir&gt;/board-support/u-boot-u-boot-xxx+yyyy/spl</td>
<td>u-boot-spl</td>
<td>Full SPL image containing all debug symbols</td>
</tr>
<tr class="row-odd"><td>&lt;psdk_dir&gt;/board-support/u-boot-u-boot-xxx+yyyy/spl</td>
<td>u-boot-spl.bin</td>
<td>Stripped binary SPL image that can fit into the internal memory</td>
</tr>
<tr class="row-even"><td>&lt;psdk_dir&gt;/board-support/u-boot-u-boot-xxx+yyyy</td>
<td>u-boot</td>
<td>ELF image that contains debug symbols and the device tree files</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="step-4-ccs-configuration">
<h4>3.1.1.17.4. Step 4: CCS Configuration<a class="headerlink" href="#step-4-ccs-configuration" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Launch CCS and select <strong>File -&gt; New -&gt; Target Configuration File</strong></p>
</li>
<li><p class="first">In the <strong>New Target Configuration</strong> dialog box give the configuration a name. For this lab, we will use the name AM437x</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS3.png" src="../_images/Uboot_CCS3.png" />
</div></blockquote>
</li>
<li><p class="first">Click <strong>Use shared location</strong>, then Click <strong>Finish</strong></p>
</li>
<li><p class="first">The <em>AM437x</em> configuration you created will now be opened for editing. Perform the following steps to finish the target configuration:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">In the <strong>Connection</strong> drop-down box select <strong>Texas Instruments XDS100v2 USB Emulator</strong>. If you are using a different emulator please select that one instead</p>
</li>
<li><p class="first">In the <strong>Board or Device</strong> selection list check the <strong>AM4378</strong> device. Please do not select any “IDK” or “EVM” option because it will load the GEL files and we do not want that</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS4.png" src="../_images/Uboot_CCS4.png" />
</div></blockquote>
</li>
<li><p class="first">Click the <strong>Save</strong> button at the right of the screen</p>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">You can now test your target connection by pressing the <strong>Test Connection</strong> button at the right of the screen.</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS5.png" src="../_images/Uboot_CCS5.png" />
</div></blockquote>
</li>
<li><p class="first">Close the <em>Test Connection</em> dialog box</p>
</li>
</ul>
</div>
<div class="section" id="step-5-change-arm-mode">
<h4>3.1.1.17.5. Step 5: Change ARM mode<a class="headerlink" href="#step-5-change-arm-mode" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Launch the target configuration we created in the previous step</p>
<blockquote>
<div><ol class="arabic simple">
<li>Click <strong>View -&gt; Target Configurations</strong>. This should open a tab on the right side of your screen called <strong>Target Configurations</strong></li>
<li>Expand the <strong>User Defined</strong> list</li>
<li>Right-Click the <strong>AM437x</strong> configuration and select <strong>Launch Selected Configuration</strong></li>
</ol>
</div></blockquote>
</li>
<li><p class="first">The view should have changed to a <strong>Debug</strong> tab (may take a few minutes to launch)</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS6.png" src="../_images/Uboot_CCS6.png" />
</div></blockquote>
</li>
<li><p class="first">Right-Click the <strong>CortxA9</strong> line item and select <strong>Connect Target</strong></p>
</li>
<li><p class="first">To set the processor in ARM Mode (not THUMB mode) with CCS use the following steps:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Select the <strong>Registers</strong> tab</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS7.png" src="../_images/Uboot_CCS7.png" />
</div></blockquote>
</li>
<li><p class="first">Expand the <strong>Core Registers</strong> and inside of <strong>Core Registers</strong> expand the <strong>CPSR</strong> list</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS8.png" src="../_images/Uboot_CCS8.png" />
</div></blockquote>
</li>
<li><p class="first">Scroll down in the CPSR register list and change the <strong>T</strong> register from <strong>1</strong> to <strong>0</strong>.</p>
</li>
<li><p class="first">You should see the CPSR value change to reflect the new value</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS9.png" src="../_images/Uboot_CCS9.png" />
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">The above steps need to be performed every time the board is powered completely off or reset</p>
</li>
</ul>
</div>
<div class="section" id="step-6-loading-spl">
<h4>3.1.1.17.6. Step 6: Loading SPL<a class="headerlink" href="#step-6-loading-spl" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">To load the SPL binary into the internal chip memory, please use the following steps:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Click <strong>Tools -&gt; Load Memory</strong>. The <em>Load Memory</em> tool is used here because we are loading the SPL binary and not and ELF image. The reason for this is that the binary is sized to be able to fit into the internal RAM of the SoC</p>
</li>
<li><p class="first">Click the <strong>Browse</strong> button and navigate to the u-boot-spl.bin file (Refer to Step3 for binary location)</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS10.png" src="../_images/Uboot_CCS10.png" />
</div></blockquote>
</li>
<li><p class="first">Select the <strong>u-boot-spl.bin</strong> file and click <strong>OK</strong>. For the file type, leave it as “TI Raw Data”</p>
</li>
<li><p class="first"><strong>Start Address: 0x402F4000</strong>. This is the start address of the SPL binary as defined in the u-boot sources. To confirm the start address, please navigate to the file “&lt;psdk_dir&gt;/board-support/u-boot-u-boot-xxx+yyyy/spl/u-boot-spl.map” and search for “__start”</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS11.png" src="../_images/Uboot_CCS11.png" />
</div></blockquote>
</li>
<li><p class="first">Click <strong>Finish</strong> and you should see a box pop up showing the memory load operation</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS12.png" src="../_images/Uboot_CCS12.png" />
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">To load the symbols for the binary to allow source level debugging</p>
<blockquote>
<div><ol class="arabic simple">
<li>Click <strong>Run -&gt; Load -&gt; Load Symbols…</strong></li>
<li>In the dialog box, click the <strong>Browse</strong> button</li>
<li>Like before browse to the <strong>spl</strong> directory and change the filter to <strong>All</strong></li>
<li>Select the <strong>u-boot-spl</strong> file which is the ELF executable that also contains the symbols and click <strong>OK</strong></li>
<li>Ensure the Code Offset and Data Offset are blank</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">Now that the binary and symbols are loaded, we need to set the program counter to the beginning of the SPL code. Click on the <strong>Registers</strong> Tab and in the <strong>Core Registers</strong> list, change the PC value to the start address you entered before (<strong>0x402F4000</strong>)</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS13.png" src="../_images/Uboot_CCS13.png" />
</div></blockquote>
</li>
<li><p class="first">Open the Disassembly view by clicking <strong>View -&gt; Disassembly</strong>, ensure that the PC equals <em>0x402F4000</em></p>
<blockquote>
<div><img alt="../_images/Uboot_CCS14.png" src="../_images/Uboot_CCS14.png" />
</div></blockquote>
</li>
<li><p class="first">At this point, feel free to step through the SPL code</p>
</li>
<li><p class="first">Go ahead and click the green run button to let SPL finish running to completion</p>
</li>
<li><p class="first">After a second or two, press the yellow <strong>pause</strong> symbol to suspend execution</p>
</li>
<li><p class="first">You should either see output on the console window of <strong>### ERROR ### Please RESET the board ###</strong></p>
<blockquote>
<div><img alt="../_images/Uboot_CCS15.png" src="../_images/Uboot_CCS15.png" />
</div></blockquote>
</li>
<li><p class="first">This means that SPL has ran and tried to read the U-Boot image from the SD card, the default boot setting for the EVM. The processor now has the SPL context which means means the board is ready for U-Boot.</p>
</li>
</ul>
<p><strong>IMPORTANT</strong>: DO NOT RESET YOUR BOARD. If you reset your board at this point you will need to re-run these steps and re-load SPL to go on to the debugging U-Boot</p>
</div>
<div class="section" id="step-7-loading-uboot-image">
<h4>3.1.1.17.7. Step 7: Loading Uboot Image<a class="headerlink" href="#step-7-loading-uboot-image" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Assuming that you have executed SPL, please use the following steps to the load the U-Boot ELF image:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Before loading the image, please make sure THUMB mode is not set in the CPSR Register</p>
</li>
<li><p class="first">Click <strong>Run -&gt; Load -&gt; Load Program…</strong></p>
</li>
<li><p class="first">Click the <strong>Browse</strong> button and this time select the <strong>u-boot</strong> image (Refer to Step3 for binary location)</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS16.png" src="../_images/Uboot_CCS16.png" />
</div></blockquote>
</li>
<li><p class="first">Click <strong>OK</strong> to load the program</p>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">Since an ELF image was loaded, the <strong>PC</strong> was automatically set. Also, make sure THUMB mode is set to 0</p>
<blockquote>
<div><img alt="../_images/Uboot_CCS17.png" src="../_images/Uboot_CCS17.png" />
</div></blockquote>
</li>
<li><p class="first">Determine the U-Boot relocation offset. U-boot initially loads into low memory and later, relocates itself into high memory to make room for the Linux Kernel.</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Now that U-Boot is loaded, go ahead and run the executable by clicking the <strong>green run arrow</strong>. In the minicom window, you should see U-Boot start running and press enter on the Uboot prompt</p>
</li>
<li><p class="first">In your minicom terminal, use the command <strong>bdinfo</strong> to find the <strong>relocaddr</strong>. You should see output like the following which shows the relocation address to be <strong>0xfff42000 - this value changes with different SDKs</strong></p>
<blockquote>
<div><img alt="../_images/Uboot_CCS18.png" src="../_images/Uboot_CCS18.png" />
</div></blockquote>
<p><strong>IMPORTANT</strong>: You want to get the <strong>relocaddr</strong> value, NOT the ‘reloc off <strong>value.</strong></p>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">Re-load U-Boot</p>
<blockquote>
<div><ol class="arabic simple">
<li>Before re-loading the image, please make sure THUMB mode is set to 0 in the CPSR Register</li>
<li>Click <strong>Run -&gt; Load -&gt; Reload Program</strong> and allow the load to finish</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">Now the U-Boot is loaded again, we need to reload the symbols based on the relocation offset we determined before.</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Click <strong>Run -&gt; Load -&gt; Load Symbols…</strong></p>
</li>
<li><p class="first">Make sure that the <strong>Program file</strong> entry is still set to your <strong>u-boot</strong> file. If not, browse to the proper file.</p>
</li>
<li><p class="first">In the <strong>Code offset</strong> field enter the offset value you found before. i.e. <strong>0xfff42000</strong></p>
</li>
<li><p class="first">In the <strong>Data offset</strong> field enter the offset value you found before. i.e. <strong>0xfff42000</strong></p>
<blockquote>
<div><img alt="../_images/Uboot_CCS19.png" src="../_images/Uboot_CCS19.png" />
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">You can now do single step and step over operations in the same way you did for SPL</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="u-boot-release-notes">
<h2>3.1.2. U-Boot Release Notes<a class="headerlink" href="#u-boot-release-notes" title="Permalink to this headline">¶</a></h2>
<div class="section" id="build-information">
<h3>3.1.2.1. Build Information<a class="headerlink" href="#build-information" title="Permalink to this headline">¶</a></h3>
<p>Please refer to Yocto build for details.</p>
</div>
<div class="section" id="known-issues">
<h3>3.1.2.2. Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this headline">¶</a></h3>
<p>Please refer to <a class="reference external" href="Release_Specific_PSDKLA_Release_Notes.html#issues-tracker">Known Issues</a> for details.</p>
</div>
</div>
<div class="section" id="u-boot-splash-screen">
<h2>3.1.3. U-Boot Splash Screen<a class="headerlink" href="#u-boot-splash-screen" title="Permalink to this headline">¶</a></h2>
<p class="rubric" id="adding-a-splash-screen">Adding a splash screen</p>
<p class="rubric" id="am335x">AM335x</p>
<p>All the code below is based on Processor Linux SDK 03.02.00..05.</p>
<p>There is a frame buffer driver for am335x in the drivers/video directory
called am3355x-fb.c. It makes calls to routines in board.c to set up the
LCDC and frame buffer. To use it:</p>
<p>Either create a new defconfig in the configs directory or just add
SPLASH to CONFIG_SYS_EXTRA_OPTIONS. In this example the
am335x_evm_defconfig is copied into a new one called
am335x_evm_splash_defconfig.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>CONFIG_TARGET_AM335X_EVM=y
CONFIG_SPL_STACK_R_ADDR=0x82000000
CONFIG_DEFAULT_DEVICE_TREE=&quot;am335x-evm&quot;
CONFIG_SPL=y
CONFIG_SPL_STACK_R=y
CONFIG_SYS_EXTRA_OPTIONS=&quot;NAND,SPLASH&quot;
CONFIG_HUSH_PARSER=y
CONFIG_AUTOBOOT_KEYED=y
</pre></div>
</div>
<p>In include/configs/am335x_evm.h, add support for the splash screen,
LCDC, and gzipped bitmaps.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/* Splash scrren support */</span>
<span class="cp">#ifdef CONFIG_SPLASH</span>
<span class="cp">#define CONFIG_AM335X_LCD</span>
<span class="cp">#define CONFIG_LCD</span>
<span class="cp">#define CONFIG_LCD_NOSTDOUT</span>
<span class="cp">#define CONFIG_SYS_WHITE_ON_BLACK</span>
<span class="cp">#define LCD_BPP LCD_COLOR16</span>

<span class="cp">#define CONFIG_VIDEO_BMP_GZIP</span>
<span class="cp">#define CONFIG_SYS_VIDEO_LOGO_MAX_SIZE  (1366*767*4)</span>
<span class="cp">#define CONFIG_CMD_UNZIP</span>
<span class="cp">#define CONFIG_CMD_BMP</span>
<span class="cp">#define CONFIG_BMP_16BPP</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>In arch/arm/cpu/armv7/am33xx/clock_am33xx.c enable the LCDC clocks.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">cmrtc</span><span class="o">-&gt;</span><span class="n">rtcclkctrl</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">cmper</span><span class="o">-&gt;</span><span class="n">usb0clkctrl</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">cmper</span><span class="o">-&gt;</span><span class="n">emiffwclkctrl</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">cmper</span><span class="o">-&gt;</span><span class="n">emifclkctrl</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">cmper</span><span class="o">-&gt;</span><span class="n">lcdclkctrl</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">cmper</span><span class="o">-&gt;</span><span class="n">lcdcclkstctrl</span><span class="p">,</span>
<span class="o">&amp;</span><span class="n">cmper</span><span class="o">-&gt;</span><span class="n">epwmss2clkctrl</span><span class="p">,</span>
<span class="mi">0</span>
</pre></div>
</div>
<p>In board.c add includes for mmc, fat, lcd, and the frame buffer.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;libfdt.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fdt_support.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mmc.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;lcd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;../../../drivers/video/am335x-fb.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>This example code is based on the AM335x Starter Kit. A GPIO controls
the backlight so use GPIO_TO_PIN to define the GPIO.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define GPIO_ETH1_MODE          GPIO_TO_PIN(1, 26)</span>

<span class="cm">/* GPIO that controls backlight on EVM-SK */</span>
<span class="cp">#define GPIO_BACKLIGHT_EN       GPIO_TO_PIN(3, 17)</span>
</pre></div>
</div>
<p>In board_late_init call the splash screen routine.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#if !defined(CONFIG_SPL_BUILD)</span>
        <span class="n">splash_screen</span><span class="p">();</span>
        <span class="cm">/* try reading mac address from efuse */</span>
        <span class="n">mac_lo</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">macid0l</span><span class="p">);</span>
        <span class="n">mac_hi</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">macid0h</span><span class="p">);</span>
</pre></div>
</div>
<p>The following routines enable the backlight, load the LCD timings (this
example is based on Starter Kit), power on the LCD and enable it, then
finally the splash screen code that registers a fat file system on mmc0.
The gzipped bitmap is named splash.bmp.gz and is displayed with
bmp_display.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>#if defined(CONFIG_LCD) &amp;&amp; defined(CONFIG_AM335X_LCD) &amp;&amp; \
                !defined(CONFIG_SPL_BUILD)
void lcdbacklight(int on)
{
        gpio_request(GPIO_BACKLIGHT_EN, &quot;backlight_en&quot;);
        if (on)
                gpio_direction_output(GPIO_BACKLIGHT_EN, 0);
        else
                gpio_direction_output(GPIO_BACKLIGHT_EN, 1);
}

int  load_lcdtiming(struct am335x_lcdpanel *panel)
{
        struct am335x_lcdpanel pnltmp;

        pnltmp.hactive = 480;
        pnltmp.vactive = 272;
        pnltmp.bpp = 16;
        pnltmp.hfp = 8;
        pnltmp.hbp = 43;
        pnltmp.hsw = 4;
        pnltmp.vfp = 4;
        pnltmp.vbp = 12;
        pnltmp.vsw = 10;
        pnltmp.pxl_clk_div = 2;
        pnltmp.pol = 0;
        pnltmp.pup_delay = 1;
        pnltmp.pon_delay = 1;
        panel_info.vl_rot = 0;

        memcpy((void *)panel, (void *)&amp;pnltmp, sizeof(struct am335x_lcdpanel));

        return 0;
}

void lcdpower(int on)
{
        lcd_enable();
}

vidinfo_t       panel_info = {
                .vl_col = 480,
                .vl_row = 272,
                .vl_bpix = 4,
                .priv = 0
};

void lcd_ctrl_init(void *lcdbase)
{
        struct am335x_lcdpanel lcd_panel;

        memset(&amp;lcd_panel, 0, sizeof(struct am335x_lcdpanel));
        if (load_lcdtiming(&amp;lcd_panel) != 0)
                return;

        lcd_panel.panel_power_ctrl = &amp;lcdpower;

        if (am335xfb_init(&amp;lcd_panel) != 0)
                printf(&quot;ERROR: failed to initialize video!&quot;);

        /* Modify panel into to real resolution */
        panel_info.vl_col = lcd_panel.hactive;
        panel_info.vl_row = lcd_panel.vactive;

//      lcd_set_flush_dcache(1);
}

void lcd_enable(void)
{
        lcdbacklight(1);
}

void splash_screen(void)
{
        struct mmc      *mmc = NULL;
        int             err;

        mmc = find_mmc_device(0);
        if (!mmc)
                printf(&quot;Error finding mmc device\n&quot;);

        mmc_init(mmc);

        err = fat_register_device(&amp;mmc-&gt;block_dev,
                                        CONFIG_SYS_MMCSD_FS_BOOT_PARTITION);

        if (!err) {
                err = file_fat_read(&quot;splash.bmp.gz&quot;, (void *)0x82000000, 0);
                bmp_display(0x82000000, 0, 0);
        }
}
#endif
</pre></div>
</div>
<p>In mux.c define the LCDC pin mux.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#ifdef CONFIG_AM335X_LCD</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">module_pin_mux</span> <span class="n">lcd_pin_mux</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data0</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(0) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data1</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(1) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data2</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(2) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data3</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(3) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data4</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(4) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data5</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(5) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data6</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(6) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data7</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(7) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data8</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(8) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data9</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(9) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data10</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>    <span class="cm">/* LCD-Data(10) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data11</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>    <span class="cm">/* LCD-Data(11) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data12</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>    <span class="cm">/* LCD-Data(12) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data13</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>    <span class="cm">/* LCD-Data(13) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data14</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>    <span class="cm">/* LCD-Data(14) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_data15</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>    <span class="cm">/* LCD-Data(15) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad8</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>      <span class="cm">/* LCD-Data(16) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad9</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>      <span class="cm">/* LCD-Data(17) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad10</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(18) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad11</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(19) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad12</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(20) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad13</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(21) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad14</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(22) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">gpmc_ad15</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-Data(23) */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_vsync</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-VSync */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_hsync</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>     <span class="cm">/* LCD-HSync */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_ac_bias_en</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span><span class="cm">/* LCD-DE */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">lcd_pclk</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span>      <span class="cm">/* LCD-CLK */</span>

        <span class="cm">/* backlight */</span>
        <span class="p">{</span><span class="n">OFFSET</span><span class="p">(</span><span class="n">mcasp0_ahclkr</span><span class="p">),</span> <span class="p">(</span><span class="n">MODE</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="n">PULLUDDIS</span><span class="p">)},</span> <span class="cm">/* mcasp0_gpio */</span>

        <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>And enable the LCD.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">board_is_evm_sk</span><span class="p">())</span> <span class="p">{</span>
                <span class="cm">/* Starter Kit EVM */</span>
                <span class="n">configure_module_pin_mux</span><span class="p">(</span><span class="n">i2c1_pin_mux</span><span class="p">);</span>
                <span class="n">configure_module_pin_mux</span><span class="p">(</span><span class="n">gpio0_7_pin_mux</span><span class="p">);</span>
                <span class="n">configure_module_pin_mux</span><span class="p">(</span><span class="n">rgmii1_pin_mux</span><span class="p">);</span>
                <span class="n">configure_module_pin_mux</span><span class="p">(</span><span class="n">mmc0_pin_mux_sk_evm</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_AM335X_LCD</span>
                <span class="n">configure_module_pin_mux</span><span class="p">(</span><span class="n">lcd_pin_mux</span><span class="p">);</span>
<span class="cp">#endif</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">board_is_bone_lt</span><span class="p">())</span> <span class="p">{</span>
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting">
<h2>3.1.4. Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>After U-boot upgrade, Kernel stops booting</li>
</ol>
<p>Check if one of the cases below applies:</p>
<ul>
<li><p class="first">Not resetting U-boot environment variables after upgrading/downgrading u-boot version</p>
<p>From release to release, some of the u-boot environment variables may be changed.
To guarantee the environment variables are correctly matching the version used,
it is required to reset the u-boot environment variables When upgrading/downgrading u-boot version.
When booting up a different version of u-boot, the u-boot boot process can be
interruptted by hitting any key to get the u-boot prompt. Then, the following command needs
to issue to reset the u-boot environment variables.</p>
<blockquote>
<div><div class="line-block">
<div class="line"># env default -f -a</div>
<div class="line"># saveenv</div>
</div>
</div></blockquote>
</li>
<li><p class="first">Mix-matching U-boot and Linux kernel version</p>
<p>There are times that users mix-match u-boot and kernel version from different SDK releases.
It probably is fine in most cases, but TI recommends the u-boot and kernel are from the same SDK release.
From release to release, the u-boot environemt variables may change, including load addresses,
kernel image format, etc. Any of the incompatibility of these changes between u-boot and kernel
will cause boot issues. Therefore, when u-boot is upgraded or downgreaded,
a reset of the u-boot environment variables is requried.
Please see how to reset u-boot environment variables in previous bullet.</p>
</li>
</ul>
<ol class="arabic simple" start="2">
<li>Not able to boot U-boot with different boot mode</li>
</ol>
<ul class="simple">
<li>Check if the instruction for supported u-boot boot modes is followed.</li>
</ul>
<div class="line-block">
<div class="line">Please follow instructions in <a class="reference external" href="Foundational_Components_U-Boot.html#u-boot-user-s-guide">U-boot User’s Guide</a></div>
<div class="line"><br /></div>
</div>
<div class="line-block">
<div class="line">Different boot modes ues diferent image formats. They are:</div>
</div>
<blockquote>
<div><ul class="simple">
<li>u-boot-spi.gph</li>
<li>rootfs-image.ubi</li>
<li>u-boot.bin</li>
<li>MLO</li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Foundational_Components_Kernel.html" class="btn btn-neutral float-right" title="3.2. Kernel" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Foundational_Components.html" class="btn btn-neutral" title="3. Foundational Components" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">&copy; Copyright 1995-2020</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'07_01_00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });
      });
  </script>
   

</body>
</html>